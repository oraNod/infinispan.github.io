<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Developing for Infinispan 11.0</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="canonical" href="http://infinispan.org/docs/stable/user_guide/user_guide.html">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/themes/default/style.min.css">
<link rel="stylesheet" href="../../css/css.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.1/jstree.min.js"></script>
<script src="../../js/js.js"></script>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Developing for Infinispan 11.0</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#mvn">1. Configuring the Infinispan Maven Repository</a>
<ul class="sectlevel2">
<li><a href="#configure_pom">1.1. Configuring Your Infinispan POM</a></li>
</ul>
</li>
<li><a href="#cache_manager">2. Cache Managers</a>
<ul class="sectlevel2">
<li><a href="#obtaining_caches">2.1. Obtaining caches</a></li>
<li><a href="#clustering_information">2.2. Clustering Information</a></li>
<li><a href="#member_information">2.3. Member Information</a></li>
</ul>
</li>
<li><a href="#cache_api">3. Infinispan Cache Interface</a>
<ul class="sectlevel2">
<li><a href="#cache_api_2">3.1. Cache API</a>
<ul class="sectlevel3">
<li><a href="#performance_concerns_of_certain_map_methods">3.1.1. Performance Concerns of Certain Map Methods</a></li>
<li><a href="#mortal_and_immortal_data">3.1.2. Mortal and Immortal Data</a></li>
<li><a href="#putforexternalread_operation">3.1.3. putForExternalRead operation</a></li>
</ul>
</li>
<li><a href="#advancedcache_api">3.2. AdvancedCache API</a>
<ul class="sectlevel3">
<li><a href="#flags">3.2.1. Flags</a></li>
</ul>
</li>
<li><a href="#listeners_and_notifications">3.3. Listeners and Notifications</a>
<ul class="sectlevel3">
<li><a href="#cache_level_notifications">3.3.1. Cache-level notifications</a>
<ul class="sectlevel4">
<li><a href="#cluster_listeners">Cluster Listeners</a></li>
<li><a href="#event_filtering_and_conversion">Event filtering and conversion</a></li>
<li><a href="#initial_state_events">Initial State Events</a></li>
<li><a href="#duplicate_events">Duplicate Events</a></li>
</ul>
</li>
<li><a href="#cache_manager_level_notifications">3.3.2. Cache manager-level notifications</a></li>
<li><a href="#synchronicity_of_events">3.3.3. Synchronicity of events</a>
<ul class="sectlevel4">
<li><a href="#asynchronous_thread_pool">Asynchronous thread pool</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cache_asynchronous_api">3.4. Asynchronous API</a>
<ul class="sectlevel3">
<li><a href="#why_use_such_an_api">3.4.1. Why use such an API?</a></li>
<li><a href="#which_processes_actually_happen_asynchronously">3.4.2. Which processes actually happen asynchronously?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#endpoint_interop">4. Configuring Cache Encoding</a>
<ul class="sectlevel2">
<li><a href="#storage_formats_client_interop-data">4.1. Cache Encoding and Client Interoperability</a>
<ul class="sectlevel3">
<li><a href="#memcached_interoperability-data">4.1.1. Configuring Cache Encoding for Memcached Clients</a></li>
</ul>
</li>
<li><a href="#configuring_cache_encoding-data">4.2. Configuring Encoding for Infinispan Caches</a></li>
<li><a href="#configuring_protobuf_encoding-data">4.3. Storing Data in Protobuf Format</a></li>
<li><a href="#using_text_based_storage-data">4.4. Storing Data in Text-Based Formats</a></li>
<li><a href="#storing_binary_objects-data">4.5. Storing Marshalled Java Objects</a></li>
<li><a href="#storing_pojos-data">4.6. Storing Unmarshalled Java Objects</a></li>
<li><a href="#data_encoding">4.7. Data Encoding</a>
<ul class="sectlevel3">
<li><a href="#overview">4.7.1. Overview</a></li>
<li><a href="#default_encoders">4.7.2. Default encoders</a></li>
<li><a href="#overriding_programmatically">4.7.3. Overriding programmatically</a></li>
<li><a href="#defining_custom_encoders">4.7.4. Defining Custom Encoders</a></li>
</ul>
</li>
<li><a href="#data_transcoding">4.8. Transcoders and Data Conversion</a>
<ul class="sectlevel3">
<li><a href="#mediatype_override">4.8.1. Converting Data on Demand</a></li>
<li><a href="#installing_transcoders_in_embedded_deloyments">4.8.2. Installing Transcoders in Embedded Deloyments</a></li>
<li><a href="#transcoders_and_encoders">4.8.3. Transcoders and Encoders</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#marshalling">5. Configuring Infinispan to Marshall Java Objects</a>
<ul class="sectlevel2">
<li><a href="#protostream_types-configuring_marshalling">5.1. Supported Types</a></li>
<li><a href="#marshalling_user_types">5.2. Marshalling User Types with ProtoStream</a>
<ul class="sectlevel3">
<li><a href="#generating_protostream_sci-marshalling">5.2.1. Generating Serialization Context Initializers</a></li>
<li><a href="#implementing_proto_marshallers">5.2.2. Manually Implementing Serialization Context Initializers</a></li>
<li><a href="#registering_sci-marshalling">5.2.3. Registering Serialization Context Initializers</a></li>
</ul>
</li>
<li><a href="#marshaller_implementations">5.3. Configuring Alternative Marshaller Implementations</a>
<ul class="sectlevel3">
<li><a href="#jboss_marshalling">5.3.1. Using JBoss Marshalling</a></li>
<li><a href="#java_serialization">5.3.2. Using Java Serialization</a></li>
<li><a href="#kryo_marshalling">5.3.3. Using the Kryo Marshaller</a></li>
<li><a href="#protostuff_marshalling">5.3.4. Using the Protostuff Marshaller</a></li>
<li><a href="#custom_marshallers">5.3.5. Using Custom Marshallers</a></li>
<li><a href="#deserialization_whitelist">5.3.6. Adding Java Classes to Deserialization White Lists</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered_locks">6. Clustered Locks</a>
<ul class="sectlevel2">
<li><a href="#lock_api-locking">6.1. Lock API</a></li>
<li><a href="#using_clustered_locks-locking">6.2. Using Clustered Locks</a></li>
<li><a href="#configuring_clustered_locks-locking">6.3. Configuring Internal Caches for Locks</a></li>
</ul>
</li>
<li><a href="#clustered_counters">7. Clustered Counters</a>
<ul class="sectlevel2">
<li><a href="#installation_and_configuration">7.1. Installation and Configuration</a>
<ul class="sectlevel3">
<li><a href="#list_counter_names">7.1.1. List counter names</a></li>
</ul>
</li>
<li><a href="#the_countermanager_interface">7.2. The <code>CounterManager</code> interface.</a>
<ul class="sectlevel3">
<li><a href="#remove_a_counter_via_countermanager">7.2.1. Remove a counter via CounterManager</a></li>
</ul>
</li>
<li><a href="#the_counter">7.3. The Counter</a>
<ul class="sectlevel3">
<li><a href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters">7.3.1. The <code>StrongCounter</code> interface: when the consistency or bounds matters.</a>
<ul class="sectlevel4">
<li><a href="#bounded_strongcounter">Bounded <code>StrongCounter</code></a></li>
<li><a href="#uses_cases">Uses cases</a></li>
<li><a href="#usage_examples">Usage Examples</a></li>
</ul>
</li>
<li><a href="#the_weakcounter_interface_when_speed_is_needed">7.3.2. The <code>WeakCounter</code> interface: when speed is needed</a>
<ul class="sectlevel4">
<li><a href="#weak_counter_interface">Weak Counter Interface</a></li>
<li><a href="#uses_cases_2">Uses cases</a></li>
<li><a href="#examples">Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#clustered_counters_notify_events">7.4. Notifications and Events</a></li>
</ul>
</li>
<li><a href="#locking_concurrency">8. Locking and Concurrency</a>
<ul class="sectlevel2">
<li><a href="#locking_implementation_details">8.1. Locking implementation details</a>
<ul class="sectlevel3">
<li><a href="#how_does_it_work_in_clustered_caches">8.1.1. How does it work in clustered caches?</a>
<ul class="sectlevel4">
<li><a href="#non_transactional_caches">Non Transactional caches</a></li>
</ul>
</li>
<li><a href="#transactional_caches">8.1.2. Transactional caches</a></li>
<li><a href="#isolation_levels">8.1.3. Isolation levels</a></li>
<li><a href="#the_lockmanager">8.1.4. The LockManager</a></li>
<li><a href="#lock_striping">8.1.5. Lock striping</a></li>
<li><a href="#concurrency_levels">8.1.6. Concurrency levels</a></li>
<li><a href="#lock_timeout">8.1.7. Lock timeout</a></li>
<li><a href="#consistency">8.1.8. Consistency</a></li>
</ul>
</li>
<li><a href="#data_versioning">8.2. Data Versioning</a></li>
</ul>
</li>
<li><a href="#cdi_support">9. Using the Infinispan CDI Extension</a>
<ul class="sectlevel2">
<li><a href="#cdi_dependencies">9.1. CDI Dependencies</a></li>
<li><a href="#cdi_inject_embed">9.2. Injecting Embedded Caches</a></li>
<li><a href="#cdi_inject_remote">9.3. Injecting Remote Caches</a></li>
<li><a href="#jcache_annotations">9.4. JCache Caching Annotations</a></li>
<li><a href="#cache_events">9.5. Receiving Cache and Cache Manager Events</a></li>
</ul>
</li>
<li><a href="#transaction_manager">10. Infinispan Transactions</a>
<ul class="sectlevel2">
<li><a href="#tx_configuration">10.1. Configuring transactions</a></li>
<li><a href="#tx_isolation_levels">10.2. Isolation levels</a></li>
<li><a href="#tx_locking">10.3. Transaction locking</a>
<ul class="sectlevel3">
<li><a href="#pessimistic_transactional_cache">10.3.1. Pessimistic transactional cache</a></li>
<li><a href="#optimistic_transactional_cache">10.3.2. Optimistic transactional cache</a></li>
<li><a href="#what_do_i_need_pessimistic_or_optimistic_transactions">10.3.3. What do I need - pessimistic or optimistic transactions?</a></li>
</ul>
</li>
<li><a href="#tx_write_skew">10.4. Write Skews</a>
<ul class="sectlevel3">
<li><a href="#forcing_write_locks_on_keys_in_pessimitic_transactions">10.4.1. Forcing write locks on keys in pessimitic transactions</a></li>
</ul>
</li>
<li><a href="#dealing_with_exceptions">10.5. Dealing with exceptions</a></li>
<li><a href="#tx_sync_enlist">10.6. Enlisting Synchronizations</a></li>
<li><a href="#tx_batching">10.7. Batching</a>
<ul class="sectlevel3">
<li><a href="#api">10.7.1. API</a></li>
<li><a href="#batching_and_jta">10.7.2. Batching and JTA</a></li>
</ul>
</li>
<li><a href="#tx_recovery">10.8. Transaction recovery</a>
<ul class="sectlevel3">
<li><a href="#when_to_use_recovery">10.8.1. When to use recovery</a></li>
<li><a href="#how_does_it_work">10.8.2. How does it work</a></li>
<li><a href="#configuring_recovery">10.8.3. Configuring recovery   </a>
<ul class="sectlevel4">
<li><a href="#enable_jmx_support">Enable JMX support</a></li>
</ul>
</li>
<li><a href="#recovery_cache">10.8.4. Recovery cache</a></li>
<li><a href="#integration_with_the_transaction_manager">10.8.5. Integration with the transaction manager</a></li>
<li><a href="#tx_recovery_reconciliation">10.8.6. Reconciliation</a>
<ul class="sectlevel4">
<li><a href="#force_commitrollback_based_on_xid">Force commit/rollback based on XID</a></li>
</ul>
</li>
<li><a href="#want_to_know_more">10.8.7. Want to know more?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#functional_map_api">11. Functional Map API</a>
<ul class="sectlevel2">
<li><a href="#asynchronous_and_lazy">11.1. Asynchronous and Lazy</a></li>
<li><a href="#function_transparency">11.2. Function transparency</a></li>
<li><a href="#constructing_functional_maps">11.3. Constructing Functional Maps</a></li>
<li><a href="#read_only_map_api">11.4. Read-Only Map API</a>
<ul class="sectlevel3">
<li><a href="#read_only_entry_view">11.4.1. Read-Only Entry View</a></li>
</ul>
</li>
<li><a href="#write_only_map_api">11.5. Write-Only Map API</a>
<ul class="sectlevel3">
<li><a href="#write_only_entry_view">11.5.1. Write-Only Entry View</a></li>
</ul>
</li>
<li><a href="#read_write_map_api">11.6. Read-Write Map API</a>
<ul class="sectlevel3">
<li><a href="#read_write_entry_view">11.6.1. Read-Write Entry View</a></li>
</ul>
</li>
<li><a href="#meta_parameter">11.7. Metadata Parameter Handling</a></li>
<li><a href="#_invocation_parameter">11.8. Invocation Parameter</a></li>
<li><a href="#functional_listeners">11.9. Functional Listeners</a>
<ul class="sectlevel3">
<li><a href="#write_listeners">11.9.1. Write Listeners</a></li>
<li><a href="#read_write_listeners">11.9.2. Read-Write Listeners</a></li>
</ul>
</li>
<li><a href="#marshalling_of_functions">11.10. Marshalling of Functions</a></li>
<li><a href="#use_cases_for_functional_api">11.11. Use Cases for Functional API</a></li>
</ul>
</li>
<li><a href="#search_api">12. Indexing and Searching</a>
<ul class="sectlevel2">
<li><a href="#overview_2">12.1. Overview</a></li>
<li><a href="#indexing_entry_values">12.2. Indexing Entry Values</a>
<ul class="sectlevel3">
<li><a href="#configuration">12.2.1. Configuration</a></li>
<li><a href="#specifying_indexed_entities">12.2.2. Specifying Indexed Entities</a></li>
<li><a href="#query_index_storage">12.2.3. Index Storage</a></li>
<li><a href="#query_index_manager">12.2.4. Index Manager</a></li>
<li><a href="#query_massindexer">12.2.5. Rebuilding Indexes</a></li>
</ul>
</li>
<li><a href="#searching_ickle">12.3. Searching</a>
<ul class="sectlevel3">
<li><a href="#pagination">12.3.1. Pagination</a></li>
<li><a href="#number_of_hits">12.3.2. Number of Hits</a></li>
<li><a href="#iteration">12.3.3. Iteration</a></li>
<li><a href="#using_named_query_parameters">12.3.4. Using Named Query Parameters</a></li>
<li><a href="#query_ickle">12.3.5. Ickle Query Language Parser Syntax</a>
<ul class="sectlevel4">
<li><a href="#filtering_operators">Filtering operators</a></li>
<li><a href="#boolean_conditions">Boolean conditions</a></li>
<li><a href="#nested_conditions">Nested conditions</a></li>
<li><a href="#selecting_attributes">Selecting attributes</a></li>
<li><a href="#sorting">Sorting</a></li>
<li><a href="#grouping_and_aggregation">Grouping and Aggregation</a></li>
<li><a href="#aggregations">Aggregations</a></li>
<li><a href="#evaluation_of_queries_with_grouping_and_aggregation">Evaluation of queries with grouping and aggregation</a></li>
<li><a href="#using_full_text_search">Using Full-text search</a>
<ul class="sectlevel5">
<li><a href="#fuzzy_queries">Fuzzy Queries</a></li>
<li><a href="#range_queries">Range Queries</a></li>
<li><a href="#phrase_queries">Phrase Queries</a></li>
<li><a href="#proximity_queries">Proximity Queries</a></li>
<li><a href="#wildcard_queries">Wildcard Queries</a></li>
<li><a href="#regular_expression_queries">Regular Expression Queries</a></li>
<li><a href="#boosting_queries">Boosting Queries</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#query_library">12.4. Embedded Search</a>
<ul class="sectlevel3">
<li><a href="#quick_example">12.4.1. Quick example</a></li>
<li><a href="#mapping_embedded">12.4.2. Mapping Entities</a>
<ul class="sectlevel4">
<li><a href="#documentid">@DocumentId</a></li>
<li><a href="#transformable_keys">@Transformable keys</a></li>
<li><a href="#query_configuration_api">Programmatic mapping</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#query_remote">12.5. Remote Search</a>
<ul class="sectlevel3">
<li><a href="#remote_query_example">12.5.1. A remote query example</a></li>
<li><a href="#enable_indexing">12.5.2. Indexing of Protobuf encoded entries</a></li>
<li><a href="#analysis">12.5.3. Analysis</a>
<ul class="sectlevel4">
<li><a href="#default_analyzers">Default Analyzers</a></li>
<li><a href="#using_analyzer_definitions">Using Analyzer Definitions</a></li>
<li><a href="#creating_custom_analyzer_definitions">Creating Custom Analyzer Definitions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#query_continuous">12.6. Continuous Query</a>
<ul class="sectlevel3">
<li><a href="#continuous_query_execution">12.6.1. Continuous Query Execution</a></li>
<li><a href="#running_continuous_queries">12.6.2. Running Continuous Queries</a></li>
<li><a href="#removing_continuous_queries">12.6.3. Removing Continuous Queries</a></li>
<li><a href="#notes_on_performance_of_continuous_queries">12.6.4. Notes on performance of Continuous Queries</a></li>
</ul>
</li>
<li><a href="#statistics">12.7. Statistics</a></li>
<li><a href="#query_performance">12.8. Performance Tuning</a>
<ul class="sectlevel3">
<li><a href="#batch_writing_in_sync_mode">12.8.1. Batch writing in SYNC mode</a></li>
<li><a href="#writing_using_async_mode">12.8.2. Writing using async mode</a></li>
<li><a href="#index_reader_async_strategy">12.8.3. Index reader async strategy</a></li>
<li><a href="#lucene_options">12.8.4. Lucene Options</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#execute_code_grid">13. Executing Code in the Grid</a>
<ul class="sectlevel2">
<li><a href="#cluster_executor">13.1. Cluster Executor</a>
<ul class="sectlevel3">
<li><a href="#filtering_execution_nodes">13.1.1. Filtering execution nodes</a></li>
<li><a href="#timeout">13.1.2. Timeout</a></li>
<li><a href="#single_node_submission">13.1.3. Single Node Submission</a>
<ul class="sectlevel4">
<li><a href="#failover">Failover</a></li>
</ul>
</li>
<li><a href="#example_pi_approximation">13.1.4. Example: PI Approximation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#streams">14. Streams</a>
<ul class="sectlevel2">
<li><a href="#common_stream_operations">14.1. Common stream operations</a></li>
<li><a href="#key_filtering">14.2. Key filtering</a></li>
<li><a href="#segment_based_filtering">14.3. Segment based filtering</a></li>
<li><a href="#localinvalidation">14.4. Local/Invalidation</a></li>
<li><a href="#example">14.5. Example</a></li>
<li><a href="#distributionreplicationscattered">14.6. Distribution/Replication/Scattered</a>
<ul class="sectlevel3">
<li><a href="#rehash_aware">14.6.1. Rehash Aware</a></li>
<li><a href="#serialization">14.6.2. Serialization</a></li>
</ul>
</li>
<li><a href="#parallel_computation">14.7. Parallel Computation</a></li>
<li><a href="#task_timeout">14.8. Task timeout</a></li>
<li><a href="#injection">14.9. Injection</a></li>
<li><a href="#distributed_stream_execution">14.10. Distributed Stream execution</a></li>
<li><a href="#key_based_rehash_aware_operators">14.11. Key based rehash aware operators</a></li>
<li><a href="#intermediate_operation_exceptions">14.12. Intermediate operation exceptions</a></li>
<li><a href="#examples_2">14.13. Examples</a></li>
</ul>
</li>
<li><a href="#jcache_jsr_107">15. JCache (JSR-107) API</a>
<ul class="sectlevel2">
<li><a href="#creating_embedded_caches">15.1. Creating embedded caches</a>
<ul class="sectlevel3">
<li><a href="#configuring_embedded_caches">15.1.1. Configuring embedded caches</a></li>
</ul>
</li>
<li><a href="#creating_remote_caches">15.2. Creating remote caches</a>
<ul class="sectlevel3">
<li><a href="#configuring_remote_caches">15.2.1. Configuring remote caches</a></li>
</ul>
</li>
<li><a href="#store_and_retrieve_data">15.3. Store and retrieve data</a></li>
<li><a href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis">15.4. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</a></li>
<li><a href="#clustering_jcache_instances">15.5. Clustering JCache instances</a></li>
</ul>
</li>
<li><a href="#multimap_cache">16. Multimap Cache</a>
<ul class="sectlevel2">
<li><a href="#installation_and_configuration_2">16.1. Installation and configuration</a></li>
<li><a href="#multimapcache_api">16.2. MultimapCache API</a></li>
<li><a href="#creating_a_multimap_cache">16.3. Creating a Multimap Cache</a>
<ul class="sectlevel3">
<li><a href="#embedded_mode">16.3.1. Embedded mode</a></li>
</ul>
</li>
<li><a href="#multimap_limitations">16.4. Limitations</a>
<ul class="sectlevel3">
<li><a href="#support_for_duplicates">16.4.1. Support for duplicates</a></li>
<li><a href="#eviction">16.4.2. Eviction</a></li>
<li><a href="#transactions">16.4.3. Transactions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#custom_interceptors_chapter">17. Custom Interceptors</a>
<ul class="sectlevel2">
<li><a href="#adding_custom_interceptors_declaratively">17.1. Adding custom interceptors declaratively</a></li>
<li><a href="#adding_custom_interceptors_programatically">17.2. Adding custom interceptors programatically</a></li>
<li><a href="#custom_interceptor_design">17.3. Custom interceptor design</a></li>
</ul>
</li>
<li><a href="#extending">18. Extending Infinispan</a>
<ul class="sectlevel2">
<li><a href="#custom_commands">18.1. Custom Commands</a>
<ul class="sectlevel3">
<li><a href="#an_example">18.1.1. An Example</a></li>
<li><a href="#preassigned_custom_command_id_ranges">18.1.2. Preassigned Custom Command Id Ranges</a></li>
</ul>
</li>
<li><a href="#extending_the_configuration_builders_and_parsers">18.2. Extending the configuration builders and parsers</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="mvn"><a class="anchor" href="#mvn"></a>1. Configuring the Infinispan Maven Repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan Java distributions are available from Maven.</p>
</div>
<div class="paragraph">
<p>Infinispan artifacts are available from Maven central. See the <a href="https://search.maven.org/search?q=g:org.infinispan">org.infinispan</a> group for available Infinispan artifacts.</p>
</div>
<div class="sect2">
<h3 id="configure_pom"><a class="anchor" href="#configure_pom"></a>1.1. Configuring Your Infinispan POM</h3>
<div class="paragraph">
<p>Maven uses configuration files called Project Object Model (POM) files to
define projects and manage builds. POM files are in XML format and describe the
module and component dependencies, build order, and targets for the resulting
project packaging and output.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open your project <code>pom.xml</code> for editing.</p>
</li>
<li>
<p>Define the <code>version.infinispan</code> property with the correct Infinispan version.</p>
</li>
<li>
<p>Include the <code>infinispan-bom</code> in a <code>dependencyManagement</code> section.</p>
<div class="paragraph">
<p>The Bill Of Materials (BOM) controls dependency versions, which avoids version
conflicts and means you do not need to set the version for each Infinispan
artifact you add as a dependency to your project.</p>
</div>
</li>
<li>
<p>Save and close <code>pom.xml</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows the Infinispan version and BOM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;properties&gt;</span>
  <span class="tag">&lt;version.infinispan&gt;</span>11.0.5.Final<span class="tag">&lt;/version.infinispan&gt;</span>
<span class="tag">&lt;/properties&gt;</span>

<span class="tag">&lt;dependencyManagement&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>infinispan-bom<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
      <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
      <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Next Steps</div>
<p>Add Infinispan artifacts as dependencies to your <code>pom.xml</code> as required.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache_manager"><a class="anchor" href="#cache_manager"></a>2. Cache Managers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main entry point to Infinispan is the <code>CacheManager</code> interface that lets you:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure and obtain caches.</p>
</li>
<li>
<p>Manage and monitor clustered Infinispan nodes.</p>
</li>
<li>
<p>Execute code across your cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you embed Infinispan in your application, then you use an
<code>EmbeddedCacheManager</code>. If you run Infinispan as a remote server, then you use
a <code>RemoteCacheManager</code>.</p>
</div>
<div class="paragraph">
<p>Cache Managers are heavyweight objects so you should instantiate only one
<code>CacheManager</code> instance per JVM in most cases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starts a local, non-clustered, Cache Manager with no caches.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cache Managers have lifecycles and the default constructors also call the
<code>start()</code> method. Overloaded versions of the constructors are available, but
they do not start the <code>CacheManager</code>. However, you must always start the
<code>CacheManager</code> before you can create caches.</p>
</div>
<div class="paragraph">
<p>Likewise, you must call <code>stop()</code> when you no longer require a running
<code>CacheManager</code> so that it releases resources. This also ensures that the Cache
Manager safely stops any caches that it controls.</p>
</div>
<div class="sect2">
<h3 id="obtaining_caches"><a class="anchor" href="#obtaining_caches"></a>2.1. Obtaining caches</h3>
<div class="paragraph">
<p>After you configure the <code>CacheManager</code>, you can obtain and control caches.</p>
</div>
<div class="paragraph">
<p>Invoke the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCache(java.lang.String)"><code>getCache(String)</code></a> method to obtain caches, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation creates a cache named <code>myCache</code>, if it does not already exist, and returns it.</p>
</div>
<div class="paragraph">
<p>Using the <code>getCache()</code> method creates the cache only on the node where you invoke the method. In other words, it performs a local operation that must be invoked on each node across the cluster. Typically, applications deployed across multiple nodes obtain caches during initialization to ensure that caches are <em>symmetric</em> and exist on each node.</p>
</div>
<div class="paragraph">
<p>Invoke the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/EmbeddedCacheManagerAdmin.html#createCache(java.lang.String,java.lang.String)"><code>createCache()</code></a> method to create caches dynamically across the entire cluster, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.administration().createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myTemplate</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding operation also automatically creates caches on any nodes that subsequently join the cluster.</p>
</div>
<div class="paragraph">
<p>Caches that you create with the <code>createCache()</code> method are ephemeral by default. If the entire cluster shuts down, the cache is not automatically created again when it restarts.</p>
</div>
<div class="paragraph">
<p>Use the PERMANENT flag to ensure that caches can survive restarts, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; myCache = manager.administration().withFlags(AdminFlag.PERMANENT).createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myTemplate</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the PERMANENT flag to take effect, you must enable global state and set a configuration storage provider.</p>
</div>
<div class="paragraph">
<p>For more information about configuration storage providers, see <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/configuration/global/GlobalStateConfigurationBuilder.html#configurationStorage(org.infinispan.globalstate.ConfigurationStorage)">GlobalStateConfigurationBuilder#configurationStorage()</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="clustering_information"><a class="anchor" href="#clustering_information"></a>2.2. Clustering Information</h3>
<div class="paragraph">
<p>The <code>EmbeddedCacheManager</code> has quite a few methods to provide information
as to how the cluster is operating.  The following methods only really make
sense when being used in a clustered environment (that is when a Transport
is configured).</p>
</div>
</div>
<div class="sect2">
<h3 id="member_information"><a class="anchor" href="#member_information"></a>2.3. Member Information</h3>
<div class="paragraph">
<p>When you are using a cluster it is very important to be able to find information
about membership in the cluster including who is the owner of the cluster.</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getMembers()">getMembers()</a></div>
<p>The getMembers() method returns all of the nodes in the current cluster.</p>
</div>
<div class="paragraph">
<div class="title"><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#getCoordinator()">getCoordinator()</a></div>
<p>The getCoordinator() method will tell you which one of the members is the coordinator
of the cluster.  For most intents you shouldn&#8217;t need to care who the coordinator is.
You can use <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/EmbeddedCacheManager.html#isCoordinator()">isCoordinator()</a>
method directly to see if the local node is the coordinator as well.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache_api"><a class="anchor" href="#cache_api"></a>3. Infinispan Cache Interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides a <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html">Cache</a> interface that exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface.  Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p>
</div>
<div class="sect2">
<h3 id="cache_api_2"><a class="anchor" href="#cache_api_2"></a>3.1. Cache API</h3>
<div class="paragraph">
<p>For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial.</p>
</div>
<div class="sect3">
<h4 id="performance_concerns_of_certain_map_methods"><a class="anchor" href="#performance_concerns_of_certain_map_methods"></a>3.1.1. Performance Concerns of Certain Map Methods</h4>
<div class="paragraph">
<p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#size()">size()</a> ,
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#values()">values()</a> ,
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#keySet()">keySet()</a> and
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#entrySet()">entrySet()</a> .
Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p>
</div>
<div class="paragraph">
<p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck.  As such, these methods should only be used for informational or debugging purposes only.</p>
</div>
<div class="paragraph">
<p>It should be noted that using certain flags with the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(java.util.Collection)">withFlags()</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="mortal_and_immortal_data"><a class="anchor" href="#mortal_and_immortal_data"></a>3.1.2. Mortal and Immortal Data</h4>
<div class="paragraph">
<p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data.  For example, simply using <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory).  If, however, you put data in the cache using <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/api/BasicCache.html#put(K,V,long,java.util.concurrent.TimeUnit)">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p>
</div>
<div class="paragraph">
<p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration.  Any combination of lifespans or maxIdles can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="putforexternalread_operation"><a class="anchor" href="#putforexternalread_operation"></a>3.1.3. putForExternalRead operation</h4>
<div class="paragraph">
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere.  Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p>
</div>
<div class="paragraph">
<p>To achieve this, <code>putForExternalRead()</code> acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. <code>putForExternalRead()</code> is considered to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p>
</div>
<div class="paragraph">
<p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> within the context of this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Id of the person to look up, provided by the application</span>
PersonId id = ...;

<span class="comment">// Get a reference to the cache where person instances will be stored</span>
Cache&lt;PersonId, Person&gt; cache = ...;

<span class="comment">// First, check whether the cache contains the person instance</span>
<span class="comment">// associated with with the given id</span>
Person cachedPerson = cache.get(id);

<span class="keyword">if</span> (cachedPerson == <span class="predefined-constant">null</span>) {
   <span class="comment">// The person is not cached yet, so query the data store with the id</span>
   Person person = dataStore.lookup(id);

   <span class="comment">// Cache the person along with the id so that future requests can</span>
   <span class="comment">// retrieve it from memory rather than going to the data store</span>
   cache.putForExternalRead(id, person);
} <span class="keyword">else</span> {
   <span class="comment">// The person was found in the cache, so return it to the application</span>
   <span class="keyword">return</span> cachedPerson;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K,V)">putForExternalRead</a> should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">put</a> operation, otherwise the possibility of caching corrupt data is likely.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="advancedcache_api"><a class="anchor" href="#advancedcache_api"></a>3.2. AdvancedCache API</h3>
<div class="paragraph">
<p>In addition to the simple Cache interface, Infinispan offers an <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors.  The AdvancedCache offers the ability to access certain internal components and to apply flags to alter the default behavior of certain cache methods.  The following code snippet depicts how an AdvancedCache can be obtained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="flags"><a class="anchor" href="#flags"></a>3.2.1. Flags</h4>
<div class="paragraph">
<p>Flags are applied to regular cache methods to alter the behavior of certain methods.  For a list of all available flags, and their effects, see the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration.  Flags are applied using <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(java.util.Collection)">AdvancedCache.withFlags()</a> .  This builder method can be used to apply any number of flags to a cache invocation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.FORCE_SYNCHRONOUS)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="listeners_and_notifications"><a class="anchor" href="#listeners_and_notifications"></a>3.3. Listeners and Notifications</h3>
<div class="paragraph">
<p>Infinispan offers a listener API, where clients can register for and get notified when events take place.  This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p>
</div>
<div class="paragraph">
<p>Events trigger a notification which is dispatched to listeners.   Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a>s annotated with <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache, in a non blocking fashion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PrintWhenAdded</span> {
  <span class="predefined-type">Queue</span>&lt;CacheEntryCreatedEvent&gt; events = <span class="keyword">new</span> <span class="predefined-type">ConcurrentLinkedQueue</span>&lt;&gt;();

<span class="error"> </span> <span class="annotation">@CacheEntryCreated</span>
<span class="error"> </span> <span class="directive">public</span> CompletionStage&lt;<span class="predefined-type">Void</span>&gt; print(CacheEntryCreatedEvent event) {
    events.add(event);
    <span class="keyword">return</span> <span class="predefined-constant">null</span>;
<span class="error"> </span> }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more comprehensive examples, please see the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p>
</div>
<div class="sect3">
<h4 id="cache_level_notifications"><a class="anchor" href="#cache_level_notifications"></a>3.3.1. Cache-level notifications</h4>
<div class="paragraph">
<p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur.  Note in a distributed cache these events are only raised on the owners of data being affected.  Examples of cache-level events are entries being added, removed, modified, etc.  These events trigger notifications to listeners registered to a specific cache.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="cluster_listeners"><a class="anchor" href="#cluster_listeners"></a>Cluster Listeners</h5>
<div class="paragraph">
<p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p>
</div>
<div class="paragraph">
<p>To do so all that is required is set to annotate your listener as being clustered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (clustered = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyClusterListener</span> { .... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some limitations to cluster listeners from a non clustered listener.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code>, <code>@CacheEntryRemoved</code> and <code>@CacheEntryExpired</code> events.  Note this means any other type of event will not be listened to for this listener.</p>
</li>
<li>
<p>Only the post event is sent to a cluster listener, the pre event is ignored.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="event_filtering_and_conversion"><a class="anchor" href="#event_filtering_and_conversion"></a>Event filtering and conversion</h5>
<div class="paragraph">
<p>All applicable events on the node where the listener is installed will be raised to the listener.  It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p>
</div>
<div class="paragraph">
<p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SpecificKeyFilter</span> <span class="directive">implements</span> KeyFilter&lt;<span class="predefined-type">String</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> keyToAccept;

    <span class="directive">public</span> SpecificKeyFilter(<span class="predefined-type">String</span> keyToAccept) {
      <span class="keyword">if</span> (keyToAccept == <span class="predefined-constant">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
      }
      <span class="local-variable">this</span>.keyToAccept = keyToAccept;
    }

    <span class="directive">public</span> <span class="type">boolean</span> accept(<span class="predefined-type">String</span> key) {
      <span class="keyword">return</span> keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, <span class="keyword">new</span> SpecificKeyFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Only Me</span><span class="delimiter">&quot;</span></span>));
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful when you want to limit what events you receive in a more efficient manner.</p>
</div>
<div class="paragraph">
<p>There is also a <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event.  This can be nice to modularize any code that does value conversions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener.  This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to.  This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter).
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="initial_state_events"><a class="anchor" href="#initial_state_events"></a>Initial State Events</h5>
<div class="paragraph">
<p>When a listener is installed it will only be notified of events after it is fully installed.</p>
</div>
<div class="paragraph">
<p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache.  Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This only works for clustered listeners at this time.  <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="duplicate_events"><a class="anchor" href="#duplicate_events"></a>Duplicate Events</h5>
<div class="paragraph">
<p>It is possible in a non transactional cache to receive duplicate events.  This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p>
</div>
<div class="paragraph">
<p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups.  Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p>
</div>
<div class="paragraph">
<p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyRetryListener</span> {
  <span class="annotation">@CacheEntryModified</span>
  <span class="directive">public</span> <span class="type">void</span> entryModified(CacheEntryModifiedEvent event) {
    <span class="keyword">if</span> (event.isCommandRetried()) {
      <span class="comment">// Do something</span>
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cache_manager_level_notifications"><a class="anchor" href="#cache_manager_level_notifications"></a>3.3.2. Cache manager-level notifications</h4>
<div class="paragraph">
<p>Cache manager-level events occur on a cache manager.  These too are global and  cluster-wide, but involve events that affect all caches created by a single cache manager.  Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all cache manager-level notifications,  and their respective method-level annotations.</p>
</div>
</div>
<div class="sect3">
<h4 id="synchronicity_of_events"><a class="anchor" href="#synchronicity_of_events"></a>3.3.3. Synchronicity of events</h4>
<div class="paragraph">
<p>By default, all async notifications are dispatched in the notification thread pool.
Sync notifications will delay the operation from continuing until the listener method completes or the CompletionStage
completes (the former causing the thread to block). Alternatively, you could annotate your listener as <em>asynchronous</em> in
which case the operation will continue immediately, while the notification is completed asynchronously on the notification thread pool.
To do this, simply annotate your listener such:</p>
</div>
<div class="paragraph">
<p>Asynchronous Listener</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span> (sync = <span class="predefined-constant">false</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyAsyncListener</span> {
   <span class="annotation">@CacheEntryCreated</span>
   <span class="type">void</span> listen(CacheEntryCreatedEvent event) { }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Blocking Synchronous Listener</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MySyncListener</span> {
   <span class="annotation">@CacheEntryCreated</span>
   <span class="type">void</span> listen(CacheEntryCreatedEvent event) { }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Non-Blocking Listener</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyNonBlockingListener</span> {
   <span class="annotation">@CacheEntryCreated</span>
   CompletionStage&lt;<span class="predefined-type">Void</span>&gt; listen(CacheEntryCreatedEvent event) { }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="asynchronous_thread_pool"><a class="anchor" href="#asynchronous_thread_pool"></a>Asynchronous thread pool</h5>
<div class="paragraph">
<p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="https://docs.jboss.org/infinispan/11.0/configdocs//infinispan-config-11.0.html"><code>&lt;listener-executor /&gt;</code></a> XML element in your configuration file.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_asynchronous_api"><a class="anchor" href="#cache_asynchronous_api"></a>3.4. Asynchronous API</h3>
<div class="paragraph">
<p>In addition to synchronous API methods like <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">Cache.put()</a> , <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#remove-java.lang.Object-">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p>
</div>
<div class="paragraph">
<p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/api/AsyncCache.html#putAsync(K,V)">Cache.putAsync()</a> , <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/api/AsyncCache.html#removeAsync(java.lang.Object)">Cache.removeAsync()</a> , etc.  These asynchronous counterparts return a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">CompletableFuture</a> that contains the actual result of the operation.</p>
</div>
<div class="paragraph">
<p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns <code>String</code> while <code>Cache.putAsync(String key, String value)</code> returns <code>CompletableFuture&lt;String&gt;</code>.</p>
</div>
<div class="sect3">
<h4 id="why_use_such_an_api"><a class="anchor" href="#why_use_such_an_api"></a>3.4.1. Why use such an API?</h4>
<div class="paragraph">
<p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;CompletableFuture&lt;?&gt;&gt; futures = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;();
futures.add(cache.putAsync(key1, value1)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key2, value2)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key3, value3)); <span class="comment">// does not block</span>

<span class="comment">// the remote calls for the 3 puts will effectively be executed</span>
<span class="comment">// in parallel, particularly useful if running in distributed mode</span>
<span class="comment">// and the 3 keys would typically be pushed to 3 different nodes</span>
<span class="comment">// in the cluster</span>

<span class="comment">// check that the puts completed successfully</span>
<span class="keyword">for</span> (CompletableFuture&lt;?&gt; f: futures) f.get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="which_processes_actually_happen_asynchronously"><a class="anchor" href="#which_processes_actually_happen_asynchronously"></a>3.4.2. Which processes actually happen asynchronously?</h4>
<div class="paragraph">
<p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation.
These are, in order of cost:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>network calls</p>
</li>
<li>
<p>marshalling</p>
</li>
<li>
<p>writing to a cache store (optional)</p>
</li>
<li>
<p>locking</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="endpoint_interop"><a class="anchor" href="#endpoint_interop"></a>4. Configuring Cache Encoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan saves your data in a specific format that can be converted on-the-fly when you read and write to and from caches.
configure the storage format by specifying a MediaType for keys and values, which
describes the format of the data.</p>
</div>
<div class="paragraph">
<p>Infinispan can also convert data between different storage formats to handle
interoperability between different client protocols and when using custom code
to process data.</p>
</div>
<div class="sect2">
<h3 id="storage_formats_client_interop-data"><a class="anchor" href="#storage_formats_client_interop-data"></a>4.1. Cache Encoding and Client Interoperability</h3>
<div class="paragraph">
<p>The encoding that you use for your data affects client interoperability and
capabilities such as Infinispan Search.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Protobuf Format</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Store data in Protobuf format to use it with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Search</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Text-Based Format</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Store data in a text-based format to use it with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Search</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Marshalled Java Objects</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Marshalled Java objects are compatible with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Search</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Unmarshalled Java Objects</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Plain Old Java Objects (POJOs) are not recommended but compatible with&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non-Java Hot Rod clients</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Search</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes. However, you must annotate entities to search with POJOs and make your classes available to Infinispan Server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom Java objects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="../developing/developing.html#configuring_cache_encoding-data">Configuring Encoding for Infinispan Caches</a></p>
</li>
<li>
<p><a href="../developing/developing.html#data_transcoding">Transcoders and Data Conversion</a></p>
</li>
<li>
<p><a href="../developing/developing.html#data_encoding">Data Encoding</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="memcached_interoperability-data"><a class="anchor" href="#memcached_interoperability-data"></a>4.1.1. Configuring Cache Encoding for Memcached Clients</h4>
<div class="paragraph">
<p>Infinispan Server disables the Memcached endpoint by default. If you enable
the Memcached endpoint, you should configure caches with a suitable encoding
for Memcached clients.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Memcached endpoint does not support authentication. For security purposes
you should use dedicated caches for Memcached clients. You should not use REST
or Hot Rod clients to interact on the same data set as Memcached clients.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure cache encoding to use <code>text/plain</code> for keys.</p>
</li>
<li>
<p>Specify any appropriate MediaType, other than <code>application/x-java-
object</code>, for values.</p>
<div class="paragraph">
<p>Memcached clients can handle keys as <code>text/plain</code> only. Values can be any MediaType
that Infinispan stores as <code>byte[]</code>, which can be Protobuf, marshalled Java
objects, or a text-based format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;encoding&gt;</span>
  <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/encoding&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Memcached endpoint includes a <code>client-encoding</code> attribute that converts the
encoding of values.</p>
</div>
<div class="paragraph">
<p>For example, as in the preceding configuration example, you store values
encoded as Protobuf. If you want Memcached clients to read and write values as
JSON, you can use the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;memcached-connector</span> <span class="attribute-name">cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">memcachedCache</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">client-encoding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Reference</div>
<p><a href="../memcached/memcached.html">Infinispan Memcached Client Guide</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring_cache_encoding-data"><a class="anchor" href="#configuring_cache_encoding-data"></a>4.2. Configuring Encoding for Infinispan Caches</h3>
<div class="paragraph">
<p>Define the MediaType that Infinispan uses to encode your data when writing and
reading to and from the cache.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you define a MediaType, you specify the format of your data to Infinispan.</p>
</div>
<div class="paragraph">
<p>If you want to use the Infinispan Console, Hot Rod clients, and REST clients
interchangeably, specify the <code>application/x-protostream</code> MediaType so
Infinispan encodes data in Protobuf format.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Specify a MediaType for key and values in your Infinispan cache configuration.</p>
<div class="ulist">
<ul>
<li>
<p>Declaratively: Set the <code>encoding</code> attribute.</p>
</li>
<li>
<p>Programmatically: Use the <code>encoding()</code> method.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Declarative examples</div>
<ul>
<li>
<p>Use the same encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache&gt;</span>
  <span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a different encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Programmatic examples</div>
<ul>
<li>
<p>Use the same encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg
  .encoding()
    .mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span>)
  .build());</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Use a different encoding for keys and values:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();

cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring_protobuf_encoding-data"><a class="anchor" href="#configuring_protobuf_encoding-data"></a>4.3. Storing Data in Protobuf Format</h3>
<div class="paragraph">
<p>Storing data in the cache as Protobuf encoded entries provides a platform
independent configuration that enables you to perform cache operations from any
client.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you configure indexing for Infinispan Search, Infinispan automatically
stores keys and values with the <code>application/x-protostream</code> media type.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify <code>application/x-protostream</code> as the MediaType for keys and values as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure your clients.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Hot Rod clients must register Protocol Buffers schema definitions that describe
entities and client marshallers.</p>
</div>
<div class="paragraph">
<p>Infinispan converts between <code>application/x-protostream</code> and <code>application/json</code>
so REST clients only need to send the following headers to read and write JSON
formatted data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Accept: application/json</code> for read operations.</p>
</li>
<li>
<p><code>Content-Type: application/json</code> for write operations.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="../developing/developing.html#storage_formats_client_interop-data">Storage Formats and Client Interoperability</a></p>
</li>
<li>
<p><a href="../developing/developing.html#protostream_cm_config">Using the ProtoStream Marshaller</a></p>
</li>
<li>
<p><a href="../developing/developing.html#">Marshalling Custom Java Objects with ProtoStream</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using_text_based_storage-data"><a class="anchor" href="#using_text_based_storage-data"></a>4.4. Storing Data in Text-Based Formats</h3>
<div class="paragraph">
<p>Configure Infinispan to store data in a text-based format such as <code>text/
plain</code>, <code>application/json</code>, or <code>application/xml</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify a text-based storage format as the MediaType for keys and values.</p>
</li>
<li>
<p>Optionally specify a character set such as <code>UTF-8</code>.</p>
<div class="paragraph">
<p>The following example configures Infinispan to store entries with the <code>text/plain; charset=UTF-8</code> format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain; charset=UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Configure your clients.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Hot Rod clients can use <code>org.infinispan.commons.marshall.StringMarshaller</code>
to handle plain text, JSON, XML, or any other text-based format.</p>
</div>
<div class="paragraph">
<p>You can also use text-based formats with the ProtoStream marshaller.
ProtoStream can handle <code>String</code> and <code>byte[]</code> types natively, without the need
to create Serialization Contexts and register Protobuf schemas (<code>.proto</code>
files).</p>
</div>
<div class="paragraph">
<p>REST clients must send the correct headers with requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Accept: text/plain; charset=UTF-8</code> for read operations.</p>
</li>
<li>
<p><code>Content-Type: text/plain; charset=UTF-8</code> for write operations.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="storing_binary_objects-data"><a class="anchor" href="#storing_binary_objects-data"></a>4.5. Storing Marshalled Java Objects</h3>
<div class="paragraph">
<p>Java Hot Rod clients can handle Java objects that represent entities and
perform marshalling to serialize and deserialize objects into <code>byte[]</code> arrays.
C++, C#, and Javascript Hot Rod clients can also handle objects in the
respective languages.</p>
</div>
<div class="paragraph">
<p>If you store entries in the cache as marshalled Java objects, you should
configure the cache with the MediaType of the marshalled storage.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify the MediaType that matches your marshaller implementation.</p>
<div class="ulist">
<ul>
<li>
<p>Protostream marshaller: Configure the MediaType as <code>application/x-protostream</code>.</p>
</li>
<li>
<p>JBoss marshalling: Configure the MediaType as <code>application/x-jboss-marshalling</code>.</p>
</li>
<li>
<p>Java serialization: Configure the MediaType as <code>application/x-java-serialized-object</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configure your clients.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Because REST clients are most suitable for handling text formats, you should
use primitives such as <code>java.lang.String</code> for keys. Otherwise, REST clients
must handle keys as <code>bytes[]</code> using a supported binary encoding.</p>
</div>
<div class="paragraph">
<p>REST clients can read values for cache entries in XML or JSON format.</p>
</div>
<div class="paragraph">
<div class="title">Equality Considerations</div>
<p>When storing data in binary format, Infinispan uses the <code>WrappedBytes</code>
interface for keys and values. This wrapper class transparently takes care of
serialization and deserialization on demand, and internally may have a
reference to the object itself being wrapped, or the serialized, byte array
representation of the object. This has an effect on the behavior of equality,
which is important to note if you implement an <code>equals()</code> methods on keys.</p>
</div>
<div class="paragraph">
<p>The <code>equals()</code> method of the wrapper class either compares binary
representations (byte arrays) or delegates to the wrapped object instance&#8217;s
<code>equals()</code> method, depending on whether both instances being compared are in
serialized or deserialized form at the time of comparison. If one of the
instances being compared is in one form and the other in another form, then one
instance is either serialized or deserialized.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="../developing/developing.html#marshalling">Marshalling Java Objects</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/WrappedBytes.html">org.infinispan.commons.marshall.WrappedBytes</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="storing_pojos-data"><a class="anchor" href="#storing_pojos-data"></a>4.6. Storing Unmarshalled Java Objects</h3>
<div class="paragraph">
<p>You can store data as deserialized Plain Old Java Objects (POJO) instead of
storing data in a binary format.</p>
</div>
<div class="paragraph">
<p>Storing POJO instead of binary format is not recommended because it
requires Infinispan to serialize data on client read operations and
deserialize data on write operations. To handle client interoperability with
custom code you should convert data on demand.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify <code>application/x-java-object</code> as the MediaType for keys and values as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my-cache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;encoding&gt;</span>
      <span class="tag">&lt;key</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;value</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;/encoding&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Put class files for all custom objects on the Infinispan server classpath.</p>
<div class="paragraph">
<p>Add JAR files that contain custom classes and/or service providers for
marshaller implementations in the <code>server/lib</code> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>├── server
│   ├── lib
│   │   ├── UserObjects.jar
│       └── README.txt</pre>
</div>
</div>
</li>
<li>
<p>Configure your clients.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are no changes required for Hot Rod clients. The only requirement is that the marshaller used in the client is available in the <code>server/lib</code> directory so Infinispan can de-serialize the objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ProtoStream and Java Serialization marshallers are already available on the
server.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>REST clients must use either JSON or XML so Infinispan can convert to and from
Java objects.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="../developing/developing.html#mediatype_override">Converting Data on Demand</a></p>
</li>
<li>
<p><a href="../developing/developing.html#protostream_cm_config">Using the ProtoStream Marshaller</a></p>
</li>
<li>
<p><a href="../developing/developing.html#">Marshalling Custom Java Objects with ProtoStream</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="data_encoding"><a class="anchor" href="#data_encoding"></a>4.7. Data Encoding</h3>
<div class="paragraph">
<p>Encoding is the data conversion operation done by Infinispan caches before storing data, and when reading back from storage.</p>
</div>
<div class="sect3">
<h4 id="overview"><a class="anchor" href="#overview"></a>4.7.1. Overview</h4>
<div class="paragraph">
<p>Encoding allows dealing with a certain data format during API calls (map, listeners, stream, etc) while the format effectively stored
is different.</p>
</div>
<div class="paragraph">
<p>The data conversions are handled by instances of <em>org.infinispan.commons.dataconversion.Encoder</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Encoder</span> {

   <span class="comment">/**
    * Convert data in the read/write format to the storage format.
    *
    * @param content data to be converted, never null.
    * @return Object in the storage format.
    */</span>
   <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content);

   <span class="comment">/**
    * Convert from storage format to the read/write format.
    *
    * @param content data as stored in the cache, never null.
    * @return data in the read/write format
    */</span>
   <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content);

   <span class="comment">/**
     * Returns the {@link MediaType} produced by this encoder or null if the storage format is not known.
     */</span>
   MediaType getStorageFormat();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default_encoders"><a class="anchor" href="#default_encoders"></a>4.7.2. Default encoders</h4>
<div class="paragraph">
<p>Infinispan automatically picks the Encoder depending on the cache configuration. The table below shows which internal Encoder is used for several configurations:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Encoder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded/Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IdentityEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passthrough encoder, no conversion done</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.OFF_HEAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GlobalMarshallerEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the Infinispan internal marshaller to convert to byte[]. May delegate to the configured marshaller in the cache manager.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.BINARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BinaryEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the Infinispan internal marshaller to convert to byte[], except for primitives and String.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">StorageType.OFF_HEAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IdentityEncoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store byte[]s directly as received by remote clients</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="overriding_programmatically"><a class="anchor" href="#overriding_programmatically"></a>4.7.3. Overriding programmatically</h4>
<div class="paragraph">
<p>It is possible to override programmatically the encoding used for both keys and values, by calling the <em>.withEncoding()</em> method variants from <em>AdvancedCache</em>.</p>
</div>
<div class="paragraph">
<p>Example, consider the following cache configured as OFF_HEAP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Read and write POJO, storage will be byte[] since for</span>
<span class="comment">// OFF_HEAP the GlobalMarshallerEncoder is used internally:</span>
cache.put(<span class="integer">1</span>, <span class="keyword">new</span> Pojo())
Pojo value = cache.get(<span class="integer">1</span>)

<span class="comment">// Get the content in its stored format by overriding</span>
<span class="comment">// the internal encoder with a no-op encoder (IdentityEncoder)</span>
Cache&lt;?,?&gt; rawContent = cache.getAdvancedCache().withEncoding(IdentityEncoder.class);
<span class="type">byte</span><span class="type">[]</span> marshalled = (<span class="type">byte</span><span class="type">[]</span>) rawContent.get(<span class="integer">1</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The override can be useful if any operation in the cache does not require decoding, such as counting number of entries,
or calculating the size of byte[] of an OFF_HEAP cache.</p>
</div>
</div>
<div class="sect3">
<h4 id="defining_custom_encoders"><a class="anchor" href="#defining_custom_encoders"></a>4.7.4. Defining Custom Encoders</h4>
<div class="paragraph">
<p>A custom encoder can be registered in the <em>EncoderRegistry</em>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Ensure that the registration is done in every node of the cluster, before starting the caches.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider a custom encoder used to compress/decompress with gzip:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GzipEncoder</span> <span class="directive">implements</span> <span class="predefined-type">Encoder</span> {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content) {
      <span class="keyword">assert</span> content <span class="keyword">instanceof</span> <span class="predefined-type">String</span>;
      <span class="keyword">return</span> compress(content.toString());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content) {
      <span class="keyword">assert</span> content <span class="keyword">instanceof</span> <span class="type">byte</span><span class="type">[]</span>;
      <span class="keyword">return</span> decompress((<span class="type">byte</span><span class="type">[]</span>) content);
   }

   <span class="directive">private</span> <span class="type">byte</span><span class="type">[]</span> compress(<span class="predefined-type">String</span> str) {
      <span class="keyword">try</span> (<span class="predefined-type">ByteArrayOutputStream</span> baos = <span class="keyword">new</span> <span class="predefined-type">ByteArrayOutputStream</span>();
           <span class="predefined-type">GZIPOutputStream</span> gis = <span class="keyword">new</span> <span class="predefined-type">GZIPOutputStream</span>(baos)) {
         gis.write(str.getBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>));
         gis.close();
         <span class="keyword">return</span> baos.toByteArray();
      } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unabled to compress</span><span class="delimiter">&quot;</span></span>, e);
      }
   }

   <span class="directive">private</span> <span class="predefined-type">String</span> decompress(<span class="type">byte</span><span class="type">[]</span> compressed) {
      <span class="keyword">try</span> (<span class="predefined-type">GZIPInputStream</span> gis = <span class="keyword">new</span> <span class="predefined-type">GZIPInputStream</span>(<span class="keyword">new</span> <span class="predefined-type">ByteArrayInputStream</span>(compressed));
           <span class="predefined-type">BufferedReader</span> bf = <span class="keyword">new</span> <span class="predefined-type">BufferedReader</span>(<span class="keyword">new</span> <span class="predefined-type">InputStreamReader</span>(gis, <span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span>))) {
         <span class="predefined-type">StringBuilder</span> result = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();
         <span class="predefined-type">String</span> line;
         <span class="keyword">while</span> ((line = bf.readLine()) != <span class="predefined-constant">null</span>) {
            result.append(line);
         }
         <span class="keyword">return</span> result.toString();
      } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to decompress</span><span class="delimiter">&quot;</span></span>, e);
      }
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> MediaType getStorageFormat() {
      <span class="keyword">return</span> MediaType.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/gzip</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> isStorageFormatFilterable() {
      <span class="keyword">return</span> <span class="predefined-constant">false</span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">short</span> id() {
      <span class="keyword">return</span> <span class="integer">10000</span>;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be registered by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalComponentRegistry registry = cacheManager.getGlobalComponentRegistry();
EncoderRegistry encoderRegistry = registry.getComponent(EncoderRegistry.class);
encoderRegistry.registerEncoder(<span class="keyword">new</span> GzipEncoder());</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then be used to write and read data from a cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

<span class="comment">// Decorate cache with the newly registered encoder, without encoding keys (IdentityEncoder)</span>
<span class="comment">// but compressing values</span>
AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; compressingCache = (AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;) cache.withEncoding(IdentityEncoder.class, GzipEncoder.class);

<span class="comment">// All values will be stored compressed...</span>
compressingCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">0412c789a37f5086f743255cfa693dd5</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// ... but API calls deals with String</span>
<span class="predefined-type">String</span> stringValue = compressingCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Bypassing the value encoder to obtain the value as it is stored</span>
<span class="predefined-type">Object</span> value = compressingCache.withEncoding(IdentityEncoder.class).get(<span class="string"><span class="delimiter">&quot;</span><span class="content">297931749</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// value is a byte[] which is the compressed value</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_transcoding"><a class="anchor" href="#data_transcoding"></a>4.8. Transcoders and Data Conversion</h3>
<div class="paragraph">
<p>Infinispan uses <code>org.infinispan.commons.dataconversion.Transcoder</code> to convert
data between MediaType formats.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Transcoder</span> {

   <span class="comment">/**
    * Transcodes content between two different {@link MediaType}.
    *
    * @param content         Content to transcode.
    * @param contentType     The {@link MediaType} of the content.
    * @param destinationType The target {@link MediaType} to convert.
    * @return the transcoded content.
    */</span>
   <span class="predefined-type">Object</span> transcode(<span class="predefined-type">Object</span> content, MediaType contentType, MediaType destinationType);

   <span class="comment">/**
    * @return all the {@link MediaType} handled by this Transcoder.
    */</span>
   <span class="predefined-type">Set</span>&lt;MediaType&gt; getSupportedMediaTypes();
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="mediatype_override"><a class="anchor" href="#mediatype_override"></a>4.8.1. Converting Data on Demand</h4>
<div class="paragraph">
<p>You can deploy and run custom code on Infinispan, such as tasks, listeners,
and merge policies. Custom code on Infinispan can directly access data but
must also interoperate with clients that access the same data through different
endpoints. For example, you can create tasks that handle custom objects while
Hot Rod clients read and write data in binary format.</p>
</div>
<div class="paragraph">
<p>In this case, you can configure <code>application/x-protostream</code> as the cache
encoding to store data in binary format then configure your custom code to
perform cache operations using a different MediaType.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager();

<span class="comment">// The cache will store POJO for keys and values</span>
ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().value().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>);

cacheManager.defineConfiguration(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>, cfg.build());

Cache&lt;<span class="predefined-type">Integer</span>, Person&gt; cache = cacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">mycache</span><span class="delimiter">&quot;</span></span>);

cache.put(<span class="integer">1</span>, <span class="keyword">new</span> Person(<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>));

<span class="comment">// Wraps cache using 'application/x-java-object' for keys but JSON for values</span>
Cache&lt;<span class="predefined-type">Integer</span>, <span class="type">byte</span><span class="type">[]</span>&gt; jsonValuesCache = (Cache&lt;<span class="predefined-type">Integer</span>, <span class="type">byte</span><span class="type">[]</span>&gt;) cache.getAdvancedCache().withMediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-java-object</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);

<span class="type">byte</span><span class="type">[]</span> json = jsonValuesCache.get(<span class="integer">1</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will return the value in JSON format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">_type</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.sample.Person</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">John</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="installing_transcoders_in_embedded_deloyments"><a class="anchor" href="#installing_transcoders_in_embedded_deloyments"></a>4.8.2. Installing Transcoders in Embedded Deloyments</h4>
<div class="paragraph">
<p>Infinispan Server includes transcoders by default. However, when running
Infinispan as a library, you must add the following to your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>org.infinispan:infinispan-server-core</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transcoders_and_encoders"><a class="anchor" href="#transcoders_and_encoders"></a>4.8.3. Transcoders and Encoders</h4>
<div class="paragraph">
<p>Usually there will be none or only one data conversion involved in a cache operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No conversion by default on caches using in embedded or server mode;</p>
</li>
<li>
<p><em>Encoder</em> based conversion for embedded caches without MediaType configured, but using OFF_HEAP or BINARY;</p>
</li>
<li>
<p><em>Transcoder</em> based conversion for caches used in server mode with multiple REST and Hot Rod clients sending
and receiving data in different formats. Those caches will have MediaType configured describing the storage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But it&#8217;s possible to have both encoders and transcoders being used simultaneously for advanced use cases.</p>
</div>
<div class="paragraph">
<p>Consider an example, a cache that stores marshalled objects (with jboss marshaller) content but for security reasons a transparent encryption layer should be added in order to avoid storing "plain" data to an external store.
Clients should be able to read and write data in multiple formats.</p>
</div>
<div class="paragraph">
<p>This can be achieved by configuring the cache with the the MediaType that describes the storage regardless of the encoding layer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder cfg = <span class="keyword">new</span> ConfigurationBuilder();
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span>);
cfg.encoding().key().mediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-jboss-marshalling</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transparent encryption can be added by decorating the cache with a special <em>Encoder</em> that encrypts/decrypts with storing/retrieving, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Scrambler</span> <span class="directive">implements</span> <span class="predefined-type">Encoder</span> {

   <span class="directive">public</span> <span class="predefined-type">Object</span> toStorage(<span class="predefined-type">Object</span> content) {
   <span class="comment">// Encrypt data</span>
   }

   <span class="directive">public</span> <span class="predefined-type">Object</span> fromStorage(<span class="predefined-type">Object</span> content) {
   <span class="comment">// Decrypt data</span>
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">boolean</span> isStorageFormatFilterable() {

   }

   <span class="directive">public</span> MediaType getStorageFormat() {
   <span class="keyword">return</span> <span class="keyword">new</span> MediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">scrambled</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">short</span> id() {
   <span class="comment">//return id</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make sure all data written to the cache will be stored encrypted, it&#8217;s necessary to decorate the cache with the Encoder above and perform all cache operations in this decorated cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;?,?&gt; secureStorageCache = cache.getAdvancedCache().withEncoding(Scrambler.class).put(k,v);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The capability of reading data in multiple formats can be added by decorating the cache with the desired MediaType:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Obtain a stream of values in XML format from the secure cache</span>
secureStorageCache.getAdvancedCache().withMediaType(<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">application/xml</span><span class="delimiter">&quot;</span></span>).values().stream();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Internally, Infinispan will first apply the encoder <em>fromStorage</em> operation to obtain the entries, that will be in "application/x-jboss-marshalling" format and then apply a successive conversion to "application/xml" by using the adequate Transcoder.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="marshalling"><a class="anchor" href="#marshalling"></a>5. Configuring Infinispan to Marshall Java Objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Marshalling converts Java objects into binary format so they can be transferred
over the wire or stored to disk. The reverse process, unmarshalling, transforms
data from binary format into Java objects.</p>
</div>
<div class="paragraph">
<p>Infinispan performs marshalling and unmarshalling to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Send data to other Infinispan nodes in a cluster.</p>
</li>
<li>
<p>Store data in persistent cache stores.</p>
</li>
<li>
<p>Store data in binary format to provide deserialization capabilities.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="protostream_types-configuring_marshalling"><a class="anchor" href="#protostream_types-configuring_marshalling"></a>5.1. Supported Types</h3>
<div class="paragraph">
<p>Infinispan uses a ProtoStream API to encode and decode Java objects into
Protocol Buffers (Protobuf); a language-neutral, backwards compatible format.</p>
</div>
<div class="paragraph">
<p>ProtoStream can handle the following types for keys and values, as well as the
unboxed equivalents in the case of primitive types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>byte[]</code></p>
</li>
<li>
<p><code>Byte</code></p>
</li>
<li>
<p><code>String</code></p>
</li>
<li>
<p><code>Integer</code></p>
</li>
<li>
<p><code>Long</code></p>
</li>
<li>
<p><code>Double</code></p>
</li>
<li>
<p><code>Float</code></p>
</li>
<li>
<p><code>Boolean</code></p>
</li>
<li>
<p><code>Short</code></p>
</li>
<li>
<p><code>Character</code></p>
</li>
<li>
<p><code>java.util.Date</code></p>
</li>
<li>
<p><code>java.time.Instant</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://github.com/infinispan/protostream">Infinispan ProtoStream library</a></p>
</li>
<li>
<p><a href="https://developers.google.com/protocol-buffers">Protocol Buffers</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="marshalling_user_types"><a class="anchor" href="#marshalling_user_types"></a>5.2. Marshalling User Types with ProtoStream</h3>
<div class="paragraph">
<p>User types are Java objects that Infinispan does not support out of the box.
To marshall user types, you implement the <code>SerializationContextInitializer</code>
interface to describe your Java objects so that the ProtoStream library can
encode them to Protobuf format and Infinispan can transmit and store them.</p>
</div>
<div class="sect3">
<h4 id="generating_protostream_sci-marshalling"><a class="anchor" href="#generating_protostream_sci-marshalling"></a>5.2.1. Generating Serialization Context Initializers</h4>
<div class="paragraph">
<p>A ProtoStream <code>SerializationContext</code> contains Protobuf type definitions for
custom Java objects, loaded from Protobuf schemas, and the accompanying
marshallers for those objects.</p>
</div>
<div class="paragraph">
<p>Infinispan provides a <code>protostream-processor</code> artifact that processes Java
annotations in your classes at compile time. The processor generates Protobuf
schemas, marshallers, and a concrete implementation of the
<code>SerializationContextInitializer</code> interface that you can use to initialize a
ProtoStream <code>SerializationContext</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, implementation names are the annotated class name with an "Impl"
suffix.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>protostream-processor</code> dependency to your <code>pom.xml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>infinispan-bom<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
      <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span>

<span class="tag">&lt;dependencies&gt;</span>
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan.protostream<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>protostream-processor<span class="tag">&lt;/artifactId&gt;</span>
    <span class="comment">&lt;!--
      This dependency should be declared in the &quot;provided&quot; scope or made &quot;optional&quot;
      because it is a compile-only dependency and is not required at runtime.
      Transitive propagation of this dependency should be also be avoided.
    --&gt;</span>
    <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Annotate the Java objects that you want to marshall with <code>@ProtoField</code> and <code>@ProtoFactory</code>.</p>
<div class="listingblock">
<div class="title">Author.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoField</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {
   <span class="annotation">@ProtoField</span>(number = <span class="integer">1</span>)
   <span class="directive">final</span> <span class="predefined-type">String</span> name;

   <span class="annotation">@ProtoField</span>(number = <span class="integer">2</span>)
   <span class="directive">final</span> <span class="predefined-type">String</span> surname;

   <span class="annotation">@ProtoFactory</span>
   Author(<span class="predefined-type">String</span> name, <span class="predefined-type">String</span> surname) {
      <span class="local-variable">this</span>.name = name;
      <span class="local-variable">this</span>.surname = surname;
   }
   <span class="comment">// public Getter methods omitted for brevity</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Book.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoField</span>;
...

public <span class="type">class</span> <span class="class">Book</span> {
   <span class="annotation">@ProtoField</span>(number = <span class="integer">1</span>)
   <span class="directive">final</span> <span class="predefined-type">String</span> title;

   <span class="annotation">@ProtoField</span>(number = <span class="integer">2</span>)
   <span class="directive">final</span> <span class="predefined-type">String</span> description;

   <span class="annotation">@ProtoField</span>(number = <span class="integer">3</span>, defaultValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">final</span> <span class="type">int</span> publicationYear;

   <span class="annotation">@ProtoField</span>(number = <span class="integer">4</span>, collectionImplementation = <span class="predefined-type">ArrayList</span>.class)
   <span class="directive">final</span> <span class="predefined-type">List</span>&lt;Author&gt; authors;

   <span class="annotation">@ProtoFactory</span>
   <span class="predefined-type">Book</span>(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> description, <span class="type">int</span> publicationYear, <span class="predefined-type">List</span>&lt;Author&gt; authors) {
      <span class="local-variable">this</span>.title = title;
      <span class="local-variable">this</span>.description = description;
      <span class="local-variable">this</span>.publicationYear = publicationYear;
      <span class="local-variable">this</span>.authors = authors;
   }
   <span class="comment">// public Getter methods omitted for brevity</span>
}</code></pre>
</div>
</div>
</li>
<li>
<p>Define an interface that extends <code>SerializationContextInitializer</code> and is annotated with <code>@AutoProtoSchemaBuilder</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@AutoProtoSchemaBuilder</span>(
      includeClasses = {
            <span class="predefined-type">Book</span>.class,
            Author.class,
      },
      schemaFileName = <span class="string"><span class="delimiter">&quot;</span><span class="content">library.proto</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="1"></i><b>(1)</b>
      schemaFilePath = <span class="string"><span class="delimiter">&quot;</span><span class="content">proto/</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="2"></i><b>(2)</b>
      schemaPackageName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample</span><span class="delimiter">&quot;</span></span>)
<span class="type">interface</span> <span class="class">LibraryInitializer</span> <span class="directive">extends</span> SerializationContextInitializer {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Names the generated <code>.proto</code> schema file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sets the path under <code>target/classes</code> where the schema file is generated.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>Add the <code>SerializationContextInitializer</code> implementation to your Infinispan
configuration to register it.</p>
</div>
<div class="paragraph">
<p>See <a href="#registering_sci-marshalling">Registering Serialization Context Initializers</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="implementing_proto_marshallers"><a class="anchor" href="#implementing_proto_marshallers"></a>5.2.2. Manually Implementing Serialization Context Initializers</h4>
<div class="paragraph">
<p>In some cases you might need to manually define Protobuf schemas and implement
ProtoStream marshallers. For example, if you cannot modify Java object classes
to add annotations.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a Protobuf schema, <code>.proto</code> file, that provides a structured
representations of the Java objects to marshall.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="proto">package book_sample;

message Book {
    optional string title = 1;
    optional string description = 2;
    optional int32 publicationYear = 3; // no native Date type available in Protobuf

    repeated Author authors = 4;
}

message Author {
    optional string name = 1;
    optional string surname = 2;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding <code>.library.proto</code> file defines an entity (Protobuf message type)
named <em>Book</em> that is contained in the <em>book_sample</em> package. <em>Book</em> declares
several fields of primitive types and an array (Protobuf repeatable field)
named <em>authors</em>, which is the <em>Author</em> message type.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can nest messages but the resulting structure is strictly a tree, never a graph.</p>
</li>
<li>
<p>Type inheritance is not possible.</p>
</li>
<li>
<p>Collections are not supported but you can emulate arrays with repeated fields.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Use the <code>org.infinispan.protostream.MessageMarshaller</code> interface to implement
marshallers for your classes.</p>
<div class="listingblock">
<div class="title">BookMarshaller.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.MessageMarshaller</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BookMarshaller</span> <span class="directive">implements</span> MessageMarshaller&lt;<span class="predefined-type">Book</span>&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getTypeName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample.Book</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Book</span>&gt; getJavaClass() {
      <span class="keyword">return</span> <span class="predefined-type">Book</span>.class;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> writeTo(MessageMarshaller.ProtoStreamWriter writer, <span class="predefined-type">Book</span> book) <span class="directive">throws</span> <span class="exception">IOException</span> {
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, book.getTitle());
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, book.getDescription());
      writer.writeInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, book.getPublicationYear());
      writer.writeCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, book.getAuthors(), Author.class);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Book</span> readFrom(MessageMarshaller.ProtoStreamReader reader) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="predefined-type">String</span> title = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">String</span> description = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>);
      <span class="type">int</span> publicationYear = reader.readInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">List</span>&lt;Author&gt; authors = reader.readCollection(<span class="string"><span class="delimiter">&quot;</span><span class="content">authors</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(), Author.class);
      <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Book</span>(title, description, publicationYear, authors);
   }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">AuthorMarshaller.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.MessageMarshaller</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">AuthorMarshaller</span> <span class="directive">implements</span> MessageMarshaller&lt;Author&gt; {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getTypeName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample.Author</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> Author&gt; getJavaClass() {
      <span class="keyword">return</span> Author.class;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> writeTo(MessageMarshaller.ProtoStreamWriter writer, Author author) <span class="directive">throws</span> <span class="exception">IOException</span> {
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, author.getName());
      writer.writeString(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, author.getSurname());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> Author readFrom(MessageMarshaller.ProtoStreamReader reader) <span class="directive">throws</span> <span class="exception">IOException</span> {
      <span class="predefined-type">String</span> name = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">String</span> surname = reader.readString(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>);
      <span class="keyword">return</span> <span class="keyword">new</span> Author(name, surname);
   }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <code>SerializationContextInitializer</code> implementation that registers the
<code>.proto</code> schema and the ProtoStream marshaller implementations with a
<code>SerializationContext</code>.</p>
<div class="listingblock">
<div class="title">ManualSerializationContextInitializer.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.FileDescriptorSource</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.SerializationContext</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.SerializationContextInitializer</span>;
...

public <span class="type">class</span> <span class="class">ManualSerializationContextInitializer</span> <span class="directive">implements</span> SerializationContextInitializer {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getProtoFileName() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">library.proto</span><span class="delimiter">&quot;</span></span>;
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> getProtoFile() <span class="directive">throws</span> UncheckedIOException {
      <span class="comment">// Assumes that the file is located in a Jar's resources, we must provide the path to the library.proto file</span>
      <span class="keyword">return</span> FileDescriptorSource.getResourceAsString(getClass(), <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> + getProtoFileName());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> registerSchema(SerializationContext serCtx) {
      serCtx.registerProtoFiles(FileDescriptorSource.fromString(getProtoFileName(), getProtoFile()));
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> registerMarshallers(SerializationContext serCtx) {
      serCtx.registerMarshaller(<span class="keyword">new</span> AuthorMarshaller());
      serCtx.registerMarshaller(<span class="keyword">new</span> BookMarshaller());
   }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Next steps</div>
<p>Add the <code>SerializationContextInitializer</code> implementation to your Infinispan
configuration to register it.</p>
</div>
<div class="paragraph">
<p>See <a href="#registering_sci-marshalling">Registering Serialization Context Initializers</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="registering_sci-marshalling"><a class="anchor" href="#registering_sci-marshalling"></a>5.2.3. Registering Serialization Context Initializers</h4>
<div class="paragraph">
<p>Declare <code>SerializationContextInitializer</code> implementations in your
Infinispan configuration to register them.</p>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Manually register <code>SerializationContextInitializer</code> implementations either programmatically or declaratively, as in the following examples:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Programmatic configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = <span class="keyword">new</span> GlobalConfigurationBuilder();
builder.serialization()
       .addContextInitializers(<span class="keyword">new</span> LibraryInitializerImpl(), <span class="keyword">new</span> SCIImpl());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Declarative configuration</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;serialization&gt;</span>
    <span class="tag">&lt;context-initializer</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.example.LibraryInitializerImpl</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;context-initializer</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.example.another.SCIImpl</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/serialization&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="marshaller_implementations"><a class="anchor" href="#marshaller_implementations"></a>5.3. Configuring Alternative Marshaller Implementations</h3>
<div class="paragraph">
<p>Infinispan provides Marshaller implementations that you can use instead of
ProtoStream. You can also configure Infinispan to use custom marshaller
implementations.</p>
</div>
<div class="sect3">
<h4 id="jboss_marshalling"><a class="anchor" href="#jboss_marshalling"></a>5.3.1. Using JBoss Marshalling</h4>
<div class="paragraph">
<p>JBoss Marshalling is a serialization-based marshalling library and was the
default marshaller in previous Infinispan versions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>You should not use serialization-based marshalling with Infinispan. Instead
you should use Protostream, which is a high-performance binary wire format that
ensures backwards compatibility.</p>
</li>
<li>
<p>JBoss Marshalling and the <code>AdvancedExternalizer</code> interface are deprecated and
will be removed in a future release. However, Infinispan ignores
<code>AdvancedExternalizer</code> implementations when persisting data unless you use
JBoss Marshalling.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>infinispan-jboss-marshalling</code> dependency to your classpath.</p>
</li>
<li>
<p>Configure Infinispan to use the <code>JBossUserMarshaller</code>.</p>
</li>
<li>
<p>Add your Java classes to the deserialization allowlist.</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = <span class="keyword">new</span> GlobalConfigurationBuilder();
builder.serialization().marshaller(<span class="keyword">new</span> JBossUserMarshaller());</code></pre>
</div>
</div>
</li>
<li>
<p>Declaratively:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;serialization</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.jboss.marshalling.core.JBossUserMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#deserialization_whitelist">Adding Java Classes to Deserialization White Lists</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/AdvancedExternalizer.html">AdvancedExternalizer</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="java_serialization"><a class="anchor" href="#java_serialization"></a>5.3.2. Using Java Serialization</h4>
<div class="paragraph">
<p>You can use Java serialization with Infinispan to marshall your objects, but
only if your Java objects implement the Java <code>Serializable</code> interface.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure Infinispan to use <code>JavaSerializationMarshaller</code> as the marshaller.</p>
</li>
<li>
<p>Add your Java classes to the deserialization allowlist.</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = <span class="keyword">new</span> GlobalConfigurationBuilder();
builder.serialization()
       .marshaller(<span class="keyword">new</span> JavaSerializationMarshaller())
       .whiteList()
       .addRegexps(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.example.</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.concrete.SomeClass</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</li>
<li>
<p>Declaratively:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;serialization</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.commons.marshall.JavaSerializationMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;white-list&gt;</span>
        <span class="tag">&lt;class&gt;</span>org.infinispan.concrete.SomeClass<span class="tag">&lt;/class&gt;</span>
        <span class="tag">&lt;regex&gt;</span>org.infinispan.example.*<span class="tag">&lt;/regex&gt;</span>
    <span class="tag">&lt;/white-list&gt;</span>
<span class="tag">&lt;/serialization&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#deserialization_whitelist">Adding Java Classes to Deserialization White Lists</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html">Serializable</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/JavaSerializationMarshaller.html">org.infinispan.commons.marshall.JavaSerializationMarshaller</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="kryo_marshalling"><a class="anchor" href="#kryo_marshalling"></a>5.3.3. Using the Kryo Marshaller</h4>
<div class="paragraph">
<p>Infinispan provides a marshalling implementation that uses Kryo libraries.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites for Infinispan Servers</div>
<p>To use Kryo marshalling with Infinispan servers, add a JAR that includes the
runtime class files for the Kryo marshalling implementation as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the
<a href="http://central.maven.org/maven2/org/infinispan/infinispan-marshaller-kryo-bundle/11.0/infinispan-marshaller-kryo-bundle-11.0.jar">Kryo Bundle</a>.</p>
</li>
<li>
<p>Add the JAR file to the <code>server/lib</code> directory in your Infinispan server installation directory.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Prerequisites for Infinispan Library Mode</div>
<p>To use Kryo marshalling with Infinispan as an embedded library in your application, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the <code>infinispan-marshaller-kryo</code> dependency to your <code>pom.xml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-marshaller-kryo<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Specify the <code>org.infinispan.marshaller.kryo.KryoMarshaller</code> class as the
marshaller.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = <span class="keyword">new</span> GlobalConfigurationBuilder();
builder.serialization()
       .marshaller(<span class="keyword">new</span> org.infinispan.marshaller.kryo.KryoMarshaller());</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Implement a service provider for the <code>SerializerRegistryService.java</code> interface.</p>
</li>
<li>
<p>Place all serializer registrations in the <code>register(Kryo)</code> method; where
serializers are registered with the supplied <code>Kryo</code> object using the Kryo API,
for example:</p>
<div class="listingblock">
<div class="content">
<pre>kryo.register(ExampleObject.class, new ExampleObjectSerializer())</pre>
</div>
</div>
</li>
<li>
<p>Specify the full path of implementing classes in your deployment JAR file within:</p>
<div class="listingblock">
<div class="content">
<pre>META-INF/services/org/infinispan/marshaller/kryo/SerializerRegistryService</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#deserialization_allowlist-marshallers">Adding Java Classes to Deserialization Allow Lists</a></p>
</li>
<li>
<p><a href="https://github.com/EsotericSoftware/kryo">Kryo on GitHub</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="protostuff_marshalling"><a class="anchor" href="#protostuff_marshalling"></a>5.3.4. Using the Protostuff Marshaller</h4>
<div class="paragraph">
<p>Infinispan provides a marshalling implementation that uses Protostuff
libraries.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites for Infinispan Servers</div>
<p>To use Protostuff marshalling with Infinispan servers, add a JAR that includes
the runtime class files for the Protostuff marshalling implementation as
follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the
<a href="http://central.maven.org/maven2/org/infinispan/infinispan-marshaller-protostuff-bundle/11.0/infinispan-marshaller-protostuff-bundle-11.0.jar">Protostuff Bundle JAR</a>.</p>
</li>
<li>
<p>Add the JAR file to the <code>server/lib</code> directory in your Infinispan server installation directory.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Prerequisites for Infinispan Library Mode</div>
<p>To use Protostuff marshalling with Infinispan as an embedded library in your application, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the <code>infinispan-marshaller-protostuff</code> dependency to your <code>pom.xml</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-marshaller-protostuff<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${version.infinispan}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Specify the <code>org.infinispan.marshaller.protostuff.ProtostuffMarshaller</code> class
as the marshaller.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = <span class="keyword">new</span> GlobalConfigurationBuilder();
builder.serialization()
       .marshaller(<span class="keyword">new</span> org.infinispan.marshaller.protostuff.ProtostuffMarshaller());</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Do one of the following to register custom Protostuff schemas for object
marshalling:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Call the <code>register()</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">RuntimeSchema.register(ExampleObject.class, <span class="keyword">new</span> ExampleObjectSchema());</code></pre>
</div>
</div>
</li>
<li>
<p>Implement a service provider for the <code>SerializerRegistryService.java</code> interface that places all schema registrations in the <code>register()</code> method.</p>
<div class="paragraph">
<p>You should then specify the full path of implementing classes in your deployment JAR file within:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>META-INF/services/org/infinispan/marshaller/protostuff/SchemaRegistryService</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="#deserialization_allowlist-marshallers">Adding Java Classes to Deserialization Allow Lists</a></p>
</li>
<li>
<p><a href="https://github.com/protostuff/protostuff">Protostuff on GitHub</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="custom_marshallers"><a class="anchor" href="#custom_marshallers"></a>5.3.5. Using Custom Marshallers</h4>
<div class="paragraph">
<p>Infinispan provides a <code>Marshaller</code> interface that you can implement for custom marshallers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Implement the <code>Marshaller</code> interface.</p>
</li>
<li>
<p>Configure Infinispan to use your marshaller.</p>
</li>
<li>
<p>Add your Java classes to the deserialization allowlist.</p>
<div class="ulist">
<ul>
<li>
<p>Programmatically:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder builder = <span class="keyword">new</span> GlobalConfigurationBuilder();
builder.serialization()
      .marshaller(<span class="keyword">new</span> org.infinispan.example.marshall.CustomMarshaller())
      .whiteList().addRegexp(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.example.*</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</li>
<li>
<p>Declaratively:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;serialization</span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.example.marshall.CustomMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;white-list&gt;</span>
        <span class="tag">&lt;class&gt;</span>org.infinispan.concrete.SomeClass<span class="tag">&lt;/class&gt;</span>
        <span class="tag">&lt;regex&gt;</span>org.infinispan.example.*<span class="tag">&lt;/regex&gt;</span>
    <span class="tag">&lt;/white-list&gt;</span>
<span class="tag">&lt;/serialization&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom marshaller implementations can access a configured white list via the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/Marshaller.html#initialize(org.infinispan.commons.configuration.ClassWhiteList)">initialize()</a> method, which is called during startup.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/Marshaller.html">org.infinispan.commons.marshall.Marshaller</a></p>
</li>
<li>
<p><a href="#deserialization_allowlist-marshallers">Adding Java Classes to Deserialization Allow Lists</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="deserialization_whitelist"><a class="anchor" href="#deserialization_whitelist"></a>5.3.6. Adding Java Classes to Deserialization White Lists</h4>
<div class="paragraph">
<p>Infinispan does not allow deserialization of arbritrary Java classes for
security reasons, which applies to JSON, XML, and marshalled <code>byte[]</code> content.</p>
</div>
<div class="paragraph">
<p>You must add Java classes to a deserialization white list, either using system
properties or specifying them in the Infinispan configuration.</p>
</div>
<div class="listingblock">
<div class="title">System properties</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code>// Specify a comma-separated list of fully qualified class names
-Dinfinispan.deserialization.whitelist.classes=java.time.Instant,com.myclass.Entity

// Specify a regular expression to match classes
-Dinfinispan.deserialization.whitelist.regexps=.*</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Declarative</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;cache-container&gt;</span>
   <span class="tag">&lt;serialization</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">marshaller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.marshall.TestObjectStreamMarshaller</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;white-list&gt;</span>
         <span class="tag">&lt;class&gt;</span>org.infinispan.test.data.Person<span class="tag">&lt;/class&gt;</span>
         <span class="tag">&lt;regex&gt;</span>org.infinispan.test.data.*<span class="tag">&lt;/regex&gt;</span>
       <span class="tag">&lt;/white-list&gt;</span>
   <span class="tag">&lt;/serialization&gt;</span>
<span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Java classes that you add to the deserialization whitelist apply to the
Infinispan <code>CacheContainer</code> and can be deserialized by all caches that the
<code>CacheContainer</code> controls.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered_locks"><a class="anchor" href="#clustered_locks"></a>6. Clustered Locks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clustered locks are data structures that are distributed and shared across
nodes in a Infinispan cluster. Clustered locks allow you to run code that is
synchronized between nodes.</p>
</div>
<div class="sect2">
<h3 id="lock_api-locking"><a class="anchor" href="#lock_api-locking"></a>6.1. Lock API</h3>
<div class="paragraph">
<p>Infinispan provides a <code>ClusteredLock</code> API that lets you concurrently execute
code on a cluster when using Infinispan in embedded mode.</p>
</div>
<div class="paragraph">
<p>The API consists of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClusteredLock</code> exposes methods to implement clustered locks.</p>
</li>
<li>
<p><code>ClusteredLockManager</code> exposes methods to define, configure, retrieve, and remove clustered locks.</p>
</li>
<li>
<p><code>EmbeddedClusteredLockManagerFactory</code> initializes <code>ClusteredLockManager</code> implementations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Ownership</div>
<p>Infinispan supports <code>NODE</code> ownership so that all nodes in a cluster can use a
lock.</p>
</div>
<div class="paragraph">
<div class="title">Reentrancy</div>
<p>Infinispan clustered locks are non-reentrant so any node in the cluster can
acquire a lock but only the node that creates the lock can release it.</p>
</div>
<div class="paragraph">
<p>If two consecutive lock calls are sent for the same owner, the first call
acquires the lock if it is available and the second call is blocked.</p>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/lock/EmbeddedClusteredLockManagerFactory.html">EmbeddedClusteredLockManagerFactory</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/lock/api/ClusteredLockManager.html">ClusteredLockManager</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/lock/api/ClusteredLock.html">ClusteredLock</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using_clustered_locks-locking"><a class="anchor" href="#using_clustered_locks-locking"></a>6.2. Using Clustered Locks</h3>
<div class="paragraph">
<p>Learn how to use clustered locks with Infinispan embedded in your application.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Add the <code>infinispan-clustered-lock</code> dependency to your <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>infinispan-clustered-lock<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Initialize the <code>ClusteredLockManager</code> interface from a Cache Manager. This interface is the entry point for defining, retrieving, and removing clustered locks.</p>
</li>
<li>
<p>Give a unique name for each clustered lock.</p>
</li>
<li>
<p>Acquire locks with the <code>lock.tryLock(1, TimeUnit.SECONDS)</code> method.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Set up a clustered Cache Manager.</span>
GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder();

<span class="comment">// Configure the cache mode, in this case it is distributed and synchronous.</span>
ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.clustering().cacheMode(CacheMode.DIST_SYNC);

<span class="comment">// Initialize a new default Cache Manager.</span>
DefaultCacheManager cm = <span class="keyword">new</span> DefaultCacheManager(global.build(), builder.build());

<span class="comment">// Initialize a Clustered Lock Manager.</span>
ClusteredLockManager clm1 = EmbeddedClusteredLockManagerFactory.from(cm);

<span class="comment">// Define a clustered lock named 'lock'.</span>
clm1.defineLock(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Get a lock from each node in the cluster.</span>
ClusteredLock lock = clm1.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">AtomicInteger</span> counter = <span class="keyword">new</span> <span class="predefined-type">AtomicInteger</span>(<span class="integer">0</span>);

<span class="comment">// Acquire the lock as follows.</span>
<span class="comment">// Each 'lock.tryLock(1, TimeUnit.SECONDS)' method attempts to acquire the lock.</span>
<span class="comment">// If the lock is not available, the method waits for the timeout period to elapse. When the lock is acquired, other calls to acquire the lock are blocked until the lock is released.</span>
CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; call1 = lock.tryLock(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS).whenComplete((r, ex) -&gt; {
    <span class="keyword">if</span> (r) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock is acquired by the call 1</span><span class="delimiter">&quot;</span></span>);
        lock.unlock().whenComplete((nil, ex2) -&gt; {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock is released by the call 1</span><span class="delimiter">&quot;</span></span>);
            counter.incrementAndGet();
        });
    }
});

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; call2 = lock.tryLock(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS).whenComplete((r, ex) -&gt; {
    <span class="keyword">if</span> (r) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock is acquired by the call 2</span><span class="delimiter">&quot;</span></span>);
        lock.unlock().whenComplete((nil, ex2) -&gt; {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock is released by the call 2</span><span class="delimiter">&quot;</span></span>);
            counter.incrementAndGet();
        });
    }
});

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; call3 = lock.tryLock(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.SECONDS).whenComplete((r, ex) -&gt; {
    <span class="keyword">if</span> (r) {
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock is acquired by the call 3</span><span class="delimiter">&quot;</span></span>);
        lock.unlock().whenComplete((nil, ex2) -&gt; {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock is released by the call 3</span><span class="delimiter">&quot;</span></span>);
            counter.incrementAndGet();
        });
    }
});

CompletableFuture.allOf(call1, call2, call3).whenComplete((r, ex) -&gt; {
    <span class="comment">// Print the value of the counter.</span>
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Value of the counter is </span><span class="delimiter">&quot;</span></span> + counter.get());

    <span class="comment">// Stop the Cache Manager.</span>
    cm.stop();
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring_clustered_locks-locking"><a class="anchor" href="#configuring_clustered_locks-locking"></a>6.3. Configuring Internal Caches for Locks</h3>
<div class="paragraph">
<p>Clustered Lock Managers include an internal cache that stores lock state. You
can configure the internal cache either declaratively or programmatically.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Define the number of nodes in the cluster that store the state of clustered locks. The default value is <code>-1</code>, which replicates the value to all nodes.</p>
</li>
<li>
<p>Specify one of the following values for the cache reliability, which controls how clustered locks behave when clusters split into partitions or multiple nodes leave:</p>
<div class="ulist">
<ul>
<li>
<p><code>AVAILABLE</code>: Nodes in any partition can concurrently operate on locks.</p>
</li>
<li>
<p><code>CONSISTENT</code>: Only nodes that belong to the majority partition can operate on locks. This is the default value.</p>
</li>
<li>
<p>Programmatic configuration</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.lock.configuration.ClusteredLockManagerConfiguration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.lock.configuration.ClusteredLockManagerConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.lock.configuration.Reliability</span>;
...

GlobalConfigurationBuilder global = GlobalConfigurationBuilder.defaultClusteredBuilder();

<span class="directive">final</span> ClusteredLockManagerConfiguration config = global.addModule(ClusteredLockManagerConfigurationBuilder.class).numOwner(<span class="integer">2</span>).reliability(Reliability.AVAILABLE).create();

DefaultCacheManager cm = <span class="keyword">new</span> DefaultCacheManager(global.build());

ClusteredLockManager clm1 = EmbeddedClusteredLockManagerFactory.from(cm);

clm1.defineLock(<span class="string"><span class="delimiter">&quot;</span><span class="content">lock</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</li>
<li>
<p>Declarative configuration</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;infinispan</span>
        <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:11.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;transport</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>

        <span class="tag">&lt;clustered-locks</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:clustered-locks:11.0</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">num-owners</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">reliability</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AVAILABLE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;clustered-lock</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lock1</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;clustered-lock</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lock2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/clustered-locks&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
    ...
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Reference</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/lock/configuration/ClusteredLockManagerConfiguration.html">ClusteredLockManagerConfiguration</a></p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/configdocs/infinispan-clustered-locks-config-infinispan-clustered-locks-config-12.0.html.html">Clustered Locks Configuration Schema</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clustered_counters"><a class="anchor" href="#clustered_counters"></a>7. Clustered Counters</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Clustered counters</em> are counters which are distributed and shared among all nodes in the Infinispan cluster.
Counters can have different consistency levels: strong and weak.</p>
</div>
<div class="paragraph">
<p>Although a strong/weak consistent counter has separate interfaces, both support updating its value,
return the current value and they provide events when its value is updated.
Details are provided below in this document to help you choose which one fits best your uses-case.</p>
</div>
<div class="sect2">
<h3 id="installation_and_configuration"><a class="anchor" href="#installation_and_configuration"></a>7.1. Installation and Configuration</h3>
<div class="paragraph">
<p>In order to start using the counters, you needs to add the dependency in your Maven <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-clustered-counter<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The counters can be configured Infinispan configuration file or on-demand via the <code>CounterManager</code> interface detailed
later in this document.
A counters configured in Infinispan configuration file is created at boot time when the <code>EmbeddedCacheManager</code> is starting.
Theses counters are started eagerly and they are available in all the cluster&#8217;s nodes.</p>
</div>
<div class="listingblock">
<div class="title">configuration.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
        <span class="comment">&lt;!-- if needed to persist counter, global state needs to be configured --&gt;</span>
        <span class="tag">&lt;global-state&gt;</span>
            ...
        <span class="tag">&lt;/global-state&gt;</span>
        <span class="comment">&lt;!-- your caches configuration goes here --&gt;</span>
         <span class="tag">&lt;counters</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:infinispan:config:counters:11.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">num-owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">reliability</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">CONSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VOLATILE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;lower-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;upper-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;strong-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VOLATILE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;lower-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                 <span class="tag">&lt;upper-bound</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;/strong-counter&gt;</span>
             <span class="tag">&lt;weak-counter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">initial-value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">storage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENT</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/counters&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically, in the <code>GlobalConfigurationBuilder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GlobalConfigurationBuilder globalConfigurationBuilder = ...;
CounterManagerConfigurationBuilder builder = globalConfigurationBuilder.addModule(CounterManagerConfigurationBuilder.class);
builder.numOwner(<span class="integer">3</span>).reliability(Reliability.CONSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">1</span>).storage(Storage.PERSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">2</span>).lowerBound(<span class="integer">0</span>).storage(Storage.VOLATILE);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">3</span>).upperBound(<span class="integer">5</span>).storage(Storage.PERSISTENT);
builder.addStrongCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">4</span>).lowerBound(<span class="integer">0</span>).upperBound(<span class="integer">10</span>).storage(Storage.VOLATILE);
builder.addWeakCounter().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">c5</span><span class="delimiter">&quot;</span></span>).initialValue(<span class="integer">5</span>).concurrencyLevel(<span class="integer">1</span>).storage(Storage.PERSISTENT);</code></pre>
</div>
</div>
<div class="paragraph">
<p>On other hand, the counters can be configured on-demand, at any time after the <code>EmbeddedCacheManager</code> is initialized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager manager = ...;
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c1</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.UNBOUNDED_STRONG).initialValue(<span class="integer">1</span>).storage(Storage.PERSISTENT).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">2</span>).lowerBound(<span class="integer">0</span>).storage(Storage.VOLATILE).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c3</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">3</span>).upperBound(<span class="integer">5</span>).storage(Storage.PERSISTENT).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c4</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.BOUNDED_STRONG).initialValue(<span class="integer">4</span>).lowerBound(<span class="integer">0</span>).upperBound(<span class="integer">10</span>).storage(Storage.VOLATILE).build());
manager.defineCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">c2</span><span class="delimiter">&quot;</span></span>, CounterConfiguration.builder(CounterType.WEAK).initialValue(<span class="integer">5</span>).concurrencyLevel(<span class="integer">1</span>).storage(Storage.PERSISTENT).build());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>CounterConfiguration</code> is immutable and can be reused.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The method <code>defineCounter()</code> will return <code>true</code> if the counter is successful configured or <code>false</code> otherwise.
However, if the configuration is invalid, the method will throw a <code>CounterConfigurationException</code>.
To find out if a counter is already defined, use the method <code>isDefined()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager manager = ...
if (!manager.isDefined(<span class="string"><span class="delimiter">&quot;</span><span class="content">someCounter</span><span class="delimiter">&quot;</span></span>)) {
    manager.define(<span class="string"><span class="delimiter">&quot;</span><span class="content">someCounter</span><span class="delimiter">&quot;</span></span>, ...);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Per cluster attributes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>num-owners</code>: Sets the number of counter&#8217;s copies to keep cluster-wide.
A smaller number will make update operations faster but will support a lower number of server crashes.
It <strong>must be positive</strong> and its default value is <code>2</code>.</p>
</li>
<li>
<p><code>reliability</code>: Sets the counter&#8217;s update behavior in a network partition.
Default value is <code>AVAILABLE</code> and valid values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>AVAILABLE</code>: all partitions are able to read and update the counter&#8217;s value.</p>
</li>
<li>
<p><code>CONSISTENT</code>: only the primary partition (majority of nodes) will be able to read and update the counter&#8217;s value.
The remaining partitions can only read its value.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Per counter attributes:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial-value</code> [common]: Sets the counter&#8217;s initial value.
Default is <code>0</code> (zero).</p>
</li>
<li>
<p><code>storage</code> [common]: Sets the counter&#8217;s behavior when the cluster is shutdown and restarted.
Default value is <code>VOLATILE</code> and valid values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>VOLATILE</code>: the counter&#8217;s value is only available in memory.
The value will be lost when a cluster is shutdown.</p>
</li>
<li>
<p><code>PERSISTENT</code>: the counter&#8217;s value is stored in a private and local persistent store.
The value is kept when the cluster is shutdown and restored after a restart.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On-demand and <code>VOLATILE</code> counters will lose its value and configuration after a cluster shutdown.
They must be defined again after the restart.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lower-bound</code> [strong]: Sets the strong consistent counter&#8217;s lower bound.
Default value is <code>Long.MIN_VALUE</code>.</p>
</li>
<li>
<p><code>upper-bound</code> [strong]: Sets the strong consistent counter&#8217;s upper bound.
Default value is <code>Long.MAX_VALUE</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If neither the <code>lower-bound</code> or <code>upper-bound</code> are configured, the strong counter is set as unbounded.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>initial-value</code> must be between <code>lower-bound</code> and <code>upper-bound</code> inclusive.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>concurrency-level</code> [weak]: Sets the number of concurrent updates.
Its value <strong>must be positive</strong> and the default value is <code>16</code>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="list_counter_names"><a class="anchor" href="#list_counter_names"></a>7.1.1. List counter names</h4>
<div class="paragraph">
<p>To list all the counters defined, the method <code>CounterManager.getCounterNames()</code> returns a collection of all counter
names created cluster-wide.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the_countermanager_interface"><a class="anchor" href="#the_countermanager_interface"></a>7.2. The <code>CounterManager</code> interface.</h3>
<div class="paragraph">
<p>The <code>CounterManager</code> interface is the entry point to define, retrieve and remove a counter.
It automatically listen to the creation of <code>EmbeddedCacheManager</code> and proceeds with the registration  of an
instance of it per <code>EmbeddedCacheManager</code>.
It starts the caches needed to store the counter state and configures the default counters.</p>
</div>
<div class="paragraph">
<p>Retrieving the <code>CounterManager</code> is as simple as invoke the
<code>EmbeddedCounterManagerFactory.asCounterManager(EmbeddedCacheManager)</code>
as shown in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager manager = ...;

<span class="comment">// retrieve the CounterManager</span>
CounterManager counterManager = EmbeddedCounterManagerFactory.asCounterManager(manager);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Hot Rod client, the <code>CounterManager</code> is registered in the RemoteCacheManager and it can be retrieved like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your RemoteCacheManager</span>
RemoteCacheManager manager = ...;

<span class="comment">// retrieve the CounterManager</span>
CounterManager counterManager = RemoteCounterManagerFactory.asCounterManager(manager);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="remove_a_counter_via_countermanager"><a class="anchor" href="#remove_a_counter_via_countermanager"></a>7.2.1. Remove a counter via CounterManager</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
use with caution.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is a difference between remove a counter via the <code>Strong/WeakCounter</code> interfaces and the <code>CounterManager</code>.
The <code>CounterManager.remove(String)</code> removes the counter value from the cluster and removes all the listeners registered
in the counter in the local counter instance.
In addition, the counter instance is no longer reusable and it may return an invalid results.</p>
</div>
<div class="paragraph">
<p>On the other side, the <code>Strong/WeakCounter</code> removal only removes the counter value.
The instance can still be reused and the listeners still works.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed after a removal.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the_counter"><a class="anchor" href="#the_counter"></a>7.3. The Counter</h3>
<div class="paragraph">
<p>A counter can be strong (<code>StrongCounter</code>) or weakly consistent (<code>WeakCounter</code>) and both is identified by a name.
They have a specific interface but they share some logic, namely, both of them are asynchronous
( a <code>CompletableFuture</code> is returned by each operation), provide an update event and can be reset to its initial value.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to use the async API, it is possible to return a synchronous counter via <code>sync()</code> method.
The API is the same but without the <code>CompletableFuture</code> return value.</p>
</div>
<div class="paragraph">
<p>The following methods are common to both interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> getName();
CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; getValue();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; reset();
&lt;T <span class="directive">extends</span> CounterListener&gt; Handle&lt;T&gt; addListener(T listener);
CounterConfiguration getConfiguration();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove();
SyncStrongCounter sync(); <span class="comment">//SyncWeakCounter for WeakCounter</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getName()</code> returns the counter name (identifier).</p>
</li>
<li>
<p><code>getValue()</code> returns the current counter&#8217;s value.</p>
</li>
<li>
<p><code>reset()</code> allows to reset the counter&#8217;s value to its initial value.</p>
</li>
<li>
<p><code>addListener()</code> register a listener to receive update events.
More details about it in the <a href="#clustered_counters_notify_events">Notification and Events</a> section.</p>
</li>
<li>
<p><code>getConfiguration()</code> returns the configuration used by the counter.</p>
</li>
<li>
<p><code>remove()</code> removes the counter value from the cluster. The instance can still be used and the listeners are kept.</p>
</li>
<li>
<p><code>sync()</code> creates a synchronous counter.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The counter is re-created if it is accessed after a removal.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="the_strongcounter_interface_when_the_consistency_or_bounds_matters"><a class="anchor" href="#the_strongcounter_interface_when_the_consistency_or_bounds_matters"></a>7.3.1. The <code>StrongCounter</code> interface: when the consistency or bounds matters.</h4>
<div class="paragraph">
<p>The strong counter provides uses a single key stored in Infinispan cache to provide the consistency needed.
All the updates are performed under the key lock to updates its values.
On other hand, the reads don&#8217;t acquire any locks and reads the current value.
Also, with this scheme, it allows to bound the counter value and provide atomic operations like compare-and-set/swap.</p>
</div>
<div class="paragraph">
<p>A <code>StrongCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getStrongCounter()</code> method.
As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Since every operation will hit a single key, the <code>StrongCounter</code> has a higher contention rate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>StrongCounter</code> interface adds the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; incrementAndGet() {
   <span class="keyword">return</span> addAndGet(<span class="integer">1L</span>);
}

<span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; decrementAndGet() {
   <span class="keyword">return</span> addAndGet(-<span class="integer">1L</span>);
}

CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; addAndGet(<span class="type">long</span> delta);

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; compareAndSet(<span class="type">long</span> expect, <span class="type">long</span> update);

CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; compareAndSwap(<span class="type">long</span> expect, <span class="type">long</span> update);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>incrementAndGet()</code> increments the counter by one and returns the new value.</p>
</li>
<li>
<p><code>decrementAndGet()</code> decrements the counter by one and returns the new value.</p>
</li>
<li>
<p><code>addAndGet()</code> adds a delta to the counter&#8217;s value and returns the new value.</p>
</li>
<li>
<p><code>compareAndSet()</code> and <code>compareAndSwap()</code> atomically set the counter&#8217;s value if the current value is the expected.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A operation is considered completed when the <code>CompletableFuture</code> is completed.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The difference between compare-and-set and compare-and-swap is that the former returns true if the operation succeeds
while the later returns the previous value.
The compare-and-swap is successful if the return value is the same as the expected.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="bounded_strongcounter"><a class="anchor" href="#bounded_strongcounter"></a>Bounded <code>StrongCounter</code></h5>
<div class="paragraph">
<p>When bounded, all the update method above will throw a <code>CounterOutOfBoundsException</code> when they reached the
lower or upper bound.
The exception has the following methods to check which side bound has been reached:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">boolean</span> isUpperBoundReached();
<span class="directive">public</span> <span class="type">boolean</span> isLowerBoundReached();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="uses_cases"><a class="anchor" href="#uses_cases"></a>Uses cases</h5>
<div class="paragraph">
<p>The strong counter fits better in the following uses cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When counter&#8217;s value is needed after each update (example, cluster-wise ids generator or sequences)</p>
</li>
<li>
<p>When a bounded counter is needed (example, rate limiter)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="usage_examples"><a class="anchor" href="#usage_examples"></a>Usage Examples</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// incrementing the counter</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + counter.incrementAndGet().get());

<span class="comment">// decrement the counter's value by 100 using the functional API</span>
counter.addAndGet(-<span class="integer">100</span>).thenApply(v -&gt; {
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + v);
   <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}).get();

<span class="comment">// alternative, you can do some work while the counter is updated</span>
CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; f = counter.addAndGet(<span class="integer">10</span>);
<span class="comment">// ... do some work ...</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + f.get());

<span class="comment">// and then, check the current value</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">// finally, reset to initial value</span>
counter.reset().get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">// or set to a new value if zero</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">compare and set succeeded? </span><span class="delimiter">&quot;</span></span> + counter.compareAndSet(<span class="integer">0</span>, <span class="integer">1</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>And below, there is another example using a bounded counter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">bounded_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// incrementing the counter</span>
<span class="keyword">try</span> {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + counter.addAndGet(<span class="integer">100</span>).get());
} <span class="keyword">catch</span> (<span class="exception">ExecutionException</span> e) {
    <span class="predefined-type">Throwable</span> cause = e.getCause();
    <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CounterOutOfBoundsException) {
       <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
          <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, upper bound reached.</span><span class="delimiter">&quot;</span></span>);
       } <span class="keyword">else</span> <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
          <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, lower bound reached.</span><span class="delimiter">&quot;</span></span>);
       }
    }
}

<span class="comment">// now using the functional API</span>
counter.addAndGet(-<span class="integer">100</span>).handle((v, throwable) -&gt; {
   <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
      <span class="predefined-type">Throwable</span> cause = throwable.getCause();
      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CounterOutOfBoundsException) {
         <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isUpperBoundReached()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, upper bound reached.</span><span class="delimiter">&quot;</span></span>);
         } <span class="keyword">else</span> <span class="keyword">if</span> (((CounterOutOfBoundsException) cause).isLowerBoundReached()) {
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">ops, lower bound reached.</span><span class="delimiter">&quot;</span></span>);
         }
      }
      <span class="keyword">return</span> <span class="predefined-constant">null</span>;
   }
   <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">new value is </span><span class="delimiter">&quot;</span></span> + v);
   <span class="keyword">return</span> <span class="predefined-constant">null</span>;
}).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compare-and-set vs Compare-and-swap examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);
<span class="type">long</span> oldValue, newValue;
<span class="keyword">do</span> {
   oldValue = counter.getValue().get();
   newValue = someLogic(oldValue);
} <span class="keyword">while</span> (!counter.compareAndSet(oldValue, newValue).get());</code></pre>
</div>
</div>
<div class="paragraph">
<p>With compare-and-swap, it saves one invocation counter invocation (<code>counter.getValue()</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">StrongCounter counter = counterManager.getStrongCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter</span><span class="delimiter">&quot;</span></span>);
<span class="type">long</span> oldValue = counter.getValue().get();
<span class="type">long</span> currentValue, newValue;
<span class="keyword">do</span> {
   currentValue = oldValue;
   newValue = someLogic(oldValue);
} <span class="keyword">while</span> ((oldValue = counter.compareAndSwap(oldValue, newValue).get()) != currentValue);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the_weakcounter_interface_when_speed_is_needed"><a class="anchor" href="#the_weakcounter_interface_when_speed_is_needed"></a>7.3.2. The <code>WeakCounter</code> interface: when speed is needed</h4>
<div class="paragraph">
<p>The <code>WeakCounter</code> stores the counter&#8217;s value in multiple keys in Infinispan cache.
The number of keys created is configured by the <code>concurrency-level</code> attribute.
Each key stores a partial state of the counter&#8217;s value and it can be updated concurrently.
It main advantage over the <code>StrongCounter</code> is the lower contention in the cache.
On other hand, the read of its value is more expensive and bounds are not allowed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The reset operation should be handled with caution.
It is <strong>not</strong> atomic and it produces intermediates values.
These value may be seen by a read operation and by any listener registered.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>WeakCounter</code> can be retrieved from the <code>CounterManager</code> by using the <code>getWeakCounter()</code> method.
As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CounterManager counterManager = ...
StrongCounter aCounter = counterManager.getWeakCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my-counter);</span></span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="weak_counter_interface"><a class="anchor" href="#weak_counter_interface"></a>Weak Counter Interface</h5>
<div class="paragraph">
<p>The <code>WeakCounter</code> adds the following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; increment() {
   <span class="keyword">return</span> add(<span class="integer">1L</span>);
}

<span class="keyword">default</span> CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; decrement() {
   <span class="keyword">return</span> add(-<span class="integer">1L</span>);
}

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; add(<span class="type">long</span> delta);</code></pre>
</div>
</div>
<div class="paragraph">
<p>They are similar to the `StrongCounter&#8217;s methods but they don&#8217;t return the new value.</p>
</div>
</div>
<div class="sect4">
<h5 id="uses_cases_2"><a class="anchor" href="#uses_cases_2"></a>Uses cases</h5>
<div class="paragraph">
<p>The weak counter fits best in uses cases where the result of the update operation is not needed or the counter&#8217;s value
is not required too often.
Collecting statistics is a good example of such an use case.</p>
</div>
</div>
<div class="sect4">
<h5 id="examples"><a class="anchor" href="#examples"></a>Examples</h5>
<div class="paragraph">
<p>Below, there is an example of the weak counter usage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WeakCounter counter = counterManager.getWeakCounter(<span class="string"><span class="delimiter">&quot;</span><span class="content">my_counter</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// increment the counter and check its result</span>
counter.increment().get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue());

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; f = counter.add(-<span class="integer">100</span>);
<span class="comment">//do some work</span>
f.get(); <span class="comment">//wait until finished</span>
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());

<span class="comment">//using the functional API</span>
counter.reset().whenComplete((aVoid, throwable) -&gt; <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Reset done </span><span class="delimiter">&quot;</span></span> + (throwable == <span class="predefined-constant">null</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">successfully</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">unsuccessfully</span><span class="delimiter">&quot;</span></span>))).get();
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">current value is </span><span class="delimiter">&quot;</span></span> + counter.getValue().get());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clustered_counters_notify_events"><a class="anchor" href="#clustered_counters_notify_events"></a>7.4. Notifications and Events</h3>
<div class="paragraph">
<p>Both strong and weak counter supports a listener to receive its updates events.
The listener must implement <code>CounterListener</code> and it can be registered by the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;T <span class="directive">extends</span> CounterListener&gt; Handle&lt;T&gt; addListener(T listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CounterListener</code> has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterListener</span> {
   <span class="type">void</span> onUpdate(CounterEvent entry);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Handle</code> object returned has the main goal to remove the <code>CounterListener</code> when it is not longer needed.
Also, it allows to have access to the <code>CounterListener</code> instance that is it handling.
It has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Handle</span>&lt;T <span class="directive">extends</span> CounterListener&gt; {
   T getCounterListener();
   <span class="type">void</span> remove();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the <code>CounterEvent</code> has the previous and current value and state.
It has the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterEvent</span> {
   <span class="type">long</span> getOldValue();
   State getOldState();
   <span class="type">long</span> getNewValue();
   State getNewState();
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The state is always <code>State.VALID</code> for unbounded strong counter and weak counter.
<code>State.LOWER_BOUND_REACHED</code> and <code>State.UPPER_BOUND_REACHED</code> are only valid for bounded strong counters.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The weak counter <code>reset()</code> operation will trigger multiple notification with intermediate values.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="locking_concurrency"><a class="anchor" href="#locking_concurrency"></a>8. Locking and Concurrency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan makes use of multi-versioned concurrency control (<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>) - a concurrency scheme popular with relational databases and other data stores.
MVCC offers many advantages over coarse-grained Java synchronization and even JDK Locks for access to shared data, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>allowing concurrent readers and writers</p>
</li>
<li>
<p>readers and writers do not block one another</p>
</li>
<li>
<p>write skews can be detected and handled</p>
</li>
<li>
<p>internal locks can be striped</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="locking_implementation_details"><a class="anchor" href="#locking_implementation_details"></a>8.1. Locking implementation details</h3>
<div class="paragraph">
<p>Infinispan&#8217;s MVCC implementation makes use of minimal locks and synchronizations, leaning heavily towards lock-free techniques such as <a href="http://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a> and lock-free data structures wherever possible, which helps optimize for multi-CPU and multi-core environments.</p>
</div>
<div class="paragraph">
<p>In particular, Infinispan&#8217;s MVCC implementation is heavily optimized for readers.
Reader threads do not acquire explicit locks for entries, and instead directly read the entry in question.</p>
</div>
<div class="paragraph">
<p>Writers, on the other hand, need to acquire a write lock.
This ensures only one concurrent writer per entry, causing concurrent writers to queue up to change an entry.</p>
</div>
<div class="paragraph">
<p>To allow concurrent reads, writers make a copy of the entry they intend to modify, by wrapping the entry in an <code>MVCCEntry</code>.
This copy isolates concurrent readers from seeing partially modified state.
Once a write has completed, <code>MVCCEntry.commit()</code> will flush changes to the data container and subsequent readers will see the changes written.</p>
</div>
<div class="sect3">
<h4 id="how_does_it_work_in_clustered_caches"><a class="anchor" href="#how_does_it_work_in_clustered_caches"></a>8.1.1. How does it work in clustered caches?</h4>
<div class="paragraph">
<p>In clustered caches, each key has a node responsible to lock the key. This node is called primary owner.</p>
</div>
<div class="sect4">
<h5 id="non_transactional_caches"><a class="anchor" href="#non_transactional_caches"></a>Non Transactional caches</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The write operation is sent to the primary owner of the key.</p>
</li>
<li>
<p>The primary owner tries to lock the key.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it succeeds, it forwards the operation to the other owners;</p>
</li>
<li>
<p>Otherwise, an exception is thrown.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the operation is conditional and it fails on the primary owner, it is not forwarded to the other owners.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the operation is executed locally in the primary owner, the first step is skipped.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="transactional_caches"><a class="anchor" href="#transactional_caches"></a>8.1.2. Transactional caches</h4>
<div class="paragraph">
<p>The transactional cache supports optimistic and pessimistic locking mode.
Refer to Transaction Locking for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="isolation_levels"><a class="anchor" href="#isolation_levels"></a>8.1.3. Isolation levels</h4>
<div class="paragraph">
<p>Isolation level affects what transactions can read when running concurrently with other transaction.
Refer to Isolation Levels for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="the_lockmanager"><a class="anchor" href="#the_lockmanager"></a>8.1.4. The LockManager</h4>
<div class="paragraph">
<p>The <code>LockManager</code> is a component that is responsible for locking an entry for writing.
The <code>LockManager</code> makes use of a <code>LockContainer</code> to locate/hold/create locks.
<code>LockContainers</code> come in two broad flavours, with support for lock striping and with support for one lock per entry.</p>
</div>
</div>
<div class="sect3">
<h4 id="lock_striping"><a class="anchor" href="#lock_striping"></a>8.1.5. Lock striping</h4>
<div class="paragraph">
<p>Lock striping entails the use of a fixed-size, shared collection of locks for the entire cache, with locks being allocated to entries based on the entry&#8217;s key&#8217;s hash code.
Similar to the way the JDK&#8217;s <code>ConcurrentHashMap</code> allocates locks, this allows for a highly scalable, fixed-overhead locking mechanism in exchange for potentially unrelated entries being blocked by the same lock.</p>
</div>
<div class="paragraph">
<p>The alternative is to disable lock striping - which would mean a <em>new</em> lock is created per entry.
This approach <em>may</em> give you greater concurrent throughput, but it will be at the cost of additional memory usage, garbage collection churn, etc.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Default lock striping settings</div>
lock striping is disabled by default, due to potential deadlocks that can happen if locks for different keys end up in the same lock stripe.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The size of the shared lock collection used by lock striping can be tuned using the <code>concurrencyLevel</code> attribute of the <code>&lt;locking /&gt;</code> configuration element.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">striping</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false|true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().useLockStriping(<span class="predefined-constant">false</span>|<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="concurrency_levels"><a class="anchor" href="#concurrency_levels"></a>8.1.6. Concurrency levels</h4>
<div class="paragraph">
<p>In addition to determining the size of the striped lock container, this concurrency level is also used to tune any JDK <code>ConcurrentHashMap</code> based collections where related, such as internal to <code>DataContainer</code>s.
Please refer to the JDK <code>ConcurrentHashMap</code> Javadocs for a detailed discussion of concurrency levels, as this parameter is used in exactly the same way in Infinispan.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">concurrency-level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">32</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().concurrencyLevel(<span class="integer">32</span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lock_timeout"><a class="anchor" href="#lock_timeout"></a>8.1.7. Lock timeout</h4>
<div class="paragraph">
<p>The lock timeout specifies the amount of time, in milliseconds, to wait for a contented lock.</p>
</div>
<div class="paragraph">
<p><strong>Configuration example:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span> <span class="attribute-name">acquire-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> ConfigurationBuilder().locking().lockAcquisitionTimeout(<span class="integer">10000</span>);
<span class="comment">//alternatively</span>
<span class="keyword">new</span> ConfigurationBuilder().locking().lockAcquisitionTimeout(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.SECONDS);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="consistency"><a class="anchor" href="#consistency"></a>8.1.8. Consistency</h4>
<div class="paragraph">
<p>The fact that a single owner is locked (as opposed to all owners being locked) does not break the following consistency guarantee:
if key <code>K</code> is hashed to nodes <code>{A, B}</code> and transaction <code>TX1</code> acquires a lock for <code>K</code>, let&#8217;s say on <code>A</code>.
If another transaction, <code>TX2</code>, is started on <code>B</code> (or any other node) and <code>TX2</code> tries to lock <code>K</code> then it will fail with a timeout as the lock is already held by <code>TX1</code>.
The reason for this is the that the lock for a key <code>K</code> is always, deterministically, acquired on the same node of the cluster, regardless of where the transaction originates.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_versioning"><a class="anchor" href="#data_versioning"></a>8.2. Data Versioning</h3>
<div class="paragraph">
<p>Infinispan supports two forms of data versioning: simple and external.
The simple versioning is used in transactional caches for write skew check.</p>
</div>
<div class="paragraph">
<p>The external versioning is used to encapsulate an external source of data versioning within Infinispan, such as when using Infinispan with Hibernate which in turn gets its data version information directly from a database.</p>
</div>
<div class="paragraph">
<p>In this scheme, a mechanism to pass in the version becomes necessary, and overloaded versions of <code>put()</code> and <code>putForExternalRead()</code> will be provided in <code>AdvancedCache</code> to take in an external data version.
This is then stored on the <code>InvocationContext</code> and applied to the entry at commit time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Write skew checks cannot and will not be performed in the case of external data versioning.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cdi_support"><a class="anchor" href="#cdi_support"></a>9. Using the Infinispan CDI Extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an extension that integrates with the CDI (Contexts and
Dependency Injection) programming model and allows you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure and inject caches into CDI Beans and Java EE components.</p>
</li>
<li>
<p>Configure cache managers.</p>
</li>
<li>
<p>Receive cache and cache manager level events.</p>
</li>
<li>
<p>Control data storage and retrieval using JCache annotations.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="cdi_dependencies"><a class="anchor" href="#cdi_dependencies"></a>9.1. CDI Dependencies</h3>
<div class="paragraph">
<p>Update your <code>pom.xml</code> with one of the following dependencies to include the
Infinispan CDI extension in your project:</p>
</div>
<div class="listingblock">
<div class="title">Embedded (Library) Mode</div>
<div class="content">
<pre>&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cdi-embedded&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server Mode</div>
<div class="content">
<pre>&lt;dependency&gt;
  &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
  &lt;artifactId&gt;infinispan-cdi-remote&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cdi_inject_embed"><a class="anchor" href="#cdi_inject_embed"></a>9.2. Injecting Embedded Caches</h3>
<div class="paragraph">
<p>Set up CDI beans to inject embedded caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a cache qualifier annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import javax.inject.Qualifier;

<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> GreetingCache { <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates a <code>@GreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add a producer method that defines the cache configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import org.infinispan.configuration.cache.Configuration;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.cdi.ConfigureCache</span>;
<span class="keyword">import</span> <span class="include">javax.enterprise.inject.Produces</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@ConfigureCache</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">mygreetingcache</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@GreetingCache</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@Produces</span>
    <span class="directive">public</span> <span class="predefined-type">Configuration</span> greetingCacheConfiguration() {
        <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationBuilder()
                    .memory()
                        .size(<span class="integer">1000</span>)
                    .build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>names the cache to inject.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>adds the cache qualifier.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add a producer method that creates a clustered cache manager, if required</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
package org.infinispan.configuration.global.GlobalConfigurationBuilder;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@GreetingCache</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> EmbeddedCacheManager defaultClusteredCacheManager() { <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="keyword">return</span> <span class="keyword">new</span> DefaultCacheManager(
        <span class="keyword">new</span> GlobalConfigurationBuilder().transport().defaultTransport().build();
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adds the cache qualifier.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>creates the bean once for the application. Producers that create cache managers should always include the <code>@ApplicationScoped</code> annotation to avoid creating multiple cache managers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>creates a new <code>DefaultCacheManager</code> instance that is bound to the <code>@GreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Cache managers are heavy weight objects. Having more than one cache manager
running in your application can degrade performance. When injecting multiple
caches, either add the qualifier of each cache to the cache manager producer
method or do not add any qualifier.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>@GreetingCache</code> qualifier to your cache injection point.</p>
<div class="listingblock">
<div class="content">
<pre>...
import javax.inject.Inject;

public class GreetingService {

    @Inject @GreetingCache
    private Cache&lt;String, String&gt; cache;

    public String greet(String user) {
        String cachedValue = cache.get(user);
        if (cachedValue == null) {
            cachedValue = "Hello " + user;
            cache.put(user, cachedValue);
        }
        return cachedValue;
    }
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="cdi_inject_remote"><a class="anchor" href="#cdi_inject_remote"></a>9.3. Injecting Remote Caches</h3>
<div class="paragraph">
<p>Set up CDI beans to inject remote caches.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a cache qualifier annotation.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">mygreetingcache</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Qualifier</span>
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.FIELD, <span class="predefined-type">ElementType</span>.PARAMETER, <span class="predefined-type">ElementType</span>.METHOD})
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Documented</span>
<span class="directive">public</span> <span class="annotation">@interface</span> RemoteGreetingCache { <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>names the cache to inject.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>creates a <code>@RemoteGreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the <code>@RemoteGreetingCache</code> qualifier to your cache injection point.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@Inject</span> <span class="annotation">@RemoteGreetingCache</span>
    <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;

    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="predefined-type">String</span> cachedValue = cache.get(user);
        <span class="keyword">if</span> (cachedValue == <span class="predefined-constant">null</span>) {
            cachedValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello </span><span class="delimiter">&quot;</span></span> + user;
            cache.put(user, cachedValue);
        }
        <span class="keyword">return</span> cachedValue;
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Tips for injecting remote caches</div>
<ul>
<li>
<p>You can inject remote caches without using qualifiers.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   ...
   <span class="annotation">@Inject</span>
   <span class="annotation">@Remote</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">greetingCache</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">private</span> RemoteCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache;</code></pre>
</div>
</div>
</li>
<li>
<p>If you have more than one Infinispan cluster, you can create separate remote cache manager producers for each cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
import javax.enterprise.context.ApplicationScoped;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Config</span> {

    <span class="annotation">@RemoteGreetingCache</span>
    <span class="annotation">@Produces</span>
    <span class="annotation">@ApplicationScoped</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder(); <i class="conum" data-value="2"></i><b>(2)</b>
        builder.addServer().host(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11222</span>);
        <span class="keyword">return</span> <span class="keyword">new</span> RemoteCacheManager(builder.build());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates the bean once for the application. Producers that create cache managers should always include the <code>@ApplicationScoped</code> annotation to avoid creating multiple cache managers, which are heavy weight objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>creates a new <code>RemoteCacheManager</code> instance that is bound to the <code>@RemoteGreetingCache</code> qualifier.</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="jcache_annotations"><a class="anchor" href="#jcache_annotations"></a>9.4. JCache Caching Annotations</h3>
<div class="paragraph">
<p>You can use the following JCache caching annotations with CDI managed beans when JCache artifacts are on the classpath:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>@CacheResult</code></dt>
<dd>
<p>caches the results of method calls.</p>
</dd>
<dt class="hdlist1"><code>@CachePut</code></dt>
<dd>
<p>caches method parameters.</p>
</dd>
<dt class="hdlist1"><code>@CacheRemoveEntry</code></dt>
<dd>
<p>removes entries from a cache.</p>
</dd>
<dt class="hdlist1"><code>@CacheRemoveAll</code></dt>
<dd>
<p>removes all entries from a cache.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Target type:</strong> You can use these JCache caching annotations on methods only.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use JCache caching annotations, declare interceptors in the <code>beans.xml</code>
file for your application.</p>
</div>
<div class="listingblock">
<div class="title">Managed Environments (Application Server)</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">bean-discovery-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotated</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;interceptors&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCachePutInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.InjectedCacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
  <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Non-managed Environments (Standalone)</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_1_1.xsd</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">bean-discovery-mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">annotated</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;interceptors&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheResultInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CachePutInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheRemoveEntryInterceptor<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;class&gt;</span>org.infinispan.jcache.annotation.CacheRemoveAllInterceptor<span class="tag">&lt;/class&gt;</span>
  <span class="tag">&lt;/interceptors&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">JCache Caching Annotation Examples</div>
<p>The following example shows how the <code>@CacheResult</code> annotation caches the results of the <code>GreetingService.greet()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache.interceptor.CacheResult</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="annotation">@CacheResult</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> greet(<span class="predefined-type">String</span> user) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span> + user;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With JCache annotations, the default cache uses the fully qualified name of the
annotated method with its parameter types, for example:<br>
<code>org.infinispan.example.GreetingService.greet(java.lang.String)</code></p>
</div>
<div class="paragraph">
<p>To use caches other than the default, use the <code>cacheName</code> attribute to specify
the cache name as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@CacheResult</span>(cacheName = <span class="string"><span class="delimiter">&quot;</span><span class="content">greeting-cache</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cache_events"><a class="anchor" href="#cache_events"></a>9.5. Receiving Cache and Cache Manager Events</h3>
<div class="paragraph">
<p>You can use CDI Events to receive Cache and cache manager level events.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>@Observes</code> annotation as in the following example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.enterprise.event.Observes</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachemanagerlistener.event.CacheStartedEvent</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.notifications.cachelistener.event</span>.*;

<span class="directive">public</span> <span class="type">class</span> <span class="class">GreetingService</span> {

    <span class="comment">// Cache level events</span>
    <span class="directive">private</span> <span class="type">void</span> entryRemovedFromCache(<span class="annotation">@Observes</span> CacheEntryCreatedEvent event) {
        ...
    }

    <span class="comment">// Cache manager level events</span>
    <span class="directive">private</span> <span class="type">void</span> cacheStarted(<span class="annotation">@Observes</span> CacheStartedEvent event) {
        ...
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transaction_manager"><a class="anchor" href="#transaction_manager"></a>10. Infinispan Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can be configured to use and to participate in JTA compliant transactions.</p>
</div>
<div class="paragraph">
<p>Alternatively, if transaction support is disabled, it is equivalent to using autocommit in JDBC calls, where modifications are potentially replicated after every change (if replication is enabled).</p>
</div>
<div class="paragraph">
<p>On every cache operation Infinispan does the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieves the current <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Transaction.html">Transaction</a> associated with the thread</p>
</li>
<li>
<p>If not already done, registers <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a> with the transaction manager to be notified when a transaction commits or is rolled back.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In order to do this, the cache has to be provided with a reference to the environment&#8217;s <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionManager.html">TransactionManager</a>.
This is usually done by configuring the cache with the class name of an implementation of the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> interface.
When the cache starts, it will create an instance of this class and invoke its <code>getTransactionManager()</code> method, which returns a reference to the <code>TransactionManager</code>.</p>
</div>
<div class="paragraph">
<p>Infinispan ships with several transaction manager lookup classes:</p>
</div>
<div class="ulist">
<div class="title">Transaction manager lookup implementations</div>
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/transaction/lookup/EmbeddedTransactionManagerLookup.html">EmbeddedTransactionManagerLookup</a>:
This provides with a basic transaction manager which should only be used for embedded mode when no other implementation is available.
This implementation has some severe limitations to do with concurrent transactions and recovery.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/transaction/lookup/JBossStandaloneJTAManagerLookup.html">JBossStandaloneJTAManagerLookup</a>:
If you&#8217;re running Infinispan in a standalone environment, or in JBoss AS 7 and earlier, and WildFly 8, 9, and 10, this should be your default choice for transaction manager.
It&#8217;s a fully fledged transaction manager based on <a href="http://narayana.io/">JBoss Transactions</a> which overcomes all the deficiencies of the <code>EmbeddedTransactionManager</code>.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/transaction/lookup/WildflyTransactionManagerLookup.html">WildflyTransactionManagerLookup</a>:
If you&#8217;re running Infinispan in WildFly 11 or later, this should be your default choice for transaction manager.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a>:
This is a lookup class that locate transaction managers in the most popular Java EE application servers.
If no transaction manager can be found, it defaults on the <code>EmbeddedTransactionManager</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WARN: <code>DummyTransactionManagerLookup</code> has been deprecated in 9.0 and it will be removed in the future.
Use <code>EmbeddedTransactionManagerLookup</code> instead.</p>
</div>
<div class="paragraph">
<p>Once initialized, the <code>TransactionManager</code> can also be obtained from the <code>Cache</code> itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//the cache must have a transactionManagerLookupClass defined</span>
Cache cache = cacheManager.getCache();

<span class="comment">//equivalent with calling TransactionManagerLookup.getTransactionManager();</span>
TransactionManager tm = cache.getAdvancedCache().getTransactionManager();</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="tx_configuration"><a class="anchor" href="#tx_configuration"></a>10.1. Configuring transactions</h3>
<div class="paragraph">
<p>Transactions are configured at cache level.
Below is the configuration that affects a transaction behaviour and a small description of each configuration attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;locking</span>
   <span class="attribute-name">isolation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">READ_COMMITTED</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;transaction</span>
   <span class="attribute-name">locking</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OPTIMISTIC</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">auto-commit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">complete-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">NONE</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">notifications</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">reaper-interval</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">recovery-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">__recoveryInfoCacheName__</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">stop-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30000</span><span class="delimiter">&quot;</span></span>
   <span class="attribute-name">transaction-manager-lookup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.transaction.lookup.GenericTransactionManagerLookup</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ConfigurationBuilder builder = <span class="keyword">new</span> ConfigurationBuilder();
builder.locking()
    .isolationLevel(IsolationLevel.READ_COMMITTED);
builder.transaction()
    .lockingMode(LockingMode.OPTIMISTIC)
    .autoCommit(<span class="predefined-constant">true</span>)
    .completedTxTimeout(<span class="integer">60000</span>)
    .transactionMode(TransactionMode.NON_TRANSACTIONAL)
    .useSynchronization(<span class="predefined-constant">false</span>)
    .notifications(<span class="predefined-constant">true</span>)
    .reaperWakeUpInterval(<span class="integer">30000</span>)
    .cacheStopTimeout(<span class="integer">30000</span>)
    .transactionManagerLookup(<span class="keyword">new</span> GenericTransactionManagerLookup())
    .recovery()
    .enabled(<span class="predefined-constant">false</span>)
    .recoveryInfoCacheName(<span class="string"><span class="delimiter">&quot;</span><span class="content">__recoveryInfoCacheName__</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>isolation</code> - configures the isolation level. Check section <a href="#tx_isolation_levels">Isolation Levels</a> for more details.
Default is <code>REPEATABLE_READ</code>.</p>
</li>
<li>
<p><code>locking</code> - configures whether the cache uses optimistic or pessimistic locking. Check section <a href="#tx_locking">Transaction Locking</a> for more details.
Default is <code>OPTIMISTIC</code>.</p>
</li>
<li>
<p><code>auto-commit</code> - if enable, the user does not need to start a transaction manually for a single operation. The transaction is automatically started and committed.
Default is <code>true</code>.</p>
</li>
<li>
<p><code>complete-timeout</code> - the duration in milliseconds to keep information about completed transactions. Default is <code>60000</code>.</p>
</li>
<li>
<p><code>mode</code> - configures whether the cache is transactional or not. Default is <code>NONE</code>. The available options are:</p>
<div class="ulist">
<ul>
<li>
<p><code>NONE</code> - non transactional cache</p>
</li>
<li>
<p><code>FULL_XA</code> - XA transactional cache with recovery enabled. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.</p>
</li>
<li>
<p><code>NON_DURABLE_XA</code> - XA transactional cache with recovery disabled.</p>
</li>
<li>
<p><code>NON_XA</code> - transactional cache with integration via <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a> instead of XA.
Check section <a href="#tx_sync_enlist">Enlisting Synchronizations</a> for details.</p>
</li>
<li>
<p><code>BATCH</code>-  transactional cache using batch to group operations. Check section <a href="#tx_batching">Batching</a> for details.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>notifications</code> - enables/disables triggering transactional events in cache listeners. Default is <code>true</code>.</p>
</li>
<li>
<p><code>reaper-interval</code> - the time interval in millisecond at which the thread that cleans up transaction completion information kicks in.
Defaults is <code>30000</code>.</p>
</li>
<li>
<p><code>recovery-cache</code> - configures the cache name to store the recovery information. Check section <a href="#tx_recovery">Transaction recovery</a> for more details about recovery.
Default is <code><em>recoveryInfoCacheName</em></code>.</p>
</li>
<li>
<p><code>stop-timeout</code> - the time in millisecond to wait for ongoing transaction when the cache is stopping. Default is  <code>30000</code>.</p>
</li>
<li>
<p><code>transaction-manager-lookup</code> - configures the fully qualified class name of a class that looks up a reference to a <code>javax.transaction.TransactionManager</code>.
Default is <code>org.infinispan.transaction.lookup.GenericTransactionManagerLookup</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more details on how Two-Phase-Commit (2PC) is implemented in Infinispan and how locks are being acquired see the section below.
More details about the configuration settings are available in <a href="https://docs.jboss.org/infinispan/11.0/configdocs/">Configuration reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="tx_isolation_levels"><a class="anchor" href="#tx_isolation_levels"></a>10.2. Isolation levels</h3>
<div class="paragraph">
<p>Infinispan offers two isolation levels - <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Read_committed">READ_COMMITTED</a> and <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)#Repeatable_reads">REPEATABLE_READ</a>.</p>
</div>
<div class="paragraph">
<p>These isolation levels determine when readers see a concurrent write, and are internally implemented using different subclasses of <code>MVCCEntry</code>, which have different behaviour in how state is committed back to the data container.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a more detailed example that should help understand the difference between <code>READ_COMMITTED</code> and <code>REPEATABLE_READ</code> in the context of Infinispan.
With <code>READ_COMMITTED</code>, if between two consecutive read calls on the same key, the key has been updated by another transaction, the second read may return the new updated value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Thread1: tx1.begin()
Thread1: cache.get(k) <span class="comment">// returns v</span>
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(k) <span class="comment">// returns v</span>
Thread2:                                       cache.put(k, v2)
Thread2:                                       tx2.commit()
Thread1: cache.get(k) <span class="comment">// returns v2!</span>
Thread1: tx1.commit()</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>REPEATABLE_READ</code>, the final get will still return <code>v</code>.
So, if you&#8217;re going to retrieve the same key multiple times within a transaction, you should use <code>REPEATABLE_READ</code>.</p>
</div>
<div class="paragraph">
<p>However, as read-locks are not acquired even for <code>REPEATABLE_READ</code>, this phenomena can occur:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>
cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>

Thread1: tx1.begin()
Thread1: cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
Thread1: cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
Thread2:                                       tx2.begin()
Thread2:                                       cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 1</span>
Thread1: tx1.commit()
Thread2:                                       cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>) <span class="comment">// returns 2</span>
Thread2:                                       tx2.commit()</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_locking"><a class="anchor" href="#tx_locking"></a>10.3. Transaction locking</h3>
<div class="sect3">
<h4 id="pessimistic_transactional_cache"><a class="anchor" href="#pessimistic_transactional_cache"></a>10.3.1. Pessimistic transactional cache</h4>
<div class="paragraph">
<p>From a lock acquisition perspective, pessimistic transactions obtain locks on keys at the time the key is written.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A lock request is sent to the primary owner (can be an explicit lock request or an operation)</p>
</li>
<li>
<p>The primary owner tries to acquire the lock:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it succeed, it sends back a positive reply;</p>
</li>
<li>
<p>Otherwise, a negative reply is sent and the transaction is rollback.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1); <span class="comment">//k1 is locked.</span>
cache.remove(k2); <span class="comment">//k2 is locked when this returns</span>
transactionManager.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>cache.put(k1,v1)</code> returns, <code>k1</code> is locked and no other transaction running anywhere in the cluster can write to it.
Reading <code>k1</code> is still possible.
The lock on <code>k1</code> is released when the transaction completes (commits or rollbacks).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For conditional operations, the validation is performed in the originator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="optimistic_transactional_cache"><a class="anchor" href="#optimistic_transactional_cache"></a>10.3.2. Optimistic transactional cache</h4>
<div class="paragraph">
<p>With optimistic transactions locks are being acquired at transaction prepare time and are only being held up to the point the transaction commits (or rollbacks).
This is different from the 5.0 default locking model where local locks are being acquire on writes and cluster locks are being acquired during prepare time.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The prepare is sent to all the owners.</p>
</li>
<li>
<p>The primary owners try to acquire the locks needed:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If locking succeeds, it performs the write skew check.</p>
</li>
<li>
<p>If the write skew check succeeds (or is disabled), send a positive reply.</p>
</li>
<li>
<p>Otherwise, a negative reply is sent and the transaction is rolled back.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">transactionManager.begin();
cache.put(k1,v1);
cache.remove(k2);
transactionManager.commit(); <span class="comment">//at prepare time, K1 and K2 is locked until committed/rolled back.</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For conditional commands, the validation still happens on the originator.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="what_do_i_need_pessimistic_or_optimistic_transactions"><a class="anchor" href="#what_do_i_need_pessimistic_or_optimistic_transactions"></a>10.3.3. What do I need - pessimistic or optimistic transactions?</h4>
<div class="paragraph">
<p>From a use case perspective, optimistic transactions should be used when there is <em>not</em> a lot of contention between multiple transactions running at the same time.
That is because the optimistic transactions rollback if data has changed between the time it was read and the time it was committed (with write skew check enabled).</p>
</div>
<div class="paragraph">
<p>On the other hand, pessimistic transactions might be a better fit when there is high contention on the keys and transaction rollbacks are less desirable.
Pessimistic transactions are more costly by their nature: each write operation potentially involves a RPC for lock acquisition.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_write_skew"><a class="anchor" href="#tx_write_skew"></a>10.4. Write Skews</h3>
<div class="paragraph">
<p>Write skews occur when two transactions independently and simultaneously read and write to the same key. The result of a write skew is that both transactions successfully commit updates to the same key but with different values.</p>
</div>
<div class="paragraph">
<p>Infinispan automatically performs write skew checks to ensure data consistency for <code>REPEATABLE_READ</code> isolation levels in optimistic transactions. This allows Infinispan to detect and roll back one of the transactions.</p>
</div>
<div class="paragraph">
<p>When operating in <code>LOCAL</code> mode, write skew checks rely on Java object
references to compare differences, which provides a reliable technique for
checking for write skews.</p>
</div>
<div class="sect3">
<h4 id="forcing_write_locks_on_keys_in_pessimitic_transactions"><a class="anchor" href="#forcing_write_locks_on_keys_in_pessimitic_transactions"></a>10.4.1. Forcing write locks on keys in pessimitic transactions</h4>
<div class="paragraph">
<p>To avoid write skews with pessimistic transactions, lock keys at read-time with <code>Flag.FORCE_WRITE_LOCK</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>In non-transactional caches, <code>Flag.FORCE_WRITE_LOCK</code> does not work. The <code>get()</code> call reads the key value but does not acquire locks remotely.</p>
</li>
<li>
<p>You should use <code>Flag.FORCE_WRITE_LOCK</code> with transactions in which the entity is updated later in the same transaction.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Compare the following code snippets for an example of <code>Flag.FORCE_WRITE_LOCK</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// begin the transaction</span>
<span class="keyword">if</span> (!cache.getAdvancedCache().lock(key)) {
   <span class="comment">// abort the transaction because the key was not locked</span>
} <span class="keyword">else</span> {
   cache.get(key);
   cache.put(key, value);
   <span class="comment">// commit the transaction</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// begin the transaction</span>
<span class="keyword">try</span> {
   <span class="comment">// throws an exception if the key is not locked.</span>
   cache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK).get(key);
   cache.put(key, value);
} <span class="keyword">catch</span> (CacheException e) {
   <span class="comment">// mark the transaction rollback-only</span>
}
<span class="comment">// commit or rollback the transaction</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dealing_with_exceptions"><a class="anchor" href="#dealing_with_exceptions"></a>10.5. Dealing with exceptions</h3>
<div class="paragraph">
<p>If a <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/CacheException.html">CacheException</a> (or a subclass of it) is thrown by a cache method within the scope of a JTA transaction, then the transaction is automatically marked for rollback.</p>
</div>
</div>
<div class="sect2">
<h3 id="tx_sync_enlist"><a class="anchor" href="#tx_sync_enlist"></a>10.6. Enlisting Synchronizations</h3>
<div class="paragraph">
<p>By default Infinispan registers itself as a first class participant in distributed transactions through <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/xa/XAResource.html">XAResource</a>.
There are situations where Infinispan is not required to be a participant in the transaction, but only to be notified by its lifecycle (prepare, complete): e.g. in the case Infinispan is used as a 2nd level cache in Hibernate.</p>
</div>
<div class="paragraph">
<p>Infinispan allows transaction enlistment through <a href="https://docs.oracle.com/javaee/7/api/javax/transaction/Synchronization.html">Synchronization</a>.
To enable it just use <code>NON_XA</code> transaction mode.</p>
</div>
<div class="paragraph">
<p><code>Synchronization</code>s have the advantage that they allow <code>TransactionManager</code> to optimize 2PC with a 1PC where only one other resource is enlisted with that transaction (<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/development_guide/java_transaction_api_jta#about_the_lrco_optimization_for_single_phase_commit_1pc">last resource commit optimization</a>).
E.g. Hibernate second level cache: if Infinispan registers itself with the <code>TransactionManager</code> as a <code>XAResource</code> than at commit time, the <code>TransactionManager</code> sees two <code>XAResource</code> (cache and database) and does not make this optimization.
Having to coordinate between two resources it needs to write the tx log to disk.
On the other hand, registering Infinispan as a <code>Synchronization</code> makes the <code>TransactionManager</code> skip writing the log to the disk (performance improvement).</p>
</div>
</div>
<div class="sect2">
<h3 id="tx_batching"><a class="anchor" href="#tx_batching"></a>10.7. Batching</h3>
<div class="paragraph">
<p>Batching allows atomicity and some characteristics of a transaction, but not full-blown JTA or XA capabilities.
Batching is often a lot lighter and cheaper than a full-blown transaction.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Generally speaking, one should use batching API whenever the only participant in the transaction is an Infinispan cluster.
On the other hand, JTA transactions (involving <code>TransactionManager</code>) should be used whenever the transactions involves multiple systems.
E.g. considering the "Hello world!" of transactions: transferring money from one bank account to the other.
If both accounts are stored within Infinispan, then batching can be used.
If one account is in a database and the other is Infinispan, then distributed transactions are required.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You <em>do not</em> have to have a transaction manager defined to use batching.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="api"><a class="anchor" href="#api"></a>10.7.1. API</h4>
<div class="paragraph">
<p>Once you have configured your cache to use batching, you use it by calling <code>startBatch()</code> and <code>endBatch()</code> on <code>Cache</code>. E.g.,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = cacheManager.getCache();
<span class="comment">// not using a batch</span>
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>); <span class="comment">// will replicate immediately</span>

<span class="comment">// using a batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">true</span>); <span class="comment">// This will now replicate the modifications since the batch was started.</span>

<span class="comment">// a new batch</span>
cache.startBatch();
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">k3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);
cache.endBatch(<span class="predefined-constant">false</span>); <span class="comment">// This will &quot;discard&quot; changes made in the batch</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="batching_and_jta"><a class="anchor" href="#batching_and_jta"></a>10.7.2. Batching and JTA</h4>
<div class="paragraph">
<p>Behind the scenes, the batching functionality starts a JTA transaction, and all the invocations in that scope are associated with it.
For this it uses a very simple (e.g. no recovery) internal <code>TransactionManager</code> implementation.
With batching, you get:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locks you acquire during an invocation are held until the batch completes</p>
</li>
<li>
<p>Changes are all replicated around the cluster in a batch as part of the batch completion process. Reduces replication chatter for each update in the batch.</p>
</li>
<li>
<p>If synchronous replication or invalidation are used, a failure in replication/invalidation will cause the batch to roll back.</p>
</li>
<li>
<p>All the transaction related configurations apply for batching as well.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tx_recovery"><a class="anchor" href="#tx_recovery"></a>10.8. Transaction recovery</h3>
<div class="paragraph">
<p>Recovery is a feature of XA transactions, which deal with the eventuality of a resource or possibly even the transaction manager failing, and recovering accordingly from such a situation.</p>
</div>
<div class="sect3">
<h4 id="when_to_use_recovery"><a class="anchor" href="#when_to_use_recovery"></a>10.8.1. When to use recovery</h4>
<div class="paragraph">
<p>Consider a distributed transaction in which money is transferred from an account stored in an external database to an account stored in Infinispan.
When <code>TransactionManager.commit()</code> is invoked, both resources prepare successfully (1st phase). During the commit (2nd) phase, the database successfully applies the changes whilst Infinispan fails before receiving the commit request from the transaction manager.
At this point the system is in an inconsistent state: money is taken from the account in the external database but not visible yet in Infinispan (since locks are only released during 2nd phase of a two-phase commit protocol).
Recovery deals with this situation to make sure data in both the database and Infinispan ends up in a consistent state.</p>
</div>
</div>
<div class="sect3">
<h4 id="how_does_it_work"><a class="anchor" href="#how_does_it_work"></a>10.8.2. How does it work</h4>
<div class="paragraph">
<p>Recovery is coordinated by the transaction manager.
The transaction manager works with Infinispan to determine the list of in-doubt transactions that require manual intervention and informs the system administrator (via email, log alerts, etc).
This process is transaction manager specific, but generally requires some configuration on the transaction manager.  </p>
</div>
<div class="paragraph">
<p>Knowing the in-doubt transaction ids, the system administrator can now connect to the Infinispan cluster and replay the commit of transactions or force the rollback.
Infinispan provides JMX tooling for this - this is explained extensively in the <a href="#tx_recovery_reconciliation">Transaction recovery and reconciliation</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring_recovery"><a class="anchor" href="#configuring_recovery"></a>10.8.3. Configuring recovery   </h4>
<div class="paragraph">
<p>Recovery is <em>not</em> enabled by default in Infinispan.
If disabled, the <code>TransactionManager</code> won&#8217;t be able to work with Infinispan to determine the in-doubt transactions.
The <a href="#tx_configuration">Transaction configuration</a> section shows how to enable it.</p>
</div>
<div class="paragraph">
<p>NOTE: <code>recovery-cache</code> attribute is not mandatory and it is configured per-cache.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For recovery to work, <code>mode</code> must be set to <code>FULL_XA</code>, since full-blown XA transactions are needed.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="enable_jmx_support"><a class="anchor" href="#enable_jmx_support"></a>Enable JMX support</h5>
<div class="paragraph">
<p>In order to be able to use JMX for managing recovery JMX support must be explicitly enabled.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="recovery_cache"><a class="anchor" href="#recovery_cache"></a>10.8.4. Recovery cache</h4>
<div class="paragraph">
<p>In order to track in-doubt transactions and be able to reply them, Infinispan caches all transaction state for future use.
This state is held only for in-doubt transaction, being removed for successfully completed transactions after when the commit/rollback phase completed.</p>
</div>
<div class="paragraph">
<p>This in-doubt transaction data is held within a local cache: this allows one to configure swapping this info to disk through cache loader in the case it gets too big.
This cache can be specified through the <code>recovery-cache</code> configuration attribute.
If not specified Infinispan will configure a local cache for you.</p>
</div>
<div class="paragraph">
<p>It is possible (though not mandated) to share same recovery cache between all the Infinispan caches that have recovery enabled.
If the default recovery cache is overridden, then the specified recovery cache must use a <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html">TransactionManagerLookup</a> that returns a different transaction manager than the one used by the cache itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="integration_with_the_transaction_manager"><a class="anchor" href="#integration_with_the_transaction_manager"></a>10.8.5. Integration with the transaction manager</h4>
<div class="paragraph">
<p>Even though this is transaction manager specific, generally a transaction manager would need a reference to a <code>XAResource</code> implementation in order to invoke <code>XAResource.recover()</code> on it.
In order to obtain a reference to an Infinispan <code>XAResource</code> following API can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">XAResource</span> xar = cache.getAdvancedCache().getXAResource();</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a common practice to run the recovery in a different process from the one running the transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="tx_recovery_reconciliation"><a class="anchor" href="#tx_recovery_reconciliation"></a>10.8.6. Reconciliation</h4>
<div class="paragraph">
<p>The transaction manager informs the system administrator on in-doubt transaction in a proprietary way.
At this stage it is assumed that the system administrator knows transaction&#8217;s XID (a byte array).</p>
</div>
<div class="paragraph">
<p>A normal recovery flow is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>STEP 1</strong>: The system administrator connects to an Infinispan server through JMX, and lists the in doubt transactions.
The image below demonstrates JConsole connecting to an Infinispan node that has an in doubt transaction.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/showInDoubtTx.png" alt="showInDoubtTx">
</div>
<div class="title">Figure 1. Show in-doubt transactions</div>
</div>
<div class="paragraph">
<p>The status of each in-doubt transaction is displayed(in this example " <em>PREPARED</em> ").
There might be multiple elements in the status field, e.g. "PREPARED" and "COMMITTED" in the case the transaction committed on certain nodes but not on all of them.  </p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>STEP 2</strong>: The system administrator visually maps the XID received from the transaction manager to an Infinispan internal id, represented as a number.
This step is needed because the XID, a byte array, cannot conveniently be passed to the JMX tool (e.g. JConsole) and then re-assembled on Infinispan&#8217;s side.</p>
</li>
<li>
<p><strong>STEP 3</strong>: The system administrator forces the transaction&#8217;s commit/rollback through the corresponding jmx operation, based on the internal id.
The image below is obtained by forcing the commit of the transaction based on its internal id.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="../../topics/images/forceCommit.png" alt="forceCommit">
</div>
<div class="title">Figure 2. Force commit</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All JMX operations described above can be executed on any node, regardless of where the transaction originated.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="force_commitrollback_based_on_xid"><a class="anchor" href="#force_commitrollback_based_on_xid"></a>Force commit/rollback based on XID</h5>
<div class="paragraph">
<p>XID-based JMX operations for forcing in-doubt transactions' commit/rollback are available as well: these methods receive byte[] arrays describing the XID instead of the number associated with the transactions (as previously described at step 2).
These can be useful e.g. if one wants to set up an automatic completion job for certain in-doubt transactions.
This process is plugged into transaction manager&#8217;s recovery and has access to the transaction manager&#8217;s XID objects.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="want_to_know_more"><a class="anchor" href="#want_to_know_more"></a>10.8.7. Want to know more?</h4>
<div class="paragraph">
<p>The <a href="https://community.jboss.org/wiki/TransactionRecoveryDesign">recovery design document</a> describes in more detail the insides of transaction recovery implementation.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functional_map_api"><a class="anchor" href="#functional_map_api"></a>11. Functional Map API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an experimental API for interacting with your
data which takes advantage of the functional programming additions and
improved asynchronous programming capabilities available in Java 8.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.html">Functional Map API</a>
is a distilled map-like asynchronous API which uses functions to interact with data.</p>
</div>
<div class="sect2">
<h3 id="asynchronous_and_lazy"><a class="anchor" href="#asynchronous_and_lazy"></a>11.1. Asynchronous and Lazy</h3>
<div class="paragraph">
<p>Being an asynchronous API, all methods that return a single result,
return a CompletableFuture which wraps the result, so you can use the
resources of your system more efficiently by having the possibility to
receive callbacks when the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
has completed, or you can chain or compose them with other CompletableFuture.</p>
</div>
<div class="paragraph">
<p>For those operations that return multiple results, the API returns instances of a <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Traversable.html">​Traversable</a> interface which offers a lazy pull-style API for working with multiple results.</p>
</div>
<div class="paragraph">
<p><code>​Traversable</code>,​ being a lazy pull-style API, can still be asynchronous underneath since the user can decide to work on the traversable at a later stage, and the <code>​Traversable</code> implementation itself can decide when to compute those results.</p>
</div>
</div>
<div class="sect2">
<h3 id="function_transparency"><a class="anchor" href="#function_transparency"></a>11.2. Function transparency</h3>
<div class="paragraph">
<p>Since the content of the functions is transparent to Infinispan, the API
has been split into 3 interfaces for read­-only (
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadOnlyMap.html"><code>R​eadOnlyMap</code></a>
)​, read­-write (
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html"><code>R​eadWriteMap</code></a>
)​ and write­-only (
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html"><code>W​riteOnlyMap</code></a>
)​ operations respectively, in order to provide hints to the Infinispan
internals on the type of work needed to support functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="constructing_functional_maps"><a class="anchor" href="#constructing_functional_maps"></a>11.3. Constructing Functional Maps</h3>
<div class="paragraph">
<p>To construct any of the read-only, write-only or read-write map
instances, an Infinispan
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>
is required, which is retrieved from the Cache Manager, and using the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>
, static method
factory methods are used to create
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadOnlyMap.html"><code>R​eadOnlyMap</code></a>
,
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html"><code>R​eadWriteMap</code></a>
or
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html"><code>W​riteOnlyMap</code></a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.impl</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.AdvancedCache</span>;

AdvancedCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = ...

FunctionalMapImpl&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; functionalMap = FunctionalMapImpl.create(cache);
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ReadOnlyMapImpl.create(functionalMap);
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = WriteOnlyMapImpl.create(functionalMap);
ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ReadWriteMapImpl.create(functionalMap);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
At this stage, the Functional Map API is experimental and hence the
way FunctionalMap, ReadOnlyMap, WriteOnlyMap and ReadWriteMap are constructed
is temporary.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="read_only_map_api"><a class="anchor" href="#read_only_map_api"></a>11.4. Read-Only Map API</h3>
<div class="paragraph">
<p>Read-only operations have the advantage that no locks are acquired
for the duration of the operation. Here&#8217;s an example on how to the
equivalent operation for
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#get-java.lang.Object-">Map.get(K)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView.ReadEntryView</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap.ReadOnlyMap</span>;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find);
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read-only map also exposes operations to retrieve multiple keys in one go:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.Traversable</span>;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

Set&lt;<span class="predefined-type">String</span>&gt; keys = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;&gt;(<span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>));
Traversable&lt;<span class="predefined-type">String</span>&gt; values = readOnlyMap.evalMany(keys, ReadEntryView::get);
values.forEach(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, read-only map also exposes methods to read all existing keys as well
as entries, which include both key and value information.</p>
</div>
<div class="sect3">
<h4 id="read_only_entry_view"><a class="anchor" href="#read_only_entry_view"></a>11.4.1. Read-Only Entry View</h4>
<div class="paragraph">
<p>The function parameters for read-only maps provide the user with a
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html">read-only entry view</a>
to interact with the data in the cache, which include these operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#key()"><code>key()</code></a>
method returns the key for which this function is being executed.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#find()"><code>find()</code></a>
returns a Java 8 <code>Optional</code> wrapping the value if present,
otherwise it returns an empty optional. Unless the value is guaranteed to
be associated with the key, it&#8217;s recommended to use <code>find()</code> to verify
whether there&#8217;s a value associated with the key.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#get()"><code>get()</code></a>
returns the value associated with the key. If the key has no value
associated with it, calling <code>get()</code> throws a <code>NoSuchElementException</code>.
<code>get()</code> can be considered as a shortcut of <code>ReadEntryView.find().get()</code>
which should be used only when the caller has guarantees that there&#8217;s
definitely a value associated with the key.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/MetaParam.Lookup.html#findMetaParam(java.lang.Class)"><code>findMetaParam(Class&lt;T&gt; type)</code></a>
allows metadata parameter information
associated with the cache entry to be looked up, for example: entry
lifespan, last  accessed time&#8230;&#8203;etc.
See <a href="#meta_parameter">Metadata Parameter Handling</a> to find out more.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="write_only_map_api"><a class="anchor" href="#write_only_map_api"></a>11.5. Write-Only Map API</h3>
<div class="paragraph">
<p>Write-only operations include operations that insert or update data in the
cache and also removals. Crucially, a write-only operation does not attempt
to read any previous value associated with the key. This is an important
optimization since that means neither the cluster nor any persistence stores
will be looked up to retrieve previous values. In the main Infinispan Cache,
this kind of optimization was achieved using a local-only per-invocation
flag, but the use case is so common that in this new functional API, this
optimization is provided as a first-class citizen.</p>
</div>
<div class="paragraph">
<p>Using
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html">write-only map API</a>
, an operation equivalent to
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>javax.cache.Cache</code> (<code>JCache</code>)</a>
's void returning
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L194"><code>put</code></a>
can be achieved this way, followed by an attempt to read the stored
value using the read-only map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v));
CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::get));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple key/value pairs can be stored in one go using
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#evalMany(java.util.Map,java.util.function.BiConsumer)"><code>evalMany</code></a>
API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

Map&lt;K, <span class="predefined-type">String</span>&gt; data = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
data.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writerAllFuture = writeOnlyMap.evalMany(data, (v, view) -&gt; view.set(v));
writerAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Write completed</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove all contents of the cache, there are two possibilities with
different semantics. If using
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#evalAll(java.util.function.Consumer)"><code>evalAll</code></a>
each cached entry is iterated over and the function is called
with that entry&#8217;s information. Using this method also results in listeners being invoked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeAllFuture = writeOnlyMap.evalAll(WriteEntryView::remove);
removeAllFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">All entries removed</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The alternative way to remove all entries is to call
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#truncate()"><code>truncate</code></a>
operation which clears the entire cache contents in one go without
invoking any listeners and is best-effort:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; truncateFuture = writeOnlyMap.truncate();
truncateFuture.thenAccept(x -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">Cache contents cleared</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="write_only_entry_view"><a class="anchor" href="#write_only_entry_view"></a>11.5.1. Write-Only Entry View</h4>
<div class="paragraph">
<p>The function parameters for write-only maps provide the user with a
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.WriteEntryView.html">write-only entry view</a>
to modify the data in the cache, which include these
operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.WriteEntryView.html#set(V,org.infinispan.functional.MetaParam.Writable&#8230;&#8203;)"><code>set(V, MetaParam.Writable&#8230;&#8203;)</code></a>
method allows for a new value to be
associated with the cache entry for which this function is executed, and it
optionally takes zero or more metadata parameters to be stored along with
the value. See <a href="#meta_parameter">Metadata Parameter Handling</a> for more information.</p>
</li>
<li>
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.WriteEntryView.html#remove()"><code>remove()</code></a>
method removes the cache entry, including both value and metadata
parameters associated with this key.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="read_write_map_api"><a class="anchor" href="#read_write_map_api"></a>11.6. Read-Write Map API</h3>
<div class="paragraph">
<p>The final type of operations we have are read­write operations, and within
this category CAS-like (Compare­And­Swap) operations can be found.
This type of operations require previous value associated with the key
to be read and for locks to be acquired before executing the function.
The vast majority of operations within
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
APIs fall within this category, and they can easily be implemented using the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a>
. Moreover, with
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html">read-write map API</a>
, you can make CAS­like comparisons not only based on value equality
but based on metadata parameter equality such as version information,
and you can send back previous value or boolean instances to signal
whether the CAS­like comparison succeeded.</p>
</div>
<div class="paragraph">
<p>Implementing a write operation that returns the previous value associated
with the cache entry is easy to achieve with the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; readWriteFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; {
      Optional&lt;V&gt; prev = rw.find();
      view.set(v);
      <span class="keyword">return</span> prev;
   });
readWriteFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html#replace-K-V-V-"><code>ConcurrentMap.replace(K, V, V)</code></a>
is a replace function that compares the
value present in the map and if it&#8217;s equals to the value passed in as
first parameter, the second value is stored, returning a boolean
indicating whether the replace was successfully completed. This operation
can easily be implemented using the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

String oldValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">old-value</span><span class="delimiter">&quot;</span></span>;
CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; replaceFuture = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>, (v, view) -&gt; {
   <span class="keyword">return</span> view.find().map(prev -&gt; {
      <span class="keyword">if</span> (prev.equals(oldValue)) {
         rw.set(v);
         <span class="keyword">return</span> <span class="predefined-constant">true</span>; <span class="comment">// previous value present and equals to the expected one</span>
      }
      <span class="keyword">return</span> <span class="predefined-constant">false</span>; <span class="comment">// previous value associated with key does not match</span>
   }).orElse(<span class="predefined-constant">false</span>); <span class="comment">// no value associated with this key</span>
});
replaceFuture.thenAccept(replaced -&gt; <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Value was replaced? %s%n</span><span class="delimiter">&quot;</span></span>, replaced));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The function in the example above captures <code>oldValue</code> which is an
external value to the function which is valid use case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Read-write map API contains <code>evalMany</code> and <code>evalAll</code> operations which behave
similar to the write-only map offerings, except that they enable previous
value and metadata parameters to be read.</p>
</div>
<div class="sect3">
<h4 id="read_write_entry_view"><a class="anchor" href="#read_write_entry_view"></a>11.6.1. Read-Write Entry View</h4>
<div class="paragraph">
<p>The function parameters for read-write maps provide the user with the
possibility to query the information associated with the key, including
value and metadata parameters, and the user can also use this
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.ReadWriteEntryView.html">read-write entry view</a>
to modify the data in the cache.</p>
</div>
<div class="paragraph">
<p>The operations are exposed by read-write entry views are a union of
the operations exposed by <a href="#read_only_entry_view">read-only entry views</a>
and <a href="#write_only_entry_view">write-only entry views</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="meta_parameter"><a class="anchor" href="#meta_parameter"></a>11.7. Metadata Parameter Handling</h3>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/MetaParam.html">Metadata parameters</a>
provide extra information about the cache entry, such
as version information, lifespan, last accessed/used time&#8230;&#8203;etc. Some of
these can be provided by the user, e.g. version, lifespan&#8230;&#8203;etc, but some
others are computed internally and can only be queried, e.g. last
accessed/used time.</p>
</div>
<div class="paragraph">
<p>The functional map API provides a flexible way to store metadata parameters
along with an cache entry. To be able to store a metadata parameter, it must
extend
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/MetaParam.Lookup.html"><code>MetaParam.Writable</code></a>
interface, and implement the methods to allow the
internal logic to extra the data. Storing is done via the
<code>set(V, MetaParam.Writable&#8230;&#8203;)</code> method in the <a href="#write_only_entry_view">write-only entry view</a> or <a href="#read_write_entry_view">read-write entry view</a> function parameters.</p>
</div>
<div class="paragraph">
<p>Querying metadata parameters is available via the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/MetaParam.Lookup.html#findMetaParam(java.lang.Class)"><code>findMetaParam(Class)</code></a>
method
available via <a href="#read_write_entry_view">read-write entry view</a> or
<a href="#read_only_entry_view">read-only entry views</a> or function parameters.</p>
</div>
<div class="paragraph">
<p>Here is an example showing how to store metadata parameters and how to query
them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.time.Duration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.MetaParam</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
   (v, view) -&gt; view.set(v, <span class="keyword">new</span> MetaLifespan(<span class="predefined-type">Duration</span>.ofHours(<span class="integer">1</span>).toMillis())));
CompletableFuture&lt;MetaLifespan&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; view.findMetaParam(MetaLifespan.class).get()));
readFuture.thenAccept(<span class="predefined-type">System</span>.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the metadata parameter is generic, for example
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/MetaParam.MetaEntryVersion.html"><code>MetaEntryVersion&lt;T&gt;</code></a>
, retrieving the metadata parameter along with a specific type can be tricky
if using <code>.class</code> static helper in a class because it does not return a
<code>Class&lt;T&gt;</code> but only <code>Class</code>, and hence any generic information in the class is
lost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// If caller depends on the typed information, this is not an ideal way to retrieve it</span>
   <span class="comment">// If the caller does not depend on the specific type, this works just fine.</span>
   Optional&lt;MetaEntryVersion&gt; version = view.findMetaParam(MetaEntryVersion.class);
   <span class="keyword">return</span> view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>When generic information is important the user can define a static helper
method that coerces the static class retrieval to the type requested,
and then use that helper method in the call to <code>findMetaParam</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">MetaEntryVersion</span>&lt;T&gt; <span class="directive">implements</span> MetaParam.Writable&lt;EntryVersion&lt;T&gt;&gt; {
   ...
   public <span class="directive">static</span> &lt;T&gt; T type() { <span class="keyword">return</span> (T) MetaEntryVersion.class; }
   ...
}

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...

CompletableFuture&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, view -&gt; {
   <span class="comment">// The caller wants guarantees that the metadata parameter for version is numeric</span>
   <span class="comment">// e.g. to query the actual version information</span>
   Optional&lt;MetaEntryVersion&lt;<span class="predefined-type">Long</span>&gt;&gt; version = view.findMetaParam(MetaEntryVersion.type());
   <span class="keyword">return</span> view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, users are free to create new instances of metadata parameters to
suit their needs. They are stored and retrieved in the very same way as done
for the metadata parameters already provided by the functional map API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_invocation_parameter"><a class="anchor" href="#_invocation_parameter"></a>11.8. Invocation Parameter</h3>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Param.html">Per-invocation parameters</a>
are applied to regular functional map API calls to
alter the behaviour of certain aspects. Adding per invocation parameters is
done using the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.html#withParams(org.infinispan.functional.Param&#8230;&#8203;)"><code>withParams(Param&lt;?&gt;&#8230;&#8203;)</code></a>
method.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Param.FutureMode.html"><code>Param.FutureMode</code></a>
tweaks whether a method returning a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
will span a thread to invoke the method, or instead will use the caller
thread. By default, whenever a call is made to a method returning a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
, a separate thread will be span to execute the method asynchronously.
However, if the caller will immediately block waiting for the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html"><code>CompletableFuture</code></a>
to complete, spanning a different thread is wasteful, and hence
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Param.FutureMode.html#COMPLETED"><code>Param.FutureMode.COMPLETED</code></a>
can be passed as per-invocation parameter to avoid creating that extra thread. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.Param</span>.*;

ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMap = ...
ReadOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readOnlyMapCompleted = readOnlyMap.withParams(FutureMode.COMPLETED);
Optional&lt;<span class="predefined-type">String</span>&gt; readFuture = readOnlyMapCompleted.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, ReadEntryView::find).get();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Param.PersistenceMode controls whether a write operation will be propagated
to a persistence store. The default behaviour is for all write-operations
to be propagated to the persistence store if the cache is configured with
a persistence store. By passing PersistenceMode.SKIP as parameter,
the write operation skips the persistence store and its effects are only
seen in the in-memory contents of the cache. PersistenceMode.SKIP can
be used to implement an
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#evict-K-"><code>Cache.evict()</code></a>
method which removes data from memory but leaves the persistence store
untouched:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.Param</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; skiPersistMap = writeOnlyMap.withParams(PersistenceMode.SKIP);
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; removeFuture = skiPersistMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, WriteEntryView::remove);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that there&#8217;s no need for another PersistenceMode option to skip
reading from the persistence store, because a write operation can skip
reading previous value from the store by calling a write-only operation
via the WriteOnlyMap.</p>
</div>
<div class="paragraph">
<p>Finally, new Param implementations are normally provided by the functional
map API since they tweak how the internal logic works. So, for the most part
of users, they should limit themselves to using the Param instances exposed
by the API. The exception to this rule would be advanced users who decide
to add new interceptors to the internal stack. These users have the ability
to query these parameters within the interceptors.</p>
</div>
</div>
<div class="sect2">
<h3 id="functional_listeners"><a class="anchor" href="#functional_listeners"></a>11.9. Functional Listeners</h3>
<div class="paragraph">
<p>The functional map offers a listener API, where clients can register for and
get notified when events take place. These notifications are post-event, so
that means the events are received after the event has happened.</p>
</div>
<div class="paragraph">
<p>The listeners that can be registered are split into two categories:
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html">write listeners</a>
and
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html">read-write listeners</a>.</p>
</div>
<div class="sect3">
<h4 id="write_listeners"><a class="anchor" href="#write_listeners"></a>11.9.1. Write Listeners</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html">Write listeners</a>
enable user to register listeners for any cache entry write events
that happen in either a read-write or write-only functional map.</p>
</div>
<div class="paragraph">
<p>Listeners for write events cannot distinguish between cache entry
created and cache entry modify/update events because they don&#8217;t have
access to the previous value. All they know is that a new non-null
entry has been written.</p>
</div>
<div class="paragraph">
<p>However, write event listeners can distinguish between entry removals
and cache entry create/modify-update events because they can query
what the new entry&#8217;s value via
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/EntryView.ReadEntryView.html#find()"><code>ReadEntryView.find()</code></a>
method.</p>
</div>
<div class="paragraph">
<p>Adding a write listener is done via the WriteListeners interface
which is accessible via both
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html#listeners()"><code>ReadWriteMap.listeners()</code></a>
and
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.WriteOnlyMap.html#listeners()"><code>WriteOnlyMap.listeners()</code></a>
 method.</p>
</div>
<div class="paragraph">
<p>A write listener implementation can be defined either passing a function
to
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html#onWrite(java.util.function.Consumer)"><code>onWrite(Consumer&lt;ReadEntryView&lt;K, V&gt;&gt;)</code></a>
method, or passing a
WriteListener implementation to
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.html#add(org.infinispan.functional.Listeners.WriteListeners.WriteListener)"><code>add(WriteListener&lt;K, V&gt;)</code></a>
method.
Either way, all these methods return an
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a>
instance that can be used to de-register the function listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.Listeners.WriteListeners.WriteListener</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; woMap = ...

AutoCloseable writeFunctionCloseHandler = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
AutoCloseable writeCloseHanlder = woMap.listeners().add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
});

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(writeFunctionCloseHandler) {
   <span class="comment">// Write entries using read-write or write-only functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeCloseHanlder.close();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="read_write_listeners"><a class="anchor" href="#read_write_listeners"></a>11.9.2. Read-Write Listeners</h4>
<div class="paragraph">
<p><a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html">Read-write listeners</a>
enable users to register listeners for cache entry created, modified
and removed events, and also register listeners for any cache entry
write events.</p>
</div>
<div class="paragraph">
<p>Entry created, modified and removed events can only be fired when these
originate on a read-write functional map, since this is the only one
that guarantees that the previous value has been read, and hence the
differentiation between create, modified and removed can be fully
guaranteed.</p>
</div>
<div class="paragraph">
<p>Adding a read-write listener is done via the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html"><code>ReadWriteListeners</code></a>
interface which is accessible via
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/FunctionalMap.ReadWriteMap.html#listeners()"><code>ReadWriteMap.listeners()</code></a>
method.</p>
</div>
<div class="paragraph">
<p>If interested in only one of the event types, the simplest way to add a
listener is to pass a function to either
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onCreate(java.util.function.Consumer)"><code>onCreate</code></a>
,
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onModify(java.util.function.BiConsumer)"><code>onModify</code></a>
or
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.ReadWriteListener.html#onRemove(java.util.function.Consumer)"><code>onRemove</code></a>
methods. All these methods return an AutoCloseable instance that can be
used to de-register the function listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable createClose = rwMap.listeners().onCreate(created -&gt; {
   <span class="comment">// `created` is a ReadEntryView of the created entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
});
AutoCloseable modifyClose = rwMap.listeners().onModify((before, after) -&gt; {
   <span class="comment">// `before` is a ReadEntryView of the entry before update</span>
   <span class="comment">// `after` is a ReadEntryView of the entry after update</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
});
AutoCloseable removeClose = rwMap.listeners().onRemove(removed -&gt; {
   <span class="comment">// `removed` is a ReadEntryView of the removed entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
});
AutoCloseable writeClose = woMap.listeners().onWrite(written -&gt; {
   <span class="comment">// `written` is a ReadEntryView of the written entry</span>
   <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
});
...
<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
try(createClose) {
   <span class="comment">// Create entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
modifyClose.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If listening for two or more event types, it&#8217;s better to pass in an
implementation of
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.WriteListeners.WriteListener.html"><code>ReadWriteListener</code></a>
interface via the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/functional/Listeners.ReadWriteListeners.html#add(org.infinispan.functional.Listeners.ReadWriteListeners.ReadWriteListener)"><code>ReadWriteListeners.add()</code></a>
method. <code>ReadWriteListener</code> offers the same <code>onCreate</code>/<code>onModify</code>/<code>onRemove</code>
callbacks with default method implementations that are empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.Listeners.ReadWriteListeners.ReadWriteListener</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; rwMap = ...
AutoCloseable readWriteClose = rwMap.listeners.add(<span class="keyword">new</span> ReadWriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onCreate(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; created) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Created: %s%n</span><span class="delimiter">&quot;</span></span>, created.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onModify(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; before, ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; after) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Before: %s%n</span><span class="delimiter">&quot;</span></span>, before.get());
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">After: %s%n</span><span class="delimiter">&quot;</span></span>, after.get());
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onRemove(ReadEntryView&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; removed) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Removed: %s%n</span><span class="delimiter">&quot;</span></span>, removed.get());
   }
);
AutoCloseable writeClose = rwMap.listeners.add(<span class="keyword">new</span> WriteListener&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;() {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> onWrite(ReadEntryView&lt;K, V&gt; written) {
      <span class="predefined-type">System</span>.out.printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Written: %s%n</span><span class="delimiter">&quot;</span></span>, written.get());
   }
);

<span class="comment">// Either wrap handler in a try section to have it auto close...</span>
<span class="keyword">try</span>(readWriteClose) {
   <span class="comment">// Create/update/remove entries using read-write functional map API</span>
   ...
}
<span class="comment">// Or close manually</span>
writeClose.close();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="marshalling_of_functions"><a class="anchor" href="#marshalling_of_functions"></a>11.10. Marshalling of Functions</h3>
<div class="paragraph">
<p>Running functional map in a cluster of nodes involves marshalling and
replication of the operation parameters under certain circumstances.</p>
</div>
<div class="paragraph">
<p>To be more precise, when write operations are executed in a cluster,
regardless of read-write or write-only operations, all the parameters
to the method and the functions are replicated to other nodes.</p>
</div>
<div class="paragraph">
<p>There are multiple ways in which a function can be marshalled. The simplest
way, which is also the most costly option in terms of payload size, is
to mark the function as
<a href="https://docs.oracle.com/javase/8/docs/api/java/io/Serializable.html"><code>Serializable</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function =
   (Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; &amp; <span class="predefined-type">Serializable</span>) wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>);

CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Infinispan provides overloads for all functional methods that make lambdas
passed directly to the API serializable by default; the compiler automatically selects
this overload if that&#8217;s possible. Therefore you can call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, wv -&gt; wv.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">one</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>without doing the cast described above.</p>
</div>
<div class="paragraph">
<p>A more economical way to marshall a function is to provide an Infinispan
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/Externalizer.html"><code>Externalizer</code></a> for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.Externalizer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.SerializeFunctionWith</span>;

WriteOnlyMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; writeOnlyMap = ...

<span class="comment">// Force a function to be Serializable</span>
Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; function = <span class="keyword">new</span> SetStringConstant&lt;&gt;();
CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; writeFuture = writeOnlyMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1</span><span class="delimiter">&quot;</span></span>, function);

<span class="annotation">@SerializeFunctionWith</span>(value = SetStringConstant.Externalizer0.class)
<span class="type">class</span> <span class="class">SetStringConstant</span> <span class="directive">implements</span> Consumer&lt;WriteEntryView&lt;<span class="predefined-type">String</span>&gt;&gt; {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> accept(WriteEntryView&lt;<span class="predefined-type">String</span>&gt; view) {
      view.set(<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>);
   }

   <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Externalizer0</span> <span class="directive">implements</span> Externalizer&lt;<span class="predefined-type">Object</span>&gt; {
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> oo, <span class="predefined-type">Object</span> o) {
         <span class="comment">// No-op</span>
      }
      <span class="directive">public</span> <span class="predefined-type">Object</span> readObject(<span class="predefined-type">ObjectInput</span> input) {
         <span class="keyword">return</span> <span class="keyword">new</span> SetStringConstant&lt;&gt;();
      }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To help users take advantage of the tiny payloads generated by
<code>Externalizer</code>-based functions, the functional API comes with a helper
class called
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>org.infinispan.commons.marshall.MarshallableFunctions</code></a>
which provides marshallable functions for some of the most commonly user
functions.</p>
</div>
<div class="paragraph">
<p>In fact, all the functions required to implement
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
using the functional map API have been defined in
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/commons/marshall/MarshallableFunctions.html"><code>MarshallableFunctions</code></a>.
For example, here is an implementation of JCache&#8217;s
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java#L283"><code>boolean putIfAbsent(K, V)</code></a>
using functional map API which can be run in a cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.functional.EntryView</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.functional.FunctionalMap</span>.*;
<span class="keyword">import</span> <span class="include">org.infinispan.commons.marshall.MarshallableFunctions</span>;

ReadWriteMap&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; readWriteMap = ...

CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; future = readWriteMap.eval(<span class="string"><span class="delimiter">&quot;</span><span class="content">key1,
   MarshallableFunctions.setValueIfAbsentReturnBoolean());
future.thenAccept(stored -&gt; System.out.printf(</span><span class="delimiter">&quot;</span></span>Value was put? %s%n<span class="string"><span class="delimiter">&quot;</span><span class="content">, stored));</span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use_cases_for_functional_api"><a class="anchor" href="#use_cases_for_functional_api"></a>11.11. Use Cases for Functional API</h3>
<div class="paragraph">
<p>This new API is meant to complement existing Key/Value Infinispan API
offerings, so you&#8217;ll still be able to use
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
or
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>
standard APIs if that&#8217;s what suits your use case best.</p>
</div>
<div class="paragraph">
<p>The target audience for this new API is either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Distributed or persistent caching/in­memory­data­grid users that want
to benefit from CompletableFuture and/or Traversable for async/lazy data
grid or caching data manipulation. The clear advantage here is that threads
do not need to be idle waiting for remote operations to complete, but
instead these can be notified when remote operations complete and then
chain them with other subsequent operations.</p>
</li>
<li>
<p>Users who want to go beyond the standard operations exposed by
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html"><code>ConcurrentMap</code></a>
and
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0/src/main/java/javax/cache/Cache.java"><code>JCache</code></a>, for example, if you want to do a replace
operation using metadata parameter equality instead of value equality, or
if you want to retrieve metadata information from values and so on.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="search_api"><a class="anchor" href="#search_api"></a>12. Indexing and Searching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides a search API that lets you index and search cache values stored as Java POJOs or as objects encoded as <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>.</p>
</div>
<div class="sect2">
<h3 id="overview_2"><a class="anchor" href="#overview_2"></a>12.1. Overview</h3>
<div class="paragraph">
<p>Searching is possible both in <a href="#query_library">library</a> and <a href="#query_remote">client/server mode</a> (for Java, C#, Node.js and other clients), and Infinispan can index data using <a href="http://lucene.apache.org/">Apache Lucene</a>, offering an efficient <a href="https://en.wikipedia.org/wiki/Full-text_search">full-text</a> capable search engine in order to cover a wide range of data retrieval use cases.</p>
</div>
<div class="paragraph">
<p>Indexing configuration relies on a schema definition, and for that Infinispan can use annotated Java classes when in library mode, and protobuf schemas for remote clients. By standardizing on protobuf, Infinispan allows full interoperability between Java and non-Java clients.</p>
</div>
<div class="paragraph">
<p>Infinispan has its own query language called <a href="#query_ickle">Ickle</a>, which is string-based and adds support for full-text searching. Ickle support searches over indexed data, partially indexed
data or non-indexed data.</p>
</div>
<div class="paragraph">
<p>Finally, Infinispan has support for <a href="#query_continuous">Continuous Queries</a>, which works in a reverse manner to the other APIs: instead of creating, executing a query
and obtain results, it allows a client to register queries that will be evaluated continuously as data in the cluster changes, generating notifications
whenever the changed data matches the queries.</p>
</div>
</div>
<div class="sect2">
<h3 id="indexing_entry_values"><a class="anchor" href="#indexing_entry_values"></a>12.2. Indexing Entry Values</h3>
<div class="paragraph">
<p>Indexing entry values in Infinispan caches dramatically improves search performance and allows you to perform full-text queries. However, indexing can degrade write throughput for Infinispan clusters. For this reason you should plan to use strategies to optimise query performance, depending on the cache mode and your use case. More information on <a href="#query_performance">query performance guide</a>.</p>
</div>
<div class="sect3">
<h4 id="configuration"><a class="anchor" href="#configuration"></a>12.2.1. Configuration</h4>
<div class="paragraph">
<p>To enable indexing via XML, you need to add the <code>&lt;indexing&gt;</code> element to your cache configuration, specify the entities that are indexed and optionally pass additional properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The presence of an <code>&lt;indexing&gt;</code> element which omits the <code>enabled</code> attribute will auto-enable indexing for your
convenience, even though the default value of the <code>enabled</code> attribute is defined as <code>"false"</code> in the XSD schema.
In the programmatic config, <code>enabled()</code> must be used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing&gt;</span>
            <span class="tag">&lt;indexed-entities&gt;</span>
               <span class="tag">&lt;indexed-entity&gt;</span>com.acme.Book<span class="tag">&lt;/indexed-entity&gt;</span>
            <span class="tag">&lt;/indexed-entities&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property.name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>some value<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache</span>.*;

ConfigurationBuilder cacheCfg = ...
cacheCfg.indexing().enable()
            .addIndexedEntity(<span class="predefined-type">Book</span>.class)
      .addProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">property name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">propery value</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specifying_indexed_entities"><a class="anchor" href="#specifying_indexed_entities"></a>12.2.2. Specifying Indexed Entities</h4>
<div class="paragraph">
<p>It is recommended to declare the indexed types, as they will be mandatory in the next Infinispan version.</p>
</div>
<div class="listingblock">
<div class="title">Declaratively</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;indexing&gt;</span>
            <span class="tag">&lt;indexed-entities&gt;</span>
                <span class="tag">&lt;indexed-entity&gt;</span>com.acme.query.test.Car<span class="tag">&lt;/indexed-entity&gt;</span>
                <span class="tag">&lt;indexed-entity&gt;</span>com.acme.query.test.Truck<span class="tag">&lt;/indexed-entity&gt;</span>
            <span class="tag">&lt;/indexed-entities&gt;</span>
         <span class="tag">&lt;/indexing&gt;</span>
      <span class="tag">&lt;/replicated-cache&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> cacheCfg.indexing()
       .addIndexedEntity(Car.class)
       .addIndexedEntity(Truck.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the cache is storing protobuf, the indexed types should be the <code>Message</code> declared in the protobuf schema.
For example, for the schema below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="proto">package book_sample;

message Book {
    optional string title = 1;
    optional string description = 2;
    optional int32 publicationYear = 3; // no native Date type available in Protobuf

    repeated Author authors = 4;
}

message Author {
    optional string name = 1;
    optional string surname = 2;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The config should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;indexing&gt;</span>
        <span class="tag">&lt;indexed-entities&gt;</span>
          <span class="tag">&lt;indexed-entity&gt;</span>book_sample.Book<span class="tag">&lt;/indexed-entity&gt;</span>
        <span class="tag">&lt;/indexed-entities&gt;</span>
      <span class="tag">&lt;/indexing&gt;</span>
    <span class="tag">&lt;/replicated-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="query_index_storage"><a class="anchor" href="#query_index_storage"></a>12.2.3. Index Storage</h4>
<div class="paragraph">
<p>Infinispan can store indexes in the file system or in memory (<code>local-heap</code>). File system is the recommended and the default configuration, and memory indexes should only be used for small to medium indexes that don&#8217;t need to survive restart.</p>
</div>
<div class="listingblock">
<div class="title">Configuration for file system indexes:</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;indexing&gt;</span>
      <span class="tag">&lt;indexed-entities&gt;</span>
         <span class="tag">&lt;indexed-entity&gt;</span>com.acme.Book<span class="tag">&lt;/indexed-entity&gt;</span>
      <span class="tag">&lt;/indexed-entities&gt;</span>
      <span class="comment">&lt;!-- Optional: this is the default setting --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>filesystem<span class="tag">&lt;/property&gt;</span>
      <span class="comment">&lt;!-- Optional: define base folder for indexes --&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexBase</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${java.io.tmpdir}/baseDir<span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Configuration for memory indexes:</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;indexing&gt;</span>
      <span class="tag">&lt;indexed-entities&gt;</span>
         <span class="tag">&lt;indexed-entity&gt;</span>com.acme.Book<span class="tag">&lt;/indexed-entity&gt;</span>
      <span class="tag">&lt;/indexed-entities&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
   <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="query_index_manager"><a class="anchor" href="#query_index_manager"></a>12.2.4. Index Manager</h4>
<div class="paragraph">
<p>Infinispan uses internally a component called "Index Manager" to control how new data is applied to the index and
when the data is visible to searches.</p>
</div>
<div class="paragraph">
<p>The default Index Manager <code>directory-based</code> writes to the index as soon as the data is written to the cache. The downside is it can slow down considerably cache writes specially under heavy writing scenarios, since it needs to do constant costly operations called "flushes" on the index.</p>
</div>
<div class="paragraph">
<p>The <code>near-real-time</code> index manager is similar to the default index manager but takes advantage of the Near-Real-Time features of Lucene. It has better write performance because it flushes the index to the underlying store less often.
The drawback is that unflushed index changes can be lost in case of a non-clean shutdown. Can be used in conjunction with <code>local-heap</code> or <code>filesystem</code>.</p>
</div>
<div class="paragraph">
<p>Example with <code>local-heap</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>near-real-time<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.directory_provider</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>local-heap<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example with <code>filesystem</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.indexmanager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>near-real-time<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="query_massindexer"><a class="anchor" href="#query_massindexer"></a>12.2.5. Rebuilding Indexes</h4>
<div class="paragraph">
<p>Rebuilding an index reconstructs it from data stored in the cache. You need to rebuild indexes if you change things like
definitions of indexed types or Analyzers. Likewise you might need to rebuild indexes if they are deleted for some reason.
Beware it might take some time as it needs to reprocess all data in the grid!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Indexer indexer = Search.getIndexer(cache);
CompletionStage&lt;<span class="predefined-type">Void</span>&gt; future = index.run();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="searching_ickle"><a class="anchor" href="#searching_ickle"></a>12.3. Searching</h3>
<div class="paragraph">
<p>Create relational and full-text queries in both Library and Remote Client-Server mode with the Ickle query language.</p>
</div>
<div class="paragraph">
<p>To use the API, first obtain a QueryFactory to the cache and then call the <code>.create()</code> method, passing in the string
to use in the query. Each <code>QueryFactory</code> instance is bound to the same <code>Cache</code> instance as the <code>Search</code>, but it is
otherwise a stateless and thread-safe object that can be used for creating multiple queries in parallel.</p>
</div>
<div class="paragraph">
<p>For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Remote Query, using protobuf</span>
QueryFactory qf = org.infinispan.client.hotrod.Search.getQueryFactory(remoteCache);
<span class="predefined-type">Query</span> q = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from sample_bank_account.Transaction where amount &gt; 20</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Embedded Query using Java Objects</span>
QueryFactory qf = org.infinispan.query.Search.getQueryFactory(cache);
<span class="predefined-type">Query</span> q = qf.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">from com.acme.Book where price &gt; 20</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Execute the query</span>
QueryResult&lt;<span class="predefined-type">Book</span>&gt; queryResult = q.execute();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A query will always target a single entity type and is evaluated over the contents of a single cache. Running a
query over multiple caches or creating queries that target several entity types (joins) is not supported.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Executing the query and fetching the results is as simple as invoking the <code>run()</code> method of the <code>Query</code> object. Once
executed, calling <code>run()</code> on the same instance will re-execute the query.</p>
</div>
<div class="sect3">
<h4 id="pagination"><a class="anchor" href="#pagination"></a>12.3.1. Pagination</h4>
<div class="paragraph">
<p>You can limit the number of returned results by using  the <code>Query.maxResults(int maxResults)</code>. This can be used in
conjunction with <code>Query.startOffset(long startOffset)</code> to achieve pagination of the result set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// sorted by year and match all books that have &quot;clustering&quot; in their title</span>
<span class="comment">// and return the third page of 10 results</span>
<span class="predefined-type">Query</span>&lt;<span class="predefined-type">Book</span>&gt; query = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM com.acme.Book WHERE title like '%clustering%' ORDER BY year</span><span class="delimiter">&quot;</span></span>).startOffset(<span class="integer">20</span>).maxResults(<span class="integer">10</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="number_of_hits"><a class="anchor" href="#number_of_hits"></a>12.3.2. Number of Hits</h4>
<div class="paragraph">
<p>The <code>QueryResult</code> object has the <code>.hitCount()</code> method to return the total number of results of the query, regardless
of any pagination parameter. The hit count is only available for indexed queries for performance reasons.</p>
</div>
</div>
<div class="sect3">
<h4 id="iteration"><a class="anchor" href="#iteration"></a>12.3.3. Iteration</h4>
<div class="paragraph">
<p>The <code>Query</code> object has the <code>.iterator()</code> method to obtain the results lazily. It returns an instance of <code>CloseableIterator</code> that must be closed after usage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The iteration support for Remote Queries is currently limited, as it will first fetch all entries to the client
before iterating.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="using_named_query_parameters"><a class="anchor" href="#using_named_query_parameters"></a>12.3.4. Using Named Query Parameters</h4>
<div class="paragraph">
<p>Instead of building a new Query object for every execution it is possible to include named parameters in the query which
can be substituted with actual values before execution. This allows a query to be defined once and be efficiently
executed many times. Parameters can only be used on the right-hand side of an operator and are defined when the query is
created by supplying an object produced by the <code>org.infinispan.query.dsl.Expression.param(String paramName)</code> method to
the operator instead of the usual constant value. Once the parameters have been defined they can be set by invoking either
<code>Query.setParameter(parameterName, value)</code> or <code>Query.setParameters(parameterMap)</code> as shown in the examples below.
⁠</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QueryFactory queryFactory = Search.getQueryFactory(cache);
<span class="comment">// Defining a query to search for various authors and publication years</span>
<span class="predefined-type">Query</span>&lt;<span class="predefined-type">Book</span>&gt; query = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM com.acme.Book WHERE author = :authorName AND publicationYear = :publicationYear</span><span class="delimiter">&quot;</span></span>).build();

<span class="comment">// Set actual parameter values</span>
query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>);
query.setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, <span class="integer">2010</span>);

<span class="comment">// Execute the query</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; found = query.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can supply a map of actual parameter values to set multiple parameters at once:
⁠</p>
</div>
<div class="listingblock">
<div class="title">Setting multiple named parameters at once</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; parameterMap = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
parameterMap.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">authorName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Doe</span><span class="delimiter">&quot;</span></span>);
parameterMap.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">publicationYear</span><span class="delimiter">&quot;</span></span>, <span class="integer">2010</span>);

query.setParameters(parameterMap);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A significant portion of the query parsing, validation and execution planning effort is performed during the first
execution of a query with parameters. This effort is not repeated during subsequent executions leading to better
performance compared to a similar query using constant values instead of query parameters.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="query_ickle"><a class="anchor" href="#query_ickle"></a>12.3.5. Ickle Query Language Parser Syntax</h4>
<div class="paragraph">
<p>The Ickle query language is small subset of the <a href="https://en.wikipedia.org/wiki/Java_Persistence_Query_Language">JPQL</a>
query language, with some extensions for full-text.</p>
</div>
<div class="paragraph">
<p>The parser syntax has some notable rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whitespace is not significant.</p>
</li>
<li>
<p>Wildcards are not supported in field names.</p>
</li>
<li>
<p>A field name or path must always be specified, as there is no default field.</p>
</li>
<li>
<p><code>&amp;&amp;</code> and <code>||</code> are accepted instead of <code>AND</code> or <code>OR</code> in both full-text and JPA predicates.</p>
</li>
<li>
<p><code>!</code> may be used instead of <code>NOT</code>.</p>
</li>
<li>
<p>A missing boolean operator is interpreted as <code>OR</code>.</p>
</li>
<li>
<p>String terms must be enclosed with either single or double quotes.</p>
</li>
<li>
<p>Fuzziness and boosting are not accepted in arbitrary order; fuzziness always comes first.</p>
</li>
<li>
<p><code>!=</code> is accepted instead of <code>&lt;&gt;</code>.</p>
</li>
<li>
<p>Boosting cannot be applied to <code>&gt;</code>,<code>&gt;=</code>,<code>&lt;</code>,<code>&#8656;</code> operators. Ranges may be used to achieve the same result.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="filtering_operators"><a class="anchor" href="#filtering_operators"></a>Filtering operators</h5>
<div class="paragraph">
<p>Ickle support many filtering operators that can be used for both indexed and non-indexed fields.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left operand is equal to one of the elements from the Collection of values given as argument.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE isbn IN ('ZZ', 'X1234')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">like</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument (which is expected to be a String) matches a wildcard pattern that follows the JPA rules.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE title LIKE '%Java%'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is an exact match of the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE name = 'Programming Java'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is different from the given value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE language != 'English'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE price &gt; 20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is greater than or equal to the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE price &gt;= 20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE year &lt; 2012</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is less than or equal to the given value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE price  &#8656; 50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">between</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checks that the left argument is between the given range limits.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM Book WHERE price BETWEEN 50 AND 100</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="boolean_conditions"><a class="anchor" href="#boolean_conditions"></a>Boolean conditions</h5>
<div class="paragraph">
<p>Combining multiple attribute conditions with logical conjunction (<code>and</code>) and disjunction (<code>or</code>) operators in order to
create more complex conditions is demonstrated in the following example. The well known operator precedence rule for
boolean operators applies here, so the order of the operators is irrelevant. Here <code>and</code>
operator still has higher priority than <code>or</code> even though <code>or</code> was invoked first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment"># match all books that have &quot;Data Grid&quot; in their title</span>
<span class="comment"># or have an author named &quot;Manik&quot; and their description contains &quot;clustering&quot;</span>

<span class="keyword">FROM</span> com.acme.Book <span class="keyword">WHERE</span> title <span class="keyword">LIKE</span> <span class="string"><span class="delimiter">'</span><span class="content">%Data Grid%</span><span class="delimiter">'</span></span> <span class="keyword">OR</span> author.name = <span class="string"><span class="delimiter">'</span><span class="content">Manik</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> description <span class="keyword">like</span> <span class="string"><span class="delimiter">'</span><span class="content">%clustering%</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Boolean negation has highest precedence among logical operators and applies only to the next simple attribute condition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment"># match all books that do not have &quot;Data Grid&quot; in their title and are authored by &quot;Manik&quot;</span>
<span class="keyword">FROM</span> com.acme.Book <span class="keyword">WHERE</span> title != <span class="string"><span class="delimiter">'</span><span class="content">Data Grid</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> author.name = <span class="string"><span class="delimiter">'</span><span class="content">Manik</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="nested_conditions"><a class="anchor" href="#nested_conditions"></a>Nested conditions</h5>
<div class="paragraph">
<p>Changing the precedence of logical operators is achieved with parenthesis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment"># match all books that have an author named &quot;Manik&quot; and their title contains</span>
<span class="comment"># &quot;Data Grid&quot; or their description contains &quot;clustering&quot;</span>
<span class="keyword">FROM</span> com.acme.Book <span class="keyword">WHERE</span> author.name = <span class="string"><span class="delimiter">'</span><span class="content">Manik</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> ( title <span class="keyword">like</span> <span class="string"><span class="delimiter">'</span><span class="content">%Data Grid%</span><span class="delimiter">'</span></span> <span class="keyword">OR</span> description <span class="keyword">like</span> <span class="string"><span class="delimiter">'</span><span class="content">% clustering%</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="selecting_attributes"><a class="anchor" href="#selecting_attributes"></a>Selecting attributes</h5>
<div class="paragraph">
<p>In some use cases returning the whole domain object is overkill if only a small subset of the attributes are actually
used by the application, especially if the domain entity has embedded entities. The query language allows you to specify
a subset of attributes (or attribute paths) to return - the projection. If projections are used then the <code>QueryResult.list()</code>
will not return the whole domain entity but will return a <code>List</code> of <code>Object[]</code>, each slot in the array corresponding to
a projected attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment"># match all books that have &quot;Data Grid&quot; in their title or description</span>
<span class="comment"># and return only their title and publication year</span>
<span class="class">SELECT</span> title, publicationYear <span class="keyword">FROM</span> com.acme.Book <span class="keyword">WHERE</span> title <span class="keyword">like</span> <span class="string"><span class="delimiter">'</span><span class="content">%Data Grid%</span><span class="delimiter">'</span></span> <span class="keyword">OR</span> description <span class="keyword">like</span> <span class="string"><span class="delimiter">'</span><span class="content">%Data Grid%</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sorting"><a class="anchor" href="#sorting"></a>Sorting</h5>
<div class="paragraph">
<p>Ordering the results based on one or more attributes or attribute paths is done with the <code>ORDER BY</code> clause. If multiple sorting criteria
are specified, then the order will dictate their precedence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment"># match all books that have &quot;Data Grid&quot; in their title or description</span>
<span class="comment"># and return them sorted by the publication year and title</span>
<span class="keyword">FROM</span> com.acme.Book <span class="keyword">WHERE</span> title <span class="keyword">like</span> <span class="string"><span class="delimiter">'</span><span class="content">%Data Grid%</span><span class="delimiter">'</span></span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> publicationYear <span class="directive">DESC</span>, title <span class="directive">ASC</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="grouping_and_aggregation"><a class="anchor" href="#grouping_and_aggregation"></a>Grouping and Aggregation</h5>
<div class="paragraph">
<p>Infinispan has the ability to group query results according to a set of grouping fields and construct aggregations of
the results from each group by applying an aggregation function to the set of values that fall into each group.
Grouping and aggregation can only be applied to projection queries (queries with one or more field in the SELECT clause).</p>
</div>
<div class="paragraph">
<p>The supported aggregations are: avg, sum, count, max, min.</p>
</div>
<div class="paragraph">
<p>The set of grouping fields is specified with the <code>GROUP BY</code> clause and the order used for defining grouping fields is
not relevant. All fields selected in the projection must either be grouping fields
or else they must be aggregated using one of the grouping functions described below. A projection field can be
aggregated and used for grouping at the same time. A query that selects only grouping fields but no aggregation fields
is legal.
⁠
Example: Grouping Books by author and counting them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> author, <span class="predefined">COUNT</span>(title) <span class="keyword">FROM</span> com.acme.Book <span class="keyword">WHERE</span> title <span class="keyword">LIKE</span> <span class="string"><span class="delimiter">'</span><span class="content">%engine%</span><span class="delimiter">'</span></span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> author</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A projection query in which all selected fields have an aggregation function applied and no fields are used for
grouping is allowed. In this case the aggregations will be computed globally as if there was a single global group.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="aggregations"><a class="anchor" href="#aggregations"></a>Aggregations</h5>
<div class="paragraph">
<p>The following aggregation functions can be applied to a field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>avg()</code> - Computes the average of a set of numbers. Accepted values are primitive numbers and instances of <code>java.lang.Number</code>. The result is represented as <code>java.lang.Double</code>. If there are no non-null values the result is <code>null</code> instead.</p>
</li>
<li>
<p><code>count()</code> - Counts the number of non-null rows and returns a <code>java.lang.Long</code>. If there are no non-null values the result is <code>0</code> instead.</p>
</li>
<li>
<p><code>max()</code> - Returns the greatest value found. Accepted values must be instances of <code>java.lang.Comparable</code>. If there are no non-null values the result is <code>null</code> instead.</p>
</li>
<li>
<p><code>min()</code> - Returns the smallest value found. Accepted values must be instances of <code>java.lang.Comparable</code>. If there are no non-null values the result is <code>null</code> instead.</p>
</li>
<li>
<p><code>sum()</code> - Computes the sum of a set of Numbers. If there are no non-null values the result is <code>null</code> instead. The following table indicates the return type based on the specified field.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Table sum return type</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field Type</th>
<th class="tableblock halign-left valign-top">Return Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integral (other than BigInteger)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float or Double</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigInteger</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigDecimal</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="evaluation_of_queries_with_grouping_and_aggregation"><a class="anchor" href="#evaluation_of_queries_with_grouping_and_aggregation"></a>Evaluation of queries with grouping and aggregation</h5>
<div class="paragraph">
<p>Aggregation queries can include filtering conditions, like usual queries. Filtering can be performed in two stages: before
and after the grouping operation. All filter conditions defined before invoking the <code>groupBy()</code> method will be applied
before the grouping operation is performed, directly to the cache entries (not to the final projection). These filter
conditions can reference any fields of the queried entity type, and are meant to restrict the data set that is going to
be the input for the grouping stage. All filter conditions defined after invoking the <code>groupBy()</code> method will be applied to
the projection that results from the projection and grouping operation. These filter conditions can either reference any
of the <code>groupBy()</code> fields or aggregated fields. Referencing aggregated fields that are not specified in the select clause
is allowed; however, referencing non-aggregated and non-grouping fields is forbidden. Filtering in this phase will
reduce the amount of groups based on their properties. Sorting can also be specified similar to usual queries. The
ordering operation is performed after the grouping operation and can reference any of the <code>groupBy()</code> fields or aggregated
fields.</p>
</div>
</div>
<div class="sect4">
<h5 id="using_full_text_search"><a class="anchor" href="#using_full_text_search"></a>Using Full-text search</h5>
<div class="sect5">
<h6 id="fuzzy_queries"><a class="anchor" href="#fuzzy_queries"></a>Fuzzy Queries</h6>
<div class="paragraph">
<p>To execute a fuzzy query add <code>~</code> along with an integer, representing the distance from the term used, after the term.
For instance</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_bank_account.Transaction <span class="keyword">WHERE</span> description : <span class="string"><span class="delimiter">'</span><span class="content">cofee</span><span class="delimiter">'</span></span>~<span class="integer">2</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="range_queries"><a class="anchor" href="#range_queries"></a>Range Queries</h6>
<div class="paragraph">
<p>To execute a range query define the given boundaries within a pair of braces, as seen in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_bank_account.Transaction <span class="keyword">WHERE</span> amount : [<span class="integer">20</span> <span class="keyword">to</span> <span class="integer">50</span>]</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="phrase_queries"><a class="anchor" href="#phrase_queries"></a>Phrase Queries</h6>
<div class="paragraph">
<p>A group of words can be searched by surrounding them in quotation marks, as seen in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_bank_account.Transaction <span class="keyword">WHERE</span> description : <span class="string"><span class="delimiter">'</span><span class="content">bus fare</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="proximity_queries"><a class="anchor" href="#proximity_queries"></a>Proximity Queries</h6>
<div class="paragraph">
<p>To execute a proximity query, finding two terms within a specific distance, add a <code>~</code> along with the distance after the phrase.
For instance, the following example will find the words canceling and fee provided they are not more than 3 words apart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_bank_account.Transaction <span class="keyword">WHERE</span> description : <span class="string"><span class="delimiter">'</span><span class="content">canceling fee</span><span class="delimiter">'</span></span>~<span class="integer">3</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="wildcard_queries"><a class="anchor" href="#wildcard_queries"></a>Wildcard Queries</h6>
<div class="paragraph">
<p>To search for "text" or "test", use the <code>?</code> single-character wildcard search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_bank_account.Transaction <span class="keyword">where</span> description : <span class="string"><span class="delimiter">'</span><span class="content">te?t</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To search for "test", "tests", or "tester", use the <code>*</code> multi-character wildcard search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_bank_account.Transaction <span class="keyword">where</span> description : <span class="string"><span class="delimiter">'</span><span class="content">test*</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="regular_expression_queries"><a class="anchor" href="#regular_expression_queries"></a>Regular Expression Queries</h6>
<div class="paragraph">
<p>Regular expression queries can be performed by specifying a pattern between <code>/</code>. Ickle uses Lucene’s regular expression syntax, so to search for the words <code>moat</code> or <code>boat</code> the following could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_library.Book  <span class="keyword">where</span> title : /[mb]oat/</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="boosting_queries"><a class="anchor" href="#boosting_queries"></a>Boosting Queries</h6>
<div class="paragraph">
<p>Terms can be boosted by adding a <code>^</code> after the term to increase their relevance in a given query, the higher the boost factor the more relevant the term will be. For instance to search for titles containing beer and wine with a higher relevance on beer, by a factor of 3, the following could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> sample_library.Book <span class="keyword">WHERE</span> title : beer^<span class="integer">3</span> <span class="keyword">OR</span> wine</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query_library"><a class="anchor" href="#query_library"></a>12.4. Embedded Search</h3>
<div class="paragraph">
<p>Embedded searching is available when Infinispan is used as a library. No protobuf mapping is required, and both indexing and searching are done on top of Java objects.</p>
</div>
<div class="sect3">
<h4 id="quick_example"><a class="anchor" href="#quick_example"></a>12.4.1. Quick example</h4>
<div class="paragraph">
<p>We&#8217;re going to store <code>Book</code> instances in an Infinispan cache called "books". <code>Book</code> instances will be indexed, so we enable indexing for the cache:</p>
</div>
<div class="paragraph">
<p>Infinispan configuration:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
    <span class="tag">&lt;cache-container&gt;</span>
        <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-cluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;indexing&gt;</span>
                <span class="tag">&lt;indexed-entities&gt;</span>
                    <span class="tag">&lt;indexed-entity&gt;</span>com.acme.Book<span class="tag">&lt;/indexed-entity&gt;</span>
                <span class="tag">&lt;/indexed-entities&gt;</span>
            <span class="tag">&lt;/indexing&gt;</span>
        <span class="tag">&lt;/distributed-cache&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Obtaining the cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.EmbeddedCacheManager</span>;

EmbeddedCacheManager manager = <span class="keyword">new</span> DefaultCacheManager(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan.xml</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Book</span>&gt; cache = manager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>Book</code> will be defined as in the following example; we have to choose which properties are indexed, and for each property we can optionally choose advanced indexing options using the annotations defined in the Hibernate Search project.</p>
</div>
<div class="listingblock">
<div class="title">Book.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.hibernate.search.annotations</span>.*;
<span class="keyword">import</span> <span class="include">java.util.Date</span>;
<span class="keyword">import</span> <span class="include">java.util.HashSet</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;

<span class="comment">//Values you want to index need to be annotated with @Indexed, then you pick which fields and how they are to be indexed:</span>
<span class="annotation">@Indexed</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> title;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> description;
   <span class="annotation">@Field</span> <span class="annotation">@DateBridge</span>(resolution=Resolution.YEAR) <span class="predefined-type">Date</span> publicationYear;
   <span class="annotation">@IndexedEmbedded</span> <span class="predefined-type">Set</span>&lt;Author&gt; authors = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;Author&gt;();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Author.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Author</span> {
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> name;
   <span class="annotation">@Field</span> <span class="predefined-type">String</span> surname;
   <span class="comment">// hashCode() and equals() omitted</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now assuming we stored several <code>Book</code> instances in our Infinispan <code>Cache</code> , we can search them for any matching field as in the following example.</p>
</div>
<div class="listingblock">
<div class="title">QueryExample.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// get the query factory from the cache:</span>
QueryFactory queryFactory = org.infinispan.query.Search.getQueryFactory(cache);

<span class="comment">// create an Ickle query that will do a full-text search (operator ':') on fields 'title' and 'authors.name'</span>
<span class="predefined-type">Query</span>&lt;<span class="predefined-type">Book</span>&gt; fullTextQuery = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM com.acme.Book WHERE title:'infinispan' AND authors.name:'sanne'</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// The ('=') operator is not a full-text operator, thus can be used in both indexed and non-indexed caches</span>
<span class="predefined-type">Query</span>&lt;<span class="predefined-type">Book</span>&gt; exactMatchQuery = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM com.acme.Book WHERE title = 'Programming Infinispan' AND authors.name = 'Sanne Grinnovero'</span><span class="delimiter">&quot;</span></span>)

<span class="comment">// Full-text and non-full text operators can be part of the same query</span>
<span class="predefined-type">Query</span> q = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM com.query.Book b where b.author.name = 'Stephen' and b.description : (+'dark' -'tower')</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// get the results</span>
<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; found=query.execute().list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apart from <code>list()</code> you have the option for obtaining on <code>iterator()</code>, or use pagination.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping_embedded"><a class="anchor" href="#mapping_embedded"></a>12.4.2. Mapping Entities</h4>
<div class="paragraph">
<p>Infinispan relies on the rich API of <a href="http://hibernate.org/search/">Hibernate Search</a> in order to define fine grained configuration for indexing at entity level.
This configuration includes which fields are annotated, which analyzers should be used, how to map nested objects and so on.
Detailed documentation is available at <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-mapping">the Hibernate Search manual</a>.</p>
</div>
<div class="sect4">
<h5 id="documentid"><a class="anchor" href="#documentid"></a>@DocumentId</h5>
<div class="paragraph">
<p>Unlike Hibernate Search, using <code>@DocumentId</code> to mark a field as identifier does not apply to Infinispan values; in Infinispan the identifier for all <code>@Indexed</code> objects is the key used to store the value. You can still customize how the key is indexed using a combination of <code>@Transformable</code> , custom types and custom <code>FieldBridge</code> implementations.</p>
</div>
</div>
<div class="sect4">
<h5 id="transformable_keys"><a class="anchor" href="#transformable_keys"></a>@Transformable keys</h5>
<div class="paragraph">
<p>The key for each value needs to be indexed as well, and the key instance must be transformed in a <code>String</code>. Infinispan includes some default transformation routines to encode common primitives, but to use a custom key you must provide an implementation of <code>org.infinispan.query.Transformer</code> .</p>
</div>
<div class="paragraph">
<p><strong class="small">Registering a key Transformer via annotations</strong></p>
</div>
<div class="paragraph">
<p>You can annotate your key class with <code>org.infinispan.query.Transformable</code> and your custom transformer implementation
will be picked up automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transformable</span>(transformer = CustomTransformer.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomKey</span> {
   ...
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">CustomTransformer</span> <span class="directive">implements</span> <span class="predefined-type">Transformer</span> {
   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">Object</span> fromString(<span class="predefined-type">String</span> s) {
      ...
      return <span class="keyword">new</span> CustomKey(...);
   }

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="predefined-type">String</span> toString(<span class="predefined-type">Object</span> customType) {
      CustomKey ck = (CustomKey) customType;
      <span class="keyword">return</span> ...
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong class="small">Registering a key Transformer via the cache indexing configuration</strong></p>
</div>
<div class="paragraph">
<p>Use the <code>key-transformers</code> xml element in both embedded and server config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing</span> <span class="attribute-name">auto-config</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;key-transformers&gt;</span>
            <span class="tag">&lt;key-transformer</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomKey</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transformer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomTransformer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/key-transformers&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/replicated-cache&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, use the Java configuration API (embedded mode):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   ConfigurationBuilder builder = ...
   builder.indexing().enable()
         .addKeyTransformer(CustomKey.class, CustomTransformer.class);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query_configuration_api"><a class="anchor" href="#query_configuration_api"></a>Programmatic mapping</h5>
<div class="paragraph">
<p>Instead of using annotations to map an entity to the index, it&#8217;s also possible to configure it programmatically.</p>
</div>
<div class="paragraph">
<p>In the following example we map an object <code>Author</code> which is to be stored in the grid and made searchable on two properties but without annotating the class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.search.Query</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.Environment</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.SearchMapping</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.query.dsl.QueryBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.configuration.cache.Index</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.manager.DefaultCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.CacheQuery</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.SearchManager</span>;

<span class="keyword">import</span> <span class="include">java.io.IOException</span>;
<span class="keyword">import</span> <span class="include">java.lang.annotation.ElementType</span>;
<span class="keyword">import</span> <span class="include">java.util.Properties</span>;

SearchMapping mapping = <span class="keyword">new</span> SearchMapping();
mapping.entity(Author.class).indexed()
       .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field()
       .property(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">ElementType</span>.METHOD).field();

<span class="predefined-type">Properties</span> properties = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
properties.put(Environment.MODEL_MAPPING, mapping);
properties.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hibernate.search.[other options]</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">[...]</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">Configuration</span> infinispanConfiguration = <span class="keyword">new</span> ConfigurationBuilder()
        .indexing().index(Index.NONE)
        .withProperties(properties)
        .build();

DefaultCacheManager cacheManager = <span class="keyword">new</span> DefaultCacheManager(infinispanConfiguration);

Cache&lt;<span class="predefined-type">Long</span>, Author&gt; cache = cacheManager.getCache();
SearchManager sm = Search.getSearchManager(cache);

Author author = <span class="keyword">new</span> Author(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Surtani</span><span class="delimiter">&quot;</span></span>);
cache.put(author.getId(), author);

QueryBuilder qb = sm.buildQueryBuilderForClass(Author.class).get();
<span class="predefined-type">Query</span> q = qb.keyword().onField(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).matching(<span class="string"><span class="delimiter">&quot;</span><span class="content">Manik</span><span class="delimiter">&quot;</span></span>).createQuery();
CacheQuery cq = sm.getQuery(q, Author.class);
<span class="keyword">assert</span> cq.getResultSize() == <span class="integer">1</span>;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query_remote"><a class="anchor" href="#query_remote"></a>12.5. Remote Search</h3>
<div class="paragraph">
<p>Remote search is very similar to embedded with the notable difference that data must use
<a href="http://code.google.com/p/protobuf/">Google Protocol Buffers</a> as an encoding for both over-the-wire and storage.
Furthermore, it&#8217;s necessary to write (or generate from Java classes) a protobuf schema defining the data structure and indexing elements instead of relying on Hibernate Search annotations.</p>
</div>
<div class="paragraph">
<p>The usage of protobuf allows remote query to work not only for Java, but for REST, C# and Node.js clients.</p>
</div>
<div class="sect3">
<h4 id="remote_query_example"><a class="anchor" href="#remote_query_example"></a>12.5.1. A remote query example</h4>
<div class="paragraph">
<p>We are going to revisit the Book Sample from embedded query, but this time using the Java Hot Rod client and the
Infinispan server.
An object called <code>Book</code> will be stored in a Infinispan cache called "books". Book instances will be indexed, so we enable
indexing for the cache:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;indexing&gt;</span>
        <span class="tag">&lt;indexed-entities&gt;</span>
          <span class="tag">&lt;indexed-entity&gt;</span>book_sample.Book<span class="tag">&lt;/indexed-entity&gt;</span>
        <span class="tag">&lt;/indexed-entities&gt;</span>
      <span class="tag">&lt;/indexing&gt;</span>
    <span class="tag">&lt;/replicated-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if indexing the cache is not indexed, we configure the <code>&lt;encoding&gt;</code> as <code>application/x-protostream</code> to make sure
the storage is queryable:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
  <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;encoding</span> <span class="attribute-name">media-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">application/x-protostream</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/replicated-cache&gt;</span>
  <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each <code>Book</code> will be defined as in the following example: we use <code>@Protofield</code> annotations to identify the
protocol buffers message fields and the <code>@ProtoDoc</code> annotation on the fields to configure indexing attributes:</p>
</div>
<div class="listingblock">
<div class="title">Book.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoDoc</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.ProtoField</span>;

<span class="annotation">@ProtoDoc</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">@Indexed</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {

   <span class="annotation">@ProtoDoc</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">@Field(index=Index.YES, analyze = Analyze.YES, store = Store.NO)</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@ProtoField</span>(number = <span class="integer">1</span>)
   <span class="directive">final</span> <span class="predefined-type">String</span> title;

   <span class="annotation">@ProtoDoc</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">@Field(index=Index.YES, analyze = Analyze.YES, store = Store.NO)</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@ProtoField</span>(number = <span class="integer">2</span>)
   <span class="directive">final</span> <span class="predefined-type">String</span> description;

   <span class="annotation">@ProtoDoc</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">@Field(index=Index.YES, analyze = Analyze.YES, store = Store.NO)</span><span class="delimiter">&quot;</span></span>)
   <span class="annotation">@ProtoField</span>(number = <span class="integer">3</span>, defaultValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
   <span class="directive">final</span> <span class="type">int</span> publicationYear;


   <span class="annotation">@ProtoFactory</span>
   <span class="predefined-type">Book</span>(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> description, <span class="type">int</span> publicationYear) {
      <span class="local-variable">this</span>.title = title;
      <span class="local-variable">this</span>.description = description;
      <span class="local-variable">this</span>.publicationYear = publicationYear;
   }
   <span class="comment">// public Getter methods omitted for brevity</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotations above will generate during compilation the artifacts necessary to read, write  and query <code>Book</code> instances. To enable this generation, use the <code>@AutoProtoSchemaBuilder</code> annotation in a newly created class with empty constructor or interface:</p>
</div>
<div class="listingblock">
<div class="title">RemoteQueryInitializer.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.protostream.SerializationContextInitializer</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.protostream.annotations.AutoProtoSchemaBuilder</span>;

<span class="annotation">@AutoProtoSchemaBuilder</span>(
      includeClasses = {
            <span class="predefined-type">Book</span>.class
      },
      schemaFileName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book.proto</span><span class="delimiter">&quot;</span></span>,
      schemaFilePath = <span class="string"><span class="delimiter">&quot;</span><span class="content">proto/</span><span class="delimiter">&quot;</span></span>,
      schemaPackageName = <span class="string"><span class="delimiter">&quot;</span><span class="content">book_sample</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">RemoteQueryInitializer</span> <span class="directive">extends</span> SerializationContextInitializer {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After compilation, a file <code>book.proto</code> file will be created in the configured <code>schemaFilePath</code>, along with an implementation
<code>RemoteQueryInitializerImpl.java</code> of the annotated interface. This concrete class can be used directly in the Hot Rod client
code to initialize the serialization context.</p>
</div>
<div class="paragraph">
<p>Putting all together:</p>
</div>
<div class="listingblock">
<div class="title">RemoteQuery.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.infinispan</span>;

<span class="keyword">import</span> <span class="include">java.nio.file.Files</span>;
<span class="keyword">import</span> <span class="include">java.nio.file.Path</span>;
<span class="keyword">import</span> <span class="include">java.nio.file.Paths</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.RemoteCache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.RemoteCacheManager</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.client.hotrod.configuration.ConfigurationBuilder</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.remote.client.ProtobufMetadataManagerConstants</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">RemoteQuery</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) <span class="directive">throws</span> <span class="exception">Exception</span> {
      ConfigurationBuilder clientBuilder = <span class="keyword">new</span> ConfigurationBuilder();
      <span class="comment">// RemoteQueryInitializerImpl is generated</span>
      clientBuilder.addServer().host(<span class="string"><span class="delimiter">&quot;</span><span class="content">127.0.0.1</span><span class="delimiter">&quot;</span></span>).port(<span class="integer">11222</span>)
            .security().authentication().username(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>).password(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>)
            .addContextInitializers(<span class="keyword">new</span> RemoteQueryInitializerImpl());

      RemoteCacheManager remoteCacheManager = <span class="keyword">new</span> RemoteCacheManager(clientBuilder.build());

      <span class="comment">// Grab the generated protobuf schema and registers in the server.</span>
      Path proto = Paths.get(RemoteQuery.class.getClassLoader()
            .getResource(<span class="string"><span class="delimiter">&quot;</span><span class="content">proto/book.proto</span><span class="delimiter">&quot;</span></span>).toURI());
      <span class="predefined-type">String</span> protoBufCacheName = ProtobufMetadataManagerConstants.PROTOBUF_METADATA_CACHE_NAME;
      remoteCacheManager.getCache(protoBufCacheName).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">book.proto</span><span class="delimiter">&quot;</span></span>, Files.readString(proto));

      <span class="comment">// Obtain the 'books' remote cache</span>
      RemoteCache&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; remoteCache = remoteCacheManager.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">books</span><span class="delimiter">&quot;</span></span>);

      <span class="comment">// Add some Books</span>
      <span class="predefined-type">Book</span> book1 = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan in Action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Learn Infinispan with using it</span><span class="delimiter">&quot;</span></span>, <span class="integer">2015</span>);
      <span class="predefined-type">Book</span> book2 = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cloud-Native Applications with Java and Quarkus</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Build robust and reliable cloud applications</span><span class="delimiter">&quot;</span></span>, <span class="integer">2019</span>);

      remoteCache.put(<span class="integer">1</span>, book1);
      remoteCache.put(<span class="integer">2</span>, book2);

      <span class="comment">// Execute a full-text query</span>
      QueryFactory queryFactory = Search.getQueryFactory(remoteCache);
      <span class="predefined-type">Query</span>&lt;<span class="predefined-type">Book</span>&gt; query = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM book_sample.Book WHERE title:'java'</span><span class="delimiter">&quot;</span></span>);

      <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; list = query.execute().list(); <span class="comment">// Voila! We have our book back from the cache!</span>
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enable_indexing"><a class="anchor" href="#enable_indexing"></a>12.5.2. Indexing of Protobuf encoded entries</h4>
<div class="paragraph">
<p>As seen in <a href="#remote_query_example">Remote Query example</a>, one step necessary to query protobuf entities
is to provide the client and server with the relevant metadata about entities (.proto file).</p>
</div>
<div class="paragraph">
<p>The descriptors are stored in a dedicated cache on the server named <code>___protobuf_metadata</code>.
Both keys and values in this cache are plain strings. Registering a new schema is therefore as simple as performing a <code>put()</code> operation on this cache using the schema&#8217;s name as key and the schema file itself as the value.</p>
</div>
<div class="paragraph">
<p>Alternatively you can use the CLI (via the <code>cache-container=*:register-proto-schemas()</code> operation),
the Management Console, the REST endpoint <code>/rest/v2/schemas</code> or the <code>ProtobufMetadataManager</code> MBean via JMX.
Be aware that, when security is enabled, access to the schema cache via the remote protocols requires
that the user belongs to the '___schema_manager' role.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if indexing is enabled for a cache no fields of Protobuf encoded entries will be indexed unless you use
the <code>@Indexed</code> and <code>@Field</code> inside protobuf schema documentation annotations <code>(@ProtoDoc)</code>  to specify what fields need to get indexed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="analysis"><a class="anchor" href="#analysis"></a>12.5.3. Analysis</h4>
<div class="paragraph">
<p>Analysis is a process that converts input data into one or more terms that you can index and query.
While in <a href="#mapping_embedded">Embedded Query</a> mapping is done through <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_analysis">Hibernate Search annotations</a>, that supports
a rich set of Lucene based analyzers, in client-server mode the analyzer definitions are declared in a platform neutral way</p>
</div>
<div class="sect4">
<h5 id="default_analyzers"><a class="anchor" href="#default_analyzers"></a>Default Analyzers</h5>
<div class="paragraph">
<p>Infinispan provides a set of default analyzers for remote query as follows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into tokens, treating whitespace and punctuation as delimiters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tokenizes input streams by delimiting at non-letters and then converting all letters to lowercase characters. Whitespace and non-letters are discarded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>whitespace</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text streams on whitespace and returns sequences of non-whitespace characters as tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keyword</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Treats entire text fields as single tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stemmer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stems English words using the Snowball Porter filter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ngram</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generates n-gram tokens that are 3 grams in size by default.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>filename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Splits text fields into larger size tokens than the <code>standard</code> analyzer, treating whitespace as a delimiter and converts all letters to lowercase characters.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These analyzer definitions are based on Apache Lucene and are provided "as-is".
For more information about tokenizers, filters, and CharFilters, see the
appropriate Lucene documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="using_analyzer_definitions"><a class="anchor" href="#using_analyzer_definitions"></a>Using Analyzer Definitions</h5>
<div class="paragraph">
<p>To use analyzer definitions, reference them by name in the <code>.proto</code> schema file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Include the <code>Analyze.YES</code> attribute to indicate that the property is analyzed.</p>
</li>
<li>
<p>Specify the analyzer definition with the <code>@Analyzer</code> annotation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows referenced analyzer definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="protobuf">/* @Indexed */
message TestEntity {

    /* @Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = &quot;keyword&quot;)) */
    optional string id = 1;

    /* @Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = &quot;simple&quot;)) */
    optional string name = 2;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using Java classes annotated with <code>@ProtoField</code>, the declaration is similar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="annotation">@ProtoDoc</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">@Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = </span><span class="char">\&quot;</span><span class="content">keyword</span><span class="char">\&quot;</span><span class="content">))</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@ProtoField</span>(number = <span class="integer">1</span>)
<span class="directive">final</span> <span class="predefined-type">String</span> id;

<span class="annotation">@ProtoDoc</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">@Field(store = Store.YES, analyze = Analyze.YES, analyzer = @Analyzer(definition = </span><span class="char">\&quot;</span><span class="content">simple</span><span class="char">\&quot;</span><span class="content">))</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@ProtoField</span>(number = <span class="integer">2</span>)
<span class="directive">final</span> <span class="predefined-type">String</span> description;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="creating_custom_analyzer_definitions"><a class="anchor" href="#creating_custom_analyzer_definitions"></a>Creating Custom Analyzer Definitions</h5>
<div class="paragraph">
<p>If you require custom analyzer definitions, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create an implementation of the
<code>ProgrammaticSearchMappingProvider</code> interface packaged in a <code>JAR</code> file.</p>
</li>
<li>
<p>Provide a file named <code>org.infinispan.query.spi.ProgrammaticSearchMappingProvider</code> in the
<code>META-INF/services/</code> directory of your <code>JAR</code>. This file should contain the fully qualified class name of your implementation.</p>
</li>
<li>
<p>Copy the <code>JAR</code> to the <code>lib/</code> directory of your Infinispan installation.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Your jar must be available to the Infinispan server during startup. You cannot add it if the server is already running.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following is an example implementation of the
<code>ProgrammaticSearchMappingProvider</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.core.LowerCaseFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.core.StopFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardFilterFactory</span>;
<span class="keyword">import</span> <span class="include">org.apache.lucene.analysis.standard.StandardTokenizerFactory</span>;
<span class="keyword">import</span> <span class="include">org.hibernate.search.cfg.SearchMapping</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.Cache</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.spi.ProgrammaticSearchMappingProvider</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">MyAnalyzerProvider</span> <span class="directive">implements</span> ProgrammaticSearchMappingProvider {

   <span class="annotation">@Override</span>
   <span class="directive">public</span> <span class="type">void</span> defineMappings(Cache cache, SearchMapping searchMapping) {
      searchMapping
            .analyzerDef(<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-with-stop</span><span class="delimiter">&quot;</span></span>, StandardTokenizerFactory.class)
               .filter(StandardFilterFactory.class)
               .filter(LowerCaseFilterFactory.class)
               .filter(StopFilterFactory.class);
   }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query_continuous"><a class="anchor" href="#query_continuous"></a>12.6. Continuous Query</h3>
<div class="paragraph">
<p>Continuous Queries allow an application to register a listener which will receive the entries that currently match a
query filter, and will be continuously notified of any changes to the queried data set that result from further cache
operations. This includes incoming matches, for values that have joined the set, updated matches, for matching values
that were modified and continue to match, and outgoing matches, for values that have left the set. By using a Continuous
Query the application receives a steady stream of events instead of having to repeatedly execute the same query to
discover changes, resulting in a more efficient use of resources. For instance, all of the following use cases could
utilize Continuous Queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Return all persons with an age between 18 and 25 (assuming the Person entity has an <code>age</code> property and is updated by
the user application).</p>
</li>
<li>
<p>Return all transactions higher than $2000.</p>
</li>
<li>
<p>Return all times where the lap speed of F1 racers were less than 1:45.00s (assuming the cache contains Lap entries and
that laps are entered live during the race).</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="continuous_query_execution"><a class="anchor" href="#continuous_query_execution"></a>12.6.1. Continuous Query Execution</h4>
<div class="paragraph">
<p>A continuous query uses a listener that is notified when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An entry starts matching the specified query, represented by a <code>Join</code> event.</p>
</li>
<li>
<p>A matching entry is updated and continues to match the query, represented by an <code>Update</code> vent.</p>
</li>
<li>
<p>An entry stops matching the query, represented by a <code>Leave</code> event.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a client registers a continuous query listener it immediately begins to receive the results currently matching the
query, received as <code>Join</code> events as described above. In addition, it will receive subsequent notifications when other
entries begin matching the query, as <code>Join</code> events, or stop matching the query, as <code>Leave</code> events, as a consequence of
any cache operations that would normally generate creation, modification, removal, or expiration events. Updated cache
entries will generate <code>Update</code> events if the entry matches the query filter before and after the operation. To
summarize, the logic used to determine if the listener receives a <code>Join</code>, <code>Update</code> or <code>Leave</code> event is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the query on both the old and new values evaluate false, then the event is suppressed.</p>
</li>
<li>
<p>If the query on the old value evaluates false and on the new value evaluates true, then a <code>Join</code> event is sent.</p>
</li>
<li>
<p>If the query on both the old and new values evaluate true, then an <code>Update</code> event is sent.</p>
</li>
<li>
<p>If the query on the old value evaluates true and on the new value evaluates false, then a <code>Leave</code> event is sent.</p>
</li>
<li>
<p>If the query on the old value evaluates true and the entry is removed or expired, then a <code>Leave</code> event is sent.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Continuous Queries can use all query capabilities except: grouping, aggregation, and sorting operations.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="running_continuous_queries"><a class="anchor" href="#running_continuous_queries"></a>12.6.2. Running Continuous Queries</h4>
<div class="paragraph">
<p>To create a continuous query, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a Query object. See <a href="#searching_ickle">the searching section</a></p>
</li>
<li>
<p>Obtain the ContinuousQuery (<code>org.infinispan.query.api.continuous.ContinuousQuery</code> object of your cache by calling
the appropriate method:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.infinispan.client.hotrod.Search.getContinuousQuery(RemoteCache&lt;K, V&gt; cache)</code> for remote mode</p>
</li>
<li>
<p><code>org.infinispan.query.Search.getContinuousQuery(Cache&lt;K, V&gt; cache)</code> for embedded mode</p>
</li>
</ul>
</div>
</li>
<li>
<p>Register the query and a continuous query listener (<code>org.infinispan.query.api.continuous.ContinuousQueryListener</code>) as follows:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">continuousQuery.addContinuousQueryListener(query, listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example demonstrates a simple continuous query use case in embedded mode:
⁠</p>
</div>
<div class="listingblock">
<div class="title">Registering a Continuous Query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.infinispan.query.api.continuous.ContinuousQuery</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.api.continuous.ContinuousQueryListener</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.Search</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.QueryFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.query.dsl.Query</span>;

<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.ConcurrentHashMap</span>;

[...]

<span class="comment">// We have a cache of Persons</span>
Cache&lt;<span class="predefined-type">Integer</span>, Person&gt; cache = ...

<span class="comment">// We begin by creating a ContinuousQuery instance on the cache</span>
ContinuousQuery&lt;<span class="predefined-type">Integer</span>, Person&gt; continuousQuery = Search.getContinuousQuery(cache);

<span class="comment">// Define our query. In this case we will be looking for any Person instances under 21 years of age.</span>
QueryFactory queryFactory = Search.getQueryFactory(cache);
<span class="predefined-type">Query</span> query = queryFactory.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM Person p WHERE p.age &lt; 21</span><span class="delimiter">&quot;</span></span>);

<span class="directive">final</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, Person&gt; matches = <span class="keyword">new</span> <span class="predefined-type">ConcurrentHashMap</span>&lt;<span class="predefined-type">Integer</span>, Person&gt;();

<span class="comment">// Define the ContinuousQueryListener</span>
ContinuousQueryListener&lt;<span class="predefined-type">Integer</span>, Person&gt; listener = <span class="keyword">new</span> ContinuousQueryListener&lt;<span class="predefined-type">Integer</span>, Person&gt;() {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultJoining(<span class="predefined-type">Integer</span> key, Person value) {
        matches.put(key, value);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultUpdated(<span class="predefined-type">Integer</span> key, Person value) {
        <span class="comment">// we do not process this event</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> resultLeaving(<span class="predefined-type">Integer</span> key) {
        matches.remove(key);
    }
};

<span class="comment">// Add the listener and the query</span>
continuousQuery.addContinuousQueryListener(query, listener);

[...]

<span class="comment">// Remove the listener to stop receiving notifications</span>
continuousQuery.removeContinuousQueryListener(listener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As Person instances having an age less than 21 are added to the cache they will be received by the listener and will be
placed into the <code>matches</code> map, and when these entries are removed from the cache or their age is modified to be greater
or equal than 21 they will be removed from <code>matches</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="removing_continuous_queries"><a class="anchor" href="#removing_continuous_queries"></a>12.6.3. Removing Continuous Queries</h4>
<div class="paragraph">
<p>To stop the query from further execution just remove the listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">continuousQuery.removeContinuousQueryListener(listener);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="notes_on_performance_of_continuous_queries"><a class="anchor" href="#notes_on_performance_of_continuous_queries"></a>12.6.4. Notes on performance of Continuous Queries</h4>
<div class="paragraph">
<p>Continuous queries are designed to provide a constant stream of updates to the application, potentially resulting in a
very large number of events being generated for particularly broad queries. A new temporary memory allocation is made
for each event. This behavior may result in memory pressure, potentially leading to <code>OutOfMemoryErrors</code> (especially in
remote mode) if queries are not carefully designed. To prevent such issues it is strongly recommended to ensure that
each query captures the minimal information needed both in terms of number of matched entries and size of each match
(projections can be used to capture the interesting properties), and that each <code>ContinuousQueryListener</code> is designed
to quickly process all received events without blocking and to avoid performing actions that will lead to the generation
of new matching events from the cache it listens to.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="statistics"><a class="anchor" href="#statistics"></a>12.7. Statistics</h3>
<div class="paragraph">
<p>Query <a href="http://docs.jboss.org/hibernate/search/5.7/api/org/hibernate/search/stat/Statistics.html">Statistics</a>
can be obtained from the <code>SearchManager</code>, as demonstrated in the following code snippet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SearchManager searchManager = Search.getSearchManager(cache);
org.hibernate.search.stat.Statistics statistics = searchManager.getStatistics();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This data is also available via JMX through the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_statisticsinfombean">Hibernate Search StatisticsInfoMBean</a>
registered under the name <code>org.infinispan:type=Query,manager="{name-of-cache-manager}",cache="{name-of-cache}",component=Statistics</code>.
Please note this MBean is always registered by Infinispan but the statistics are collected only if statistics collection is enabled at cache level.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hibernate Search has its own configuration properties <code>hibernate.search.jmx_enabled</code> and <code>hibernate.search.generate_statistics</code>
for JMX statistics as explained <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-monitoring">here</a>.
Using them with Infinispan Query is forbidden as it will only lead to duplicated MBeans and unpredictable results.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="query_performance"><a class="anchor" href="#query_performance"></a>12.8. Performance Tuning</h3>
<div class="sect3">
<h4 id="batch_writing_in_sync_mode"><a class="anchor" href="#batch_writing_in_sync_mode"></a>12.8.1. Batch writing in SYNC mode</h4>
<div class="paragraph">
<p>By default, the <a href="#query_index_manager">Index Managers</a> work in sync mode, meaning when data is written to Infinispan, it will perform the indexing operations synchronously.
This synchronicity guarantees indexes are always consistent with the data (and thus visible in searches), but can slowdown write operations since it will also perform a commit to the index.
Committing is an extremely expensive operation in Lucene, and for that reason, multiple writes from different nodes can be automatically batched into a single commit to reduce
the impact.</p>
</div>
<div class="paragraph">
<p>So, when doing data loads to Infinispan with index enabled, try to use multiple threads to take advantage of this batching.</p>
</div>
<div class="paragraph">
<p>If using multiple threads does not result in the required performance, an alternative is to load data with indexing temporarily disabled and run
 a <a href="#query_massindexer">re-indexing</a> operation afterwards. This can be done writing data with the <code>SKIP_INDEXING</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache.getAdvancedCache().withFlags(Flag.SKIP_INDEXING).put(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="writing_using_async_mode"><a class="anchor" href="#writing_using_async_mode"></a>12.8.2. Writing using async mode</h4>
<div class="paragraph">
<p>If it&#8217;s acceptable a small delay between data writes and when that data is visible in queries, an index manager can be configured to work in <strong>async mode</strong>.
The async mode offers much better writing performance, since in this mode commits happen at a configurable interval.</p>
</div>
<div class="paragraph">
<p>Configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing&gt;</span>
        <span class="comment">&lt;!-- Index data in async mode --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.worker.execution</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>async<span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- Optional: configure the commit interval, default is 1000ms --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.index_flush_interval</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>500<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="index_reader_async_strategy"><a class="anchor" href="#index_reader_async_strategy"></a>12.8.3. Index reader async strategy</h4>
<div class="paragraph">
<p>Lucene internally works with snapshots of the index: once an <code>IndexReader</code> is opened, it will only see the index changes up to the point it was opened;
further index changes will not be visible until the <code>IndexReader</code> is refreshed. The Index Managers used in Infinispan by default will check the
freshness of the index readers before every query and refresh them if necessary.</p>
</div>
<div class="paragraph">
<p>It is possible to tune this strategy to relax this freshness checking to a pre-configured interval by using the <code>reader.strategy</code> configuration set as <code>async</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;indexing&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.reader.strategy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>async<span class="tag">&lt;/property&gt;</span>
        <span class="comment">&lt;!-- refresh reader every 1s, default is 5s --&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default.reader.async_refresh_period_ms</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>1000<span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/indexing&gt;</span>
<span class="tag">&lt;/distributed-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lucene_options"><a class="anchor" href="#lucene_options"></a>12.8.4. Lucene Options</h4>
<div class="paragraph">
<p>It is possible to apply tuning options in Lucene directly. For more details, see the <a href="https://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#_lucene_configuration">Hibernate Search manual</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="execute_code_grid"><a class="anchor" href="#execute_code_grid"></a>13. Executing Code in the Grid</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main benefit of a Cache is the ability to very quickly lookup a value
by its key, even across machines. In fact this use alone is probably the reason
many users use Infinispan. However Infinispan can provide many more benefits
that aren&#8217;t immediately apparent. Since Infinispan is usually used in
a cluster of machines we also have features available that can help utilize
the entire cluster for performing the user&#8217;s desired workload.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section covers only executing code in the grid using an embedded cache,
if you are using a remote cache you should review details about executing code in the remote grid.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="cluster_executor"><a class="anchor" href="#cluster_executor"></a>13.1. Cluster Executor</h3>
<div class="paragraph">
<p>Since you have a group of machines, it makes sense to leverage their combined
computing power for executing code on all of them them.
The cache manager comes with a nice utility that allows you to
execute arbitrary code in the cluster. Note this feature requires no Cache to be used.  This
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/ClusterExecutor.html">Cluster Executor</a>
can be retrieved by calling executor() on the <code>EmbeddedCacheManager</code>. This executor is retrievable
in both clustered and non clustered configurations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ClusterExecutor is specifically designed for executing code where the code is not reliant
upon the data in a cache and is used instead as a way to help users to execute code easily
in the cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This manager was built specifically using Java 8 and such has functional APIs in mind, thus all methods take a functional
inteface as an argument. Also since these arguments will be sent to other nodes they need to be serializable.  We even
used a nice trick to ensure our lambdas are immediately Serializable.  That is by having the arguments implement both
Serializable and the real argument type (ie. Runnable or Function).  The JRE will pick the most specific class when
determining which method to invoke, so in that case your lambdas will always be serializable.
It is also possible to use an Externalizer to possibly reduce message size further.</p>
</div>
<div class="paragraph">
<p>The manager by default will submit a given command to all nodes in the cluster including the node
where it was submitted from. You can control on which nodes the task is executed on
by using the <code>filterTargets</code> methods as is explained in the section.</p>
</div>
<div class="sect3">
<h4 id="filtering_execution_nodes"><a class="anchor" href="#filtering_execution_nodes"></a>13.1.1. Filtering execution nodes</h4>
<div class="paragraph">
<p>It is possible to limit on which nodes the command will be ran. For example you may
want to only run a computation on machines in the same rack. Or you may want to perform an operation
once in the local site and again on a different site. A cluster executor can limit what nodes it sends
requests to at the scope of same or different machine, rack or site level.</p>
</div>
<div class="listingblock">
<div class="title">SameRack.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = ...;
manager.executor().filterTargets(ClusterExecutionPolicy.SAME_RACK).submit(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this topology base filtering you must enable topology aware consistent hashing through Server Hinting.</p>
</div>
<div class="paragraph">
<p>You can also filter using a predicate based on the <code>Address</code> of the node. This can also
be optionally combined with topology based filtering in the previous code snippet.</p>
</div>
<div class="paragraph">
<p>We also allow the target node to be chosen by any means using a <code>Predicate</code> that
will filter out which nodes can be considered for execution. Note this can also be combined
with Topology filtering at the same time to allow even more fine control of where you code
is executed within the cluster.</p>
</div>
<div class="listingblock">
<div class="title">Predicate.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = ...;
<span class="comment">// Just filter</span>
manager.executor().filterTargets(a -&gt; a.equals(..)).submit(...)
<span class="comment">// Filter only those in the desired topology</span>
manager.executor().filterTargets(ClusterExecutionPolicy.SAME_SITE, a -&gt; a.equals(..)).submit(...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="timeout"><a class="anchor" href="#timeout"></a>13.1.2. Timeout</h4>
<div class="paragraph">
<p>Cluster Executor allows for a timeout to be set per invocation. This defaults to the distributed sync timeout
as configured on the Transport Configuration. This timeout works in both a clustered and non clustered
cache manager. The executor may or may not interrupt the threads executing a task when the timeout expires. However
when the timeout occurs any <code>Consumer</code> or <code>Future</code> will be completed passing back a <code>TimeoutException</code>.
This value can be overridden by ivoking the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/ClusterExecutor.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a>
method and supplying the desired duration.</p>
</div>
</div>
<div class="sect3">
<h4 id="single_node_submission"><a class="anchor" href="#single_node_submission"></a>13.1.3. Single Node Submission</h4>
<div class="paragraph">
<p>Cluster Executor can also run in single node submission mode instead of submitting the command
to all nodes it will instead pick one of the nodes that would have normally received the command
and instead submit it it to only one. Each submission will possibly use a different node to
execute the task on. This can be very useful to use the ClusterExecutor as a
<code>java.util.concurrent.Executor</code> which you may have noticed that ClusterExecutor implements.</p>
</div>
<div class="listingblock">
<div class="title">SingleNode.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EmbeddedCacheManager manager = ...;
manager.executor().singleNodeSubmission().submit(...)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="failover"><a class="anchor" href="#failover"></a>Failover</h5>
<div class="paragraph">
<p>When running in single node submission it may be desirable to also allow the Cluster Executor
handle cases where an exception occurred during the processing of a given command by retrying
the command again.
When this occurs the Cluster Executor will choose a single node again to resubmit the command to
up to the desired number of failover attempts. Note the chosen node could be any node that passes
the topology or predicate check. Failover is enabled by invoking the overridden
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/manager/ClusterExecutor.html#singleNodeSubmission-int-">singleNodeSubmission</a>
method. The given command will be resubmitted again to a single node until either
the command completes without exception or the total submission amount is equal to the provided
failover count.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example_pi_approximation"><a class="anchor" href="#example_pi_approximation"></a>13.1.4. Example: PI Approximation</h4>
<div class="paragraph">
<p>This example shows how you can use the ClusterExecutor to estimate the value of PI.</p>
</div>
<div class="paragraph">
<p>Pi approximation can greatly benefit from parallel distributed execution via
Cluster Executor. Recall that area of the square is Sa = 4r2 and area of the
circle is Ca=pi*r2. Substituting r2 from the second equation into the first
one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large
number of darts into a square; if we take ratio of darts that land inside a
circle over a total number of darts shot we will approximate Ca/Sa value. Since
we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The
more darts we shoot the better approximation we get. In the example below we
shoot 1 billion darts but instead of "shooting" them serially we parallelize
work of dart shooting across the entire Infinispan cluster. Note this will
work in a cluster of 1 was well, but will be slower.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PiAppx</span> {

   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main (<span class="predefined-type">String</span> <span class="type">[]</span> arg){
      EmbeddedCacheManager cacheManager = ..
      boolean isCluster = ..

      int numPoints = <span class="integer">1</span>_000_000_000;
      <span class="type">int</span> numServers = isCluster ? cacheManager.getMembers().size() : <span class="integer">1</span>;
      <span class="type">int</span> numberPerWorker = numPoints / numServers;

      ClusterExecutor clusterExecutor = cacheManager.executor();
      <span class="type">long</span> start = <span class="predefined-type">System</span>.currentTimeMillis();
      <span class="comment">// We receive results concurrently - need to handle that</span>
      <span class="predefined-type">AtomicLong</span> countCircle = <span class="keyword">new</span> <span class="predefined-type">AtomicLong</span>();
      CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; fut = clusterExecutor.submitConsumer(m -&gt; {
         <span class="type">int</span> insideCircleCount = <span class="integer">0</span>;
         <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; numberPerWorker; i++) {
            <span class="type">double</span> x = <span class="predefined-type">Math</span>.random();
            <span class="type">double</span> y = <span class="predefined-type">Math</span>.random();
            <span class="keyword">if</span> (insideCircle(x, y))
               insideCircleCount++;
         }
         <span class="keyword">return</span> insideCircleCount;
      }, (address, count, throwable) -&gt; {
         <span class="keyword">if</span> (throwable != <span class="predefined-constant">null</span>) {
            throwable.printStackTrace();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Address: </span><span class="delimiter">&quot;</span></span> + address + <span class="string"><span class="delimiter">&quot;</span><span class="content"> encountered an error: </span><span class="delimiter">&quot;</span></span> + throwable);
         } <span class="keyword">else</span> {
            countCircle.getAndAdd(count);
         }
      });
      fut.whenComplete((v, t) -&gt; {
         <span class="comment">// This is invoked after all nodes have responded with a value or exception</span>
         <span class="keyword">if</span> (t != <span class="predefined-constant">null</span>) {
            t.printStackTrace();
            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception encountered while waiting:</span><span class="delimiter">&quot;</span></span> + t);
         } <span class="keyword">else</span> {
            <span class="type">double</span> appxPi = <span class="float">4.0</span> * countCircle.get() / numPoints;

            <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Distributed PI appx is </span><span class="delimiter">&quot;</span></span> + appxPi +
                  <span class="string"><span class="delimiter">&quot;</span><span class="content"> using </span><span class="delimiter">&quot;</span></span> + numServers + <span class="string"><span class="delimiter">&quot;</span><span class="content"> node(s), completed in </span><span class="delimiter">&quot;</span></span> + (<span class="predefined-type">System</span>.currentTimeMillis() - start) + <span class="string"><span class="delimiter">&quot;</span><span class="content"> ms</span><span class="delimiter">&quot;</span></span>);
         }
      });

      <span class="comment">// May have to sleep here to keep alive if no user threads left</span>
   }

   <span class="directive">private</span> <span class="directive">static</span> <span class="type">boolean</span> insideCircle(<span class="type">double</span> x, <span class="type">double</span> y) {
      <span class="keyword">return</span> (<span class="predefined-type">Math</span>.pow(x - <span class="float">0.5</span>, <span class="integer">2</span>) + <span class="predefined-type">Math</span>.pow(y - <span class="float">0.5</span>, <span class="integer">2</span>))
            &lt;= <span class="predefined-type">Math</span>.pow(<span class="float">0.5</span>, <span class="integer">2</span>);
   }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="streams"><a class="anchor" href="#streams"></a>14. Streams</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may want to process a subset or all data in the cache to produce a result.
This may bring thoughts of Map Reduce. Infinispan allows the user to do something
very similar but utilizes the standard JRE APIs to do so.
Java 8 introduced the concept of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a>
which allows functional-style operations on collections rather than having to procedurally
iterate over the data yourself. Stream operations can be implemented in a fashion very
similar to MapReduce.  Streams, just like MapReduce allow you to perform processing
upon the entirety of your cache, possibly a very large data set, but in an efficient way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Streams are the preferred method when dealing with data that exists in the cache because streams automatically adjust to cluster topology changes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also since we can control how the entries are iterated upon we can more efficiently perform the operations in a cache that is distributed if you want it to perform all of the operations across the cluster concurrently.</p>
</div>
<div class="paragraph">
<p>A stream is retrieved from the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#entrySet--">entrySet</a>,
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#keySet--">keySet</a> or
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/Cache.html#values--">values</a> collections returned from the
Cache by invoking the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a> methods.</p>
</div>
<div class="sect2">
<h3 id="common_stream_operations"><a class="anchor" href="#common_stream_operations"></a>14.1. Common stream operations</h3>
<div class="paragraph">
<p>This section highlights various options that are present irrespective of what type of underlying cache
you are using.</p>
</div>
</div>
<div class="sect2">
<h3 id="key_filtering"><a class="anchor" href="#key_filtering"></a>14.2. Key filtering</h3>
<div class="paragraph">
<p>It is possible to filter the stream so that it only operates upon a given subset of keys.  This can be done
by invoking the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#filterKeys-java.util.Set-">filterKeys</a>
method on the <code>CacheStream</code>.  This should always be used over a Predicate
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html?is-external=true#filter-java.util.function.Predicate-">filter</a>
and will be faster if the predicate was holding all keys.</p>
</div>
<div class="paragraph">
<p>If you are familiar with the <code>AdvancedCache</code> interface you may be wondering why you even use
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html#getAll-java.util.Set-">getAll</a>
over this keyFilter.  There are some small benefits (mostly smaller payloads) to using getAll
if you need the entries as is and need them all in memory in the local node.  However if you
need to do processing on these elements a stream is recommended since you will get both
distributed and threaded parallelism for free.</p>
</div>
</div>
<div class="sect2">
<h3 id="segment_based_filtering"><a class="anchor" href="#segment_based_filtering"></a>14.3. Segment based filtering</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is an advanced feature and should only be used with deep knowledge of Infinispan segment and hashing techniques.
These segments based filtering can be useful if you need to segment data into separate invocations.
This can be useful when integrating with other tools such as
<a href="http://spark.apache.org/">Apache Spark</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This option is only supported for replicated and distributed caches.  This allows the user to operate upon
a subset of data at a time as determined by the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/distribution/ch/KeyPartitioner.html">KeyPartitioner</a>.
The segments can be filtered by invoking
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#filterKeySegments-java.util.Set-">filterKeySegments</a>
method on the <code>CacheStream</code>.  This is applied after the key filter but before any intermediate operations are performed.</p>
</div>
</div>
<div class="sect2">
<h3 id="localinvalidation"><a class="anchor" href="#localinvalidation"></a>14.4. Local/Invalidation</h3>
<div class="paragraph">
<p>A stream used with a local or invalidation cache can be used just the same way you would use a stream on a
regular collection. Infinispan handles all of the translations if necessary behind the scenes and works with all
of the more interesting options (ie. storeAsBinary and a cache loader).  Only data local to
the node where the stream operation is performed will be used, for example invalidation only uses local entries.</p>
</div>
</div>
<div class="sect2">
<h3 id="example"><a class="anchor" href="#example"></a>14.5. Example</h3>
<div class="paragraph">
<p>The code below takes a cache and returns a map with all the cache entries whose values contain the string "JBoss"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss</span><span class="delimiter">&quot;</span></span>))
              .collect(Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="distributionreplicationscattered"><a class="anchor" href="#distributionreplicationscattered"></a>14.6. Distribution/Replication/Scattered</h3>
<div class="paragraph">
<p>This is where streams come into their stride.  When a stream operation is performed it will
send the various intermediate and terminal operations to each node that has pertinent data.
This allows processing the intermediate values on the nodes owning the data, and only sending
the final results back to the originating nodes, improving performance.</p>
</div>
<div class="sect3">
<h4 id="rehash_aware"><a class="anchor" href="#rehash_aware"></a>14.6.1. Rehash Aware</h4>
<div class="paragraph">
<p>Internally the data is segmented and each node only performs the operations upon the data it owns as a primary owner.
This allows for data to be processed evenly, assuming segments are granular enough to provide for equal amounts of
data on each node.</p>
</div>
<div class="paragraph">
<p>When you are utilizing a distributed cache, the data can be reshuffled between nodes when a
new node joins or leaves. Distributed Streams handle this reshuffling of data automatically so you don&#8217;t
have to worry about monitoring when nodes leave or join the cluster.
Reshuffled entries may be processed a second time, and we keep track of the processed entries at the
key level or at the segment level (depending on the terminal operation) to limit the amount of
duplicate processing.</p>
</div>
<div class="paragraph">
<p>It is possible but highly discouraged to disable rehash awareness on the stream.  This should only be considered if
your request can handle only seeing a subset of data if a rehash occurs.  This can be done by invoking
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#disableRehashAware--">CacheStream.disableRehashAware()</a>
The performance gain for most operations when a rehash doesn&#8217;t occur is completely negligible.
The only exceptions are for iterator and forEach, which will use less memory, since they do not have
to keep track of processed keys.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please rethink disabling rehash awareness unless you really know what you are doing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="serialization"><a class="anchor" href="#serialization"></a>14.6.2. Serialization</h4>
<div class="paragraph">
<p>Since the operations are sent across to other nodes they must be serializable by Infinispan marshalling.  This allows the
operations to be sent to the other nodes.</p>
</div>
<div class="paragraph">
<p>The simplest way is to use a CacheStream instance and use a lambda just as you would normally.
Infinispan overrides all of the various Stream intermediate and terminal methods to take
Serializable versions of the arguments (ie. SerializableFunction, SerializablePredicate&#8230;&#8203;)
You can find these methods at
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/stream/CacheStream.html">CacheStream</a>.
This relies on the spec to pick the most specific method as defined <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.12.2.5">here</a>.</p>
</div>
<div class="paragraph">
<p>In our previous example we used a <code>Collector</code> to collect all the results into a <code>Map</code>.
Unfortunately the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a>
class doesn&#8217;t produce Serializable instances.  Thus if you need to use these, there are two ways to do so:</p>
</div>
<div class="paragraph">
<p>One option would be to use the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a>
class which allows for a <code>Supplier&lt;Collector&gt;</code> to be provided.  This instance could then use the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html">Collectors</a>
to supply a <code>Collector</code> which is not serialized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can avoid the use of
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/stream/CacheCollectors.html">CacheCollectors</a>
and instead use the overloaded <code>collect</code> methods that take <code>Supplier&lt;Collector&gt;</code>.
These overloaded <code>collect</code> methods are only available via <code>CacheStream</code> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If however you are not able to use the <code>Cache</code> and <code>CacheStream</code> interfaces you cannot utilize <code>Serializable</code>
arguments and you must instead cast the lambdas to be <code>Serializable</code> manually by casting the lambda to multiple
interfaces.  It is not a pretty sight but it gets the job done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = map.entrySet().stream()
              .filter((<span class="predefined-type">Serializable</span> &amp; <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt;) e -&gt; e.getValue().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(CacheCollectors.serializableCollector(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The recommended and most performant way is to use an
<code>AdvancedExternalizer</code> as this provides the smallest payload.  Unfortunately
this means you cannot use lamdbas as advanced externalizers require defining
the class before hand.</p>
</div>
<div class="paragraph">
<p>You can use an advanced externalizer as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">   <span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; jbossValues = cache.entrySet().stream()
              .filter(<span class="keyword">new</span> ContainsFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(() -&gt; Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));

   <span class="type">class</span> <span class="class">ContainsFilter</span> <span class="directive">implements</span> <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt; {
      <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> target;

      ContainsFilter(<span class="predefined-type">String</span> target) {
         <span class="local-variable">this</span>.target = target;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">boolean</span> test(<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; e) {
         <span class="keyword">return</span> e.getValue().contains(target);
      }
   }

   <span class="type">class</span> <span class="class">JbossFilterExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;ContainsFilter&gt; {

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ContainsFilter&gt;&gt; getTypeClasses() {
         <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(ContainsFilter.class);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
         <span class="keyword">return</span> CUSTOM_ID;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, ContainsFilter object) <span class="directive">throws</span> <span class="exception">IOException</span> {
         output.writeUTF(object.target);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> ContainsFilter readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
         <span class="keyword">return</span> <span class="keyword">new</span> ContainsFilter(input.readUTF());
      }
   }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also use an advanced externalizer for the collector supplier to reduce the
payload size even further.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt; map = (<span class="predefined-type">Map</span>&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;) cache.entrySet().stream()
              .filter(<span class="keyword">new</span> ContainsFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Jboss</span><span class="delimiter">&quot;</span></span>))
              .collect(Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue));

 <span class="type">class</span> <span class="class">ToMapCollectorSupplier</span>&lt;K, U&gt; <span class="directive">implements</span> Supplier&lt;Collector&lt;<span class="predefined-type">Map</span>.Entry&lt;K, U&gt;, ?, <span class="predefined-type">Map</span>&lt;K, U&gt;&gt;&gt; {
      <span class="directive">static</span> <span class="directive">final</span> ToMapCollectorSupplier INSTANCE = <span class="keyword">new</span> ToMapCollectorSupplier();

      <span class="directive">private</span> ToMapCollectorSupplier() { }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> Collector&lt;<span class="predefined-type">Map</span>.Entry&lt;K, U&gt;, ?, <span class="predefined-type">Map</span>&lt;K, U&gt;&gt; get() {
         <span class="keyword">return</span> Collectors.toMap(<span class="predefined-type">Map</span>.Entry::getKey, <span class="predefined-type">Map</span>.Entry::getValue);
      }
   }

   <span class="type">class</span> <span class="class">ToMapCollectorSupplierExternalizer</span> <span class="directive">implements</span> AdvancedExternalizer&lt;ToMapCollectorSupplier&gt; {

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ToMapCollectorSupplier&gt;&gt; getTypeClasses() {
         <span class="keyword">return</span> <span class="predefined-type">Util</span>.asSet(ToMapCollectorSupplier.class);
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="predefined-type">Integer</span> getId() {
         <span class="keyword">return</span> CUSTOM_ID;
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> <span class="type">void</span> writeObject(<span class="predefined-type">ObjectOutput</span> output, ToMapCollectorSupplier object) <span class="directive">throws</span> <span class="exception">IOException</span> {
      }

      <span class="annotation">@Override</span>
      <span class="directive">public</span> ToMapCollectorSupplier readObject(<span class="predefined-type">ObjectInput</span> input) <span class="directive">throws</span> <span class="exception">IOException</span>, <span class="exception">ClassNotFoundException</span> {
         <span class="keyword">return</span> ToMapCollectorSupplier.INSTANCE;
      }
   }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parallel_computation"><a class="anchor" href="#parallel_computation"></a>14.7. Parallel Computation</h3>
<div class="paragraph">
<p>Distributed streams by default try to parallelize as much as possible.  It is possible for the end user to control this and
actually they always have to control one of the options.  There are 2 ways these streams are parallelized.</p>
</div>
<div class="paragraph">
<p><strong>Local to each node</strong>
When a stream is created from the cache collection the end user can choose between invoking
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#stream--">stream</a> or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--">parallelStream</a>
method.  Depending on if the parallel stream was picked will enable multiple threading for
each node locally.  Note that some operations like a rehash aware iterator and forEach operations
will always use a sequential stream locally.  This could be enhanced at some point to allow for
parallel streams locally.</p>
</div>
<div class="paragraph">
<p>Users should be careful when using local parallelism as it requires having a large number of entries or operations
that are computationally expensive to be faster. Also it should be noted that if a user uses a parallel
stream with <code>forEach</code> that the action should not block as this would be executed on the common pool, which
is normally reserved for computation operations.</p>
</div>
<div class="paragraph">
<p><strong>Remote requests</strong>
When there are multiple nodes it may be desirable to control whether the remote requests are all processed
at the same time concurrently or one at a time.  By default all terminal operations except the iterator
perform concurrent requests.  The iterator, method to reduce overall memory pressure on the local node,
only performs sequential requests which actually performs slightly better.</p>
</div>
<div class="paragraph">
<p>If a user wishes to change this default however they can do so by invoking the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#sequentialDistribution--">sequentialDistribution</a>
or <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#parallelDistribution--">parallelDistribution</a>
methods on the <code>CacheStream</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="task_timeout"><a class="anchor" href="#task_timeout"></a>14.8. Task timeout</h3>
<div class="paragraph">
<p>It is possible to set a timeout value for the operation requests. This timeout is used only for remote requests timing out and
it is on a per request basis. The former means the local execution will not timeout and the latter means if you have a failover
scenario as described above the subsequent requests each have a new timeout.  If no timeout is specified it uses the
replication timeout as a default timeout. You can set the timeout in your task by doing the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheStream&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">String</span>&gt;&gt; stream = cache.entrySet().stream();
stream.timeout(<span class="integer">1</span>, <span class="predefined-type">TimeUnit</span>.MINUTES);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about this, please check the java doc in
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#timeout-long-java.util.concurrent.TimeUnit-">timeout</a>
javadoc.</p>
</div>
</div>
<div class="sect2">
<h3 id="injection"><a class="anchor" href="#injection"></a>14.9. Injection</h3>
<div class="paragraph">
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream</a>
has a terminal operation called
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#forEach-java.util.function.Consumer-">forEach</a>
which allows for running some sort of side effect operation on the data.  In this case it may be desirable to get a reference to
the <code>Cache</code> that is backing this Stream.  If your <code>Consumer</code> implements the
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/stream/CacheAware.html">CacheAware</a>
interface the <code>injectCache</code> method be invoked before the accept method from the <code>Consumer</code> interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="distributed_stream_execution"><a class="anchor" href="#distributed_stream_execution"></a>14.10. Distributed Stream execution</h3>
<div class="paragraph">
<p>Distributed streams execution works in a fashion very similiar to map reduce.  Except in this case we are sending zero to many intermediate operations
(map, filter etc.) and a single terminal operation to the various nodes.  The operation basically comes down to the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The desired segments are grouped by which node is the primary owner of the given segment</p>
</li>
<li>
<p>A request is generated to send to each remote node that contains the intermediate and terminal operations including which segments it should process</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The terminal operation will be performed locally if necessary</p>
</li>
<li>
<p>Each remote node will receive this request and run the operations and subsequently send the response back</p>
</li>
</ol>
</div>
</li>
<li>
<p>The local node will then gather the local response and remote responses together performing any kind of reduction required by the operations themselves.</p>
</li>
<li>
<p>Final reduced response is then returned to the user</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In most cases all operations are fully distributed, as in the operations are all fully applied on each remote node and usually only the last operation or something related may be
reapplied to reduce the results from multiple nodes.  One important note is that intermediate values do not actually have to be serializable, it is the last value
sent back that is the part desired (exceptions for various operations will be highlighted below).</p>
</div>
<div class="paragraph">
<p><strong>Terminal operator distributed result reductions</strong>
The following paragraphs describe how the distributed reductions work for the various terminal operators.  Some of these are special in that an intermediate value may
be required to be serializable instead of the final result.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">allMatch noneMatch anyMatch</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#allMatch-java.util.function.Predicate-">allMatch</a>
operation is ran on each node and then all the results are logically anded together locally
to get the appropriate value.  The
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#noneMatch-java.util.function.Predicate-">noneMatch</a>
and
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#anyMatch-java.util.function.Predicate-">anyMatch</a>
operations use a logical or instead. These methods also have early termination support,
stopping remote and local operations once the final result is known.</p>
</dd>
<dt class="hdlist1">collect</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-">collect</a>
method is interesting in that it can do a few extra steps.  The remote node performs
everything as normal except it doesn&#8217;t perform the final
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#finisher--">finisher</a>
upon the result and instead sends back the fully combined results.  The local thread
then <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combines</a>
the remote and local result into a value which is then finally finished.  The key
here to remember is that the final value doesn&#8217;t have to be serializable but rather
the values produced from the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#supplier--">supplier</a>
and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html#combiner--">combiner</a>
methods.</p>
</dd>
<dt class="hdlist1">count</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#count--">count</a>
method just adds the numbers together from each node.</p>
</dd>
<dt class="hdlist1">findAny findFirst</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#findAny--">findAny</a>
operation returns just the first value they find, whether it was from a remote node
or locally.  Note this supports early termination in that once a value is found it
will not process others.  Note the findFirst method is special since it requires a sorted
intermediate operation, which is detailed in the
<a href="user_guide.html#intermediate_operation_exceptions">exceptions</a> section.</p>
</dd>
<dt class="hdlist1">max min</dt>
<dd>
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#max-java.util.Comparator-">max</a> and
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#min-java.util.Comparator-">min</a> methods find the respective min or max value on each node then a final
reduction is performed locally to ensure only the min or max across all nodes is returned.</p>
</dd>
<dt class="hdlist1">reduce</dt>
<dd>
<p>The various reduce methods <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-java.util.function.BinaryOperator-">1</a> ,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-T-java.util.function.BinaryOperator-">2</a> ,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#reduce-U-java.util.function.BiFunction-java.util.function.BinaryOperator-">3</a> will end up serializing
the result as much as the accumulator can do.  Then it will accumulate the local and remote results together locally, before combining if you have provided that.  Note this means
a value coming from the combiner doesn&#8217;t have to be Serializable.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="key_based_rehash_aware_operators"><a class="anchor" href="#key_based_rehash_aware_operators"></a>14.11. Key based rehash aware operators</h3>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#iterator--">iterator</a>,
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#spliterator--">spliterator</a>
and <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#forEach-java.util.function.Consumer-">forEach</a>
are unlike the other terminal operators in that the rehash awareness has to keep
track of what keys per segment have been processed instead of just segments.  This is
to guarantee an exactly once (iterator &amp; spliterator) or at least once behavior (forEach)
even under cluster membership changes.</p>
</div>
<div class="paragraph">
<p>The <code>iterator</code> and <code>spliterator</code> operators when invoked on a remote node will return back batches
of entries, where the next batch is only sent back after the last has been fully consumed.  This
batching is done to limit how many entries are in memory at a given time.  The user node will hold
onto which keys it has processed and when a given segment is completed it will release those keys from
memory.  This is why sequential processing is preferred for the iterator method, so only a subset of segment
keys are held in memory at once, instead of from all nodes.</p>
</div>
<div class="paragraph">
<p>The <code>forEach()</code> method also returns batches, but it returns a batch of keys after it has finished processing
at least a batch worth of keys.  This way the originating node can know what keys have been processed
already to reduce chances of processing the same entry again.  Unfortunately this means it is possible
to have an at least once behavior when a node goes down unexpectedly.  In this case that node could have
been processing a batch and not yet completed one and those entries that were processed but not
in a completed batch will be ran again when the rehash failure operation occurs.  Note that adding a
node will not cause this issue as the rehash failover doesn&#8217;t occur until all responses are received.</p>
</div>
<div class="paragraph">
<p>These operations batch sizes are both controlled by the same value which can be configured by invoking
<a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/CacheStream.html#distributedBatchSize-int-">distributedBatchSize</a>
method on the <code>CacheStream</code>.  This value will default to the <code>chunkSize</code> configured in state transfer.
Unfortunately this value is a tradeoff with memory usage vs performance vs at least once and your
mileage may vary.</p>
</div>
<div class="paragraph">
<p><strong>Using <code>iterator</code> with replicated and distributed caches</strong></p>
</div>
<div class="paragraph">
<p>When a node is the primary or backup owner of all requested segments for a distributed stream, Infinispan performs the <code>iterator</code> or <code>spliterator</code> terminal operations locally, which optimizes performance as remote iterations are more resource intensive.</p>
</div>
<div class="paragraph">
<p>This optimization applies to both replicated and distributed caches. However, Infinispan performs iterations remotely when using cache stores that are both <code>shared</code> and have <code>write-behind</code> enabled. In this case performing the iterations remotely ensures consistency.</p>
</div>
</div>
<div class="sect2">
<h3 id="intermediate_operation_exceptions"><a class="anchor" href="#intermediate_operation_exceptions"></a>14.12. Intermediate operation exceptions</h3>
<div class="paragraph">
<p>There are some intermediate operations that have special exceptions, these are
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#skip-long-">skip</a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#peek-java.util.function.Consumer-">peek</a>,
sorted <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted-java.util.Comparator-">1</a>
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#sorted--">2</a>.
&amp; <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#distinct--">distinct</a>.
All of these methods have some sort of artificial iterator implanted in the stream
processing to guarantee correctness, they are documented as below.  Note this means
these operations may cause possibly severe performance degradation.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Skip</dt>
<dd>
<p>An artificial iterator is implanted up to the intermediate skip operation.
Then results are brought locally so it can skip the appropriate amount of elements.</p>
</dd>
<dt class="hdlist1">Sorted</dt>
<dd>
<p>WARNING: This operation requires having all entries in memory on the local node.
An artificial iterator is implanted up to the intermediate sorted operation.
All results are sorted locally.  There are possible plans to have a distributed sort which
returns batches of elements, but this is not yet implemented.</p>
</dd>
<dt class="hdlist1">Distinct</dt>
<dd>
<p>WARNING: This operation requires having all or nearly all entries in memory on the local node.
Distinct is performed on each remote node and then an artificial iterator returns those distinct values.
Then finally all of those results have a distinct operation performed upon them.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The rest of the intermediate operations are fully distributed as one would expect.</p>
</div>
</div>
<div class="sect2">
<h3 id="examples_2"><a class="anchor" href="#examples_2"></a>14.13. Examples</h3>
<div class="paragraph">
<p><strong>Word Count</strong></p>
</div>
<div class="paragraph">
<p>Word count is a classic, if overused, example
of map/reduce paradigm. Assume we have a mapping of key &#8594; sentence stored on
Infinispan nodes. Key is a String, each sentence is also a String, and we have
to count occurrence of all words in all sentences available. The implementation
of such a distributed task could be defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {

   <span class="comment">/**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */</span>
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c1 = ...;
      Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; c2 = ...;

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world here I am</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan rules the world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is in Boston</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">4</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is in Boston as well</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">12</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss Application Server</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">14</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan community</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello world</span><span class="delimiter">&quot;</span></span>);

      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">111</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Infinispan open source</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">112</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston is close to Toronto</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">113</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Toronto is a capital of Ontario</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">114</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JUDCon is cool</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">211</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss World is awesome</span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">212</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss rules</span><span class="delimiter">&quot;</span></span>);
      c1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">213</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JBoss division of RedHat </span><span class="delimiter">&quot;</span></span>);
      c2.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">214</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">RedHat community</span><span class="delimiter">&quot;</span></span>);

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCountMap = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap(<span class="predefined-type">Arrays</span>::stream)
         .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case it is pretty simple to do the word count from the previous example.</p>
</div>
<div class="paragraph">
<p>However what if we want to find the most frequent word in the example?  If you take a second
to think about this case you will realize you need to have all words counted  and available
locally first. Thus we actually have a few options.</p>
</div>
<div class="paragraph">
<p>We could use a finisher on the collector, which is invoked on the user thread
after all the results have been collected.
Some redundant lines have been removed from the previous example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordCountExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">String</span> mostFrequentWord = c1.entrySet().parallelStream()
         .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
         .flatMap(<span class="predefined-type">Arrays</span>::stream)
         .collect(() -&gt; Collectors.collectingAndThen(
            Collectors.groupingBy(Function.identity(), Collectors.counting()),
               wordCountMap -&gt; {
                  <span class="predefined-type">String</span> mostFrequent = <span class="predefined-constant">null</span>;
                  <span class="type">long</span> maxCount = <span class="integer">0</span>;
                     <span class="keyword">for</span> (<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; e : wordCountMap.entrySet()) {
                        <span class="type">int</span> count = e.getValue().intValue();
                        <span class="keyword">if</span> (count &gt; maxCount) {
                           maxCount = count;
                           mostFrequent = e.getKey();
                        }
                     }
                     <span class="keyword">return</span> mostFrequent;
               }));

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately the last step is only going to be ran in a single thread, which if we have a lot of
words could be quite slow.  Maybe there is another way to parallelize this with Streams.</p>
</div>
<div class="paragraph">
<p>We mentioned before we are in the local node after processing, so we could actually use
a stream on the map results.  We can therefore use a parallel stream on the results.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WordFrequencyExample</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>

      <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt; wordCount = c1.entrySet().parallelStream()
              .map(e -&gt; e.getValue().split(<span class="string"><span class="delimiter">&quot;</span><span class="char">\\</span><span class="content">s</span><span class="delimiter">&quot;</span></span>))
              .flatMap(<span class="predefined-type">Arrays</span>::stream)
              .collect(() -&gt; Collectors.groupingBy(Function.identity(), Collectors.counting()));
      Optional&lt;<span class="predefined-type">Map</span>.Entry&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Long</span>&gt;&gt; mostFrequent = wordCount.entrySet().parallelStream().reduce(
              (e1, e2) -&gt; e1.getValue() &gt; e2.getValue() ? e1 : e2);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way you can still utilize all of the cores locally when calculating the most frequent element.</p>
</div>
<div class="paragraph">
<p><strong>Remove specific entries</strong></p>
</div>
<div class="paragraph">
<p>Distributed streams can also be used as a way to modify data where it lives.
For example you may want to remove all entries in your cache that contain
a specific word.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RemoveBadWords</span> {
   <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
      <span class="comment">// Lines removed</span>
      <span class="predefined-type">String</span> word = ..

      c1.entrySet().parallelStream()
         .filter(e -&gt; e.getValue().contains(word))
         .forEach((c, e) -&gt; c.remove(e.getKey()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we carefully note what is serialized and what is not, we notice that only the word along
with the operations are serialized across to other nods as it is captured by the lambda.
However the real saving piece is that the cache operation is performed on the primary
owner thus reducing the amount of network traffic required to remove these values from the
cache. The cache is not captured by the lambda as we provide a special BiConsumer method
override that when invoked on each node passes the cache to the BiConsumer</p>
</div>
<div class="paragraph">
<p>One thing to keep in mind using the <code>forEach</code> command in this manner is that the underlying
stream obtains no locks. The cache remove operation will still obtain locks naturally, but
the value could have changed from what the stream saw. That means that the entry could
have been changed after the stream read it but the remove actually removed it.</p>
</div>
<div class="paragraph">
<p>We have specifically added a new variant which is called <code>LockedStream</code>.</p>
</div>
<div class="paragraph">
<p><strong>Plenty of other examples</strong></p>
</div>
<div class="paragraph">
<p>The <code>Streams</code> API is a JRE tool and there are lots of examples for using it.
Just remember that your operations need to be Serializable in some way.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jcache_jsr_107"><a class="anchor" href="#jcache_jsr_107"></a>15. JCache (JSR-107) API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan provides an implementation of
JCache 1.0 API ( <a href="http://www.jcp.org/en/jsr/detail?id=107">JSR-107</a> ).
JCache specifies a standard Java API for caching temporary Java objects in
memory. Caching java objects can help get around bottlenecks arising from
using data that is expensive to retrieve (i.e. DB or web service), or data
that is hard to calculate. Caching these type of objects in memory can help
speed up application performance by retrieving the data directly from memory
instead of doing an expensive roundtrip or recalculation. This document
specifies how to use JCache with the Infinispan implementation of the
specification, and explains key aspects of the API.</p>
</div>
<div class="sect2">
<h3 id="creating_embedded_caches"><a class="anchor" href="#creating_embedded_caches"></a>15.1. Creating embedded caches</h3>
<div class="olist arabic">
<div class="title">Prerequisites</div>
<ol class="arabic">
<li>
<p>Ensure that <code>cache-api</code> is on your classpath.</p>
</li>
<li>
<p>Add the following dependency to your <code>pom.xml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-jcache<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create embedded caches that use the default JCache API configuration as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager</span>
CacheManager cacheManager = Caching.getCachingProvider().getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="configuring_embedded_caches"><a class="anchor" href="#configuring_embedded_caches"></a>15.1.1. Configuring embedded caches</h4>
<div class="ulist">
<ul>
<li>
<p>Pass the URI for custom Infinispan configuration to the <code>CachingProvider.getCacheManager(URI)</code> call as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.net.URI</span>;
<span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Load configuration from an absolute filesystem path</span>
<span class="predefined-type">URI</span> uri = <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">file:///path/to/infinispan.xml</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Load configuration from a classpath resource</span>
<span class="comment">// URI uri = this.getClass().getClassLoader().getResource(&quot;infinispan.xml&quot;).toURI();</span>

<span class="comment">// Create a cache manager using the above configuration</span>
CacheManager cacheManager = Caching.getCachingProvider().getCacheManager(uri, <span class="local-variable">this</span>.getClass().getClassLoader(), <span class="predefined-constant">null</span>);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
By default, the JCache API specifies that data should be stored as
<code>storeByValue</code>, so that object state mutations outside of operations to the
cache, won&#8217;t have an impact in the objects stored in the cache. Infinispan
has so far implemented this using serialization/marshalling to make copies to
store in the cache, and that way adhere to the spec. Hence, if using default
JCache configuration with Infinispan, data stored must be marshallable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, JCache can be configured to store data by reference
(just like Infinispan or JDK Collections work). To do that, simply call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;().setStoreByValue(<span class="predefined-constant">false</span>));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating_remote_caches"><a class="anchor" href="#creating_remote_caches"></a>15.2. Creating remote caches</h3>
<div class="olist arabic">
<div class="title">Prerequisites</div>
<ol class="arabic">
<li>
<p>Ensure that <code>cache-api</code> is on your classpath.</p>
</li>
<li>
<p>Add the following dependency to your <code>pom.xml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-jcache-remote<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">Procedure</div>
<ul>
<li>
<p>Create caches on remote Infinispan servers and use the default JCache API configuration as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Retrieve the system wide cache manager via org.infinispan.jcache.remote.JCachingProvider</span>
CacheManager cacheManager = Caching.getCachingProvider(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.jcache.remote.JCachingProvider</span><span class="delimiter">&quot;</span></span>).getCacheManager();
<span class="comment">// Define a named cache with default JCache configuration</span>
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">remoteNamedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="configuring_remote_caches"><a class="anchor" href="#configuring_remote_caches"></a>15.2.1. Configuring remote caches</h4>
<div class="paragraph">
<p>Hot Rod configuration files include <code>infinispan.client.hotrod.cache.*</code>
properties that you can use to customize remote caches.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pass the URI for your <code>hotrod-client.properties</code> file to the <code>CachingProvider.getCacheManager(URI)</code> call as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

<span class="comment">// Load configuration from an absolute filesystem path</span>
<span class="predefined-type">URI</span> uri = <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">file:///path/to/hotrod-client.properties</span><span class="delimiter">&quot;</span></span>);
<span class="comment">// Load configuration from a classpath resource</span>
<span class="comment">// URI uri = this.getClass().getClassLoader().getResource(&quot;hotrod-client.properties&quot;).toURI();</span>

<span class="comment">// Retrieve the system wide cache manager via org.infinispan.jcache.remote.JCachingProvider</span>
CacheManager cacheManager = Caching.getCachingProvider(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispan.jcache.remote.JCachingProvider</span><span class="delimiter">&quot;</span></span>)
      .getCacheManager(uri, <span class="local-variable">this</span>.getClass().getClassLoader(), <span class="predefined-constant">null</span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="store_and_retrieve_data"><a class="anchor" href="#store_and_retrieve_data"></a>15.3. Store and retrieve data</h3>
<div class="paragraph">
<p>Even though JCache API does not extend neither
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a>
not <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a>,
it providers a key/value API to store and retrieve data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">javax.cache.configuration</span>.*;

CacheManager cacheManager = Caching.getCachingProvider().getCacheManager();
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache = cacheManager.createCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> MutableConfiguration&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;());
cache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Notice that javax.cache.Cache.put(K) returns void!</span>
<span class="predefined-type">String</span> value = cache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Contrary to standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html">java.util.Map</a>,
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a>
comes with two basic put methods called put and getAndPut. The former returns
<code>void</code> whereas the latter returns the previous value associated with the key.
So, the equivalent of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K)</a>
in JCache is <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Even though JCache API only covers standalone caching, it can be plugged
with a persistence store, and has been designed with clustering or
distribution in mind. The reason why javax.cache.Cache offers two put methods
is because standard java.util.Map put call forces implementors to calculate
the previous value. When a persistent store is in use, or the cache is
distributed, returning the previous value could be an expensive operation, and
often users call standard <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K)</a>
without using the return value. Hence, JCache users need to think about
whether the return value is relevant to them, in which case they need to call
<a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java#L230">javax.cache.Cache.getAndPut(K)</a> ,
otherwise they can call <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-">java.util.Map.put(K, V)</a>
which avoids returning the potentially expensive operation of returning the
previous value.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"><a class="anchor" href="#comparing_java_util_concurrent_concurrentmap_and_javax_cache_cache_apis"></a>15.4. Comparing java.util.concurrent.ConcurrentMap and javax.cache.Cache APIs</h3>
<div class="paragraph">
<p>Here&#8217;s a brief comparison of the data manipulation APIs provided by
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a>
and <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a> APIs.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">java.util.concurrent.ConcurrentMap&lt;K, V&gt;</th>
<th class="tableblock halign-left valign-top">javax.cache.Cache&lt;K, V&gt;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">store and no return</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A </p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void put(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">store and return previous value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V put(K key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndPut(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">store if not present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V putIfAbsent(K key, V value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean putIfAbsent(K key, V value)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">retrieve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(Object key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V get(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete if present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete and return previous value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V remove(Object key)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndRemove(K key)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(Object key, Object value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(K key, V oldValue)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replace if present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V value)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replace and return previous value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V replace(K key, V value)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>V getAndReplace(K key, V value)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replace conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean replace(K key, V oldValue, V newValue)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Comparing the two APIs, it&#8217;s obvious to see that, where possible, JCache
avoids returning the previous value to avoid operations doing expensive
network or IO operations. This is an overriding principle in the design of
JCache API. In fact, there&#8217;s a set of operations that are present in
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentMap.html">java.util.concurrent.ConcurrentMap</a> ,
but are not present in the <a href="https://github.com/jsr107/jsr107spec/blob/v1.0.0-RC1/src/main/java/javax/cache/Cache.java">javax.cache.Cache</a>
because they could be expensive to compute in a distributed cache.
The only exception is iterating over the contents of the cache:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operation</th>
<th class="tableblock halign-left valign-top">java.util.concurrent.ConcurrentMap&lt;K, V&gt;</th>
<th class="tableblock halign-left valign-top">javax.cache.Cache&lt;K, V&gt;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">calculate size of cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int size()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return all keys in the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;K&gt; keySet()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return all values in the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;V&gt; values()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">return all entries in the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"> N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iterate over the cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use <code>iterator()</code> method on keySet, values or entrySet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;Cache.Entry&lt;K, V&gt;&gt; iterator()</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="clustering_jcache_instances"><a class="anchor" href="#clustering_jcache_instances"></a>15.5. Clustering JCache instances</h3>
<div class="paragraph">
<p>Infinispan JCache implementation goes beyond the specification in order to
provide the possibility to cluster caches using the standard API. Given a
Infinispan configuration file configured to replicate caches like this:</p>
</div>
<div class="listingblock">
<div class="title">infinispan.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;infinispan&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">default-cache</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;transport</span> <span class="attribute-name">cluster</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jcache-cluster</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
   <span class="tag">&lt;/cache-container&gt;</span>
<span class="tag">&lt;/infinispan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create a cluster of caches using this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">javax.cache</span>.*;
<span class="keyword">import</span> <span class="include">java.net.URI</span>;

<span class="comment">// For multiple cache managers to be constructed with the standard JCache API</span>
<span class="comment">// and live in the same JVM, either their names, or their classloaders, must</span>
<span class="comment">// be different.</span>
<span class="comment">// This example shows how to force their classloaders to be different.</span>
<span class="comment">// An alternative method would have been to duplicate the XML file and give</span>
<span class="comment">// it a different name, but this results in unnecessary file duplication.</span>
<span class="predefined-type">ClassLoader</span> tccl = <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader();
CacheManager cacheManager1 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));
CacheManager cacheManager2 = Caching.getCachingProvider().getCacheManager(
      <span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan-jcache-cluster.xml</span><span class="delimiter">&quot;</span></span>), <span class="keyword">new</span> TestClassLoader(tccl));

Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache1 = cacheManager1.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);
Cache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; cache2 = cacheManager2.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">namedCache</span><span class="delimiter">&quot;</span></span>);

cache1.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> value = cache2.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>); <span class="comment">// Returns &quot;world&quot; if clustering is working</span>

<span class="comment">// --</span>

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestClassLoader</span> <span class="directive">extends</span> <span class="predefined-type">ClassLoader</span> {
  <span class="directive">public</span> TestClassLoader(<span class="predefined-type">ClassLoader</span> parent) {
     <span class="local-variable">super</span>(parent);
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multimap_cache"><a class="anchor" href="#multimap_cache"></a>16. Multimap Cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MutimapCache is a type of Infinispan Cache that maps keys to values in which each key can contain multiple values.</p>
</div>
<div class="sect2">
<h3 id="installation_and_configuration_2"><a class="anchor" href="#installation_and_configuration_2"></a>16.1. Installation and configuration</h3>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>infinispan-multimap<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multimapcache_api"><a class="anchor" href="#multimapcache_api"></a>16.2. MultimapCache API</h3>
<div class="paragraph">
<p>MultimapCache API exposes several methods to interact with the Multimap Cache.
These methods are non-blocking in most cases; see
<a href="#multimap_limitations">limitations</a> for more information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">MultimapCache</span>&lt;K, V&gt; {

   CompletableFuture&lt;Optional&lt;CacheEntry&lt;K, <span class="predefined-type">Collection</span>&lt;V&gt;&gt;&gt;&gt; getEntry(K key);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove(SerializablePredicate&lt;? <span class="local-variable">super</span> V&gt; p);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; put(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Collection</span>&lt;V&gt;&gt; get(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; remove(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Void</span>&gt; remove(<span class="predefined-type">Predicate</span>&lt;? <span class="local-variable">super</span> V&gt; p);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsKey(K key);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsValue(V value);

   CompletableFuture&lt;<span class="predefined-type">Boolean</span>&gt; containsEntry(K key, V value);

   CompletableFuture&lt;<span class="predefined-type">Long</span>&gt; size();

   <span class="type">boolean</span> supportsDuplicates();

}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Void&gt; put(K key, V value)</div>
<p>Puts a key-value pair in the multimap cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MultimapCache&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; multimapCache = ...;

multimapCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">marie</span><span class="delimiter">&quot;</span></span>)
             .thenCompose(r1 -&gt; multimapCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">oihana</span><span class="delimiter">&quot;</span></span>))
             .thenCompose(r3 -&gt; multimapCache.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">girlNames</span><span class="delimiter">&quot;</span></span>))
             .thenAccept(names -&gt; {
                          <span class="keyword">if</span>(names.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">marie</span><span class="delimiter">&quot;</span></span>))
                              <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Marie is a girl name</span><span class="delimiter">&quot;</span></span>);

                           <span class="keyword">if</span>(names.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">oihana</span><span class="delimiter">&quot;</span></span>))
                              <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Oihana is a girl name</span><span class="delimiter">&quot;</span></span>);
                        });</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of this code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">Marie is a girl name
Oihana is a girl name</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Collection&lt;V&gt;&gt; get(K key)</div>
<p>Asynchronous that returns a view collection of the values associated with key in this multimap cache, if any. Any changes to the retrieved collection won&#8217;t change the values in this multimap cache.
When this method returns an empty collection, it means the key was not found.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; remove(K key)</div>
<p>Asynchronous that removes the entry associated with the key from the multimap cache, if such exists.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; remove(K key, V value)</div>
<p>Asynchronous that removes a key-value pair from the multimap cache, if such exists.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Void&gt; remove(Predicate&lt;? super V&gt; p)</div>
<p>Asynchronous method. Removes every value that match the given predicate.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; containsKey(K key)</div>
<p>Asynchronous that returns true if this multimap contains the key.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; containsValue(V value)</div>
<p>Asynchronous that returns true if this multimap contains the value in at least one key.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Boolean&gt; containsEntry(K key, V value)</div>
<p>Asynchronous that returns true if this multimap contains at least one key-value pair with the value.</p>
</div>
<div class="paragraph">
<div class="title">CompletableFuture&lt;Long&gt; size()</div>
<p>Asynchronous that returns the number of key-value pairs in the multimap cache. It doesn&#8217;t return the distinct number of keys.</p>
</div>
<div class="paragraph">
<div class="title">boolean supportsDuplicates()</div>
<p>Asynchronous that returns true if the multimap cache supports duplicates. This means that the content of the multimap can be
'a' &#8594; ['1', '1', '2']. For now this method will always return false, as duplicates are not yet supported.
The existence of a given value is determined by 'equals' and `hashcode' method&#8217;s contract.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating_a_multimap_cache"><a class="anchor" href="#creating_a_multimap_cache"></a>16.3. Creating a Multimap Cache</h3>
<div class="paragraph">
<p>Currently the MultimapCache is configured as a regular cache. This can be done either by code or XML configuration.
See how to configure a regular Cache in the section link to [configure a cache].</p>
</div>
<div class="sect3">
<h4 id="embedded_mode"><a class="anchor" href="#embedded_mode"></a>16.3.1. Embedded mode</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create or obtain your EmbeddedCacheManager</span>
EmbeddedCacheManager cm = ... ;

<span class="comment">// create or obtain a MultimapCacheManager passing the EmbeddedCacheManager</span>
MultimapCacheManager multimapCacheManager = EmbeddedMultimapCacheManagerFactory.from(cm);

<span class="comment">// define the configuration for the multimap cache</span>
multimapCacheManager.defineConfiguration(multimapCacheName, c.build());

<span class="comment">// get the multimap cache</span>
multimapCache = multimapCacheManager.get(multimapCacheName);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multimap_limitations"><a class="anchor" href="#multimap_limitations"></a>16.4. Limitations</h3>
<div class="paragraph">
<p>In almost every case the Multimap Cache will behave as a regular Cache, but some limitations exist in the current version, as follows:</p>
</div>
<div class="sect3">
<h4 id="support_for_duplicates"><a class="anchor" href="#support_for_duplicates"></a>16.4.1. Support for duplicates</h4>
<div class="paragraph">
<p>Duplicates are not supported yet. This means that the multimap won&#8217;t contain any duplicate key-value pair.
Whenever put method is called, if the key-value pair already exist, this key-value par won&#8217;t be added.
Methods used to check if a key-value pair is already present in the Multimap are the <code>equals</code> and <code>hashcode</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="eviction"><a class="anchor" href="#eviction"></a>16.4.2. Eviction</h4>
<div class="paragraph">
<p>For now, the eviction works per key, and not per key-value pair.
This means that whenever a key is evicted, all the values associated with the key will be evicted too.</p>
</div>
</div>
<div class="sect3">
<h4 id="transactions"><a class="anchor" href="#transactions"></a>16.4.3. Transactions</h4>
<div class="paragraph">
<p>Implicit transactions are supported through the auto-commit and all the methods are non blocking.
Explicit transactions work without blocking in most of the cases.
Methods that will block are <code>size</code>, <code>containsEntry</code> and <code>remove(Predicate&lt;? super V&gt; p)</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom_interceptors_chapter"><a class="anchor" href="#custom_interceptors_chapter"></a>17. Custom Interceptors</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Custom interceptors are deprecated in Infinispan and will be removed in a
future version.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Custom interceptors are a way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed.</p>
</div>
<div class="sect2">
<h3 id="adding_custom_interceptors_declaratively"><a class="anchor" href="#adding_custom_interceptors_declaratively"></a>17.1. Adding custom interceptors declaratively</h3>
<div class="paragraph">
<p>Custom interceptors can be added on a per named cache basis. This is because each named cache have its own interceptor stack. Following xml snippet depicts the ways in which a custom interceptor can be added.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cacheWithCustomInterceptors</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="comment">&lt;!--
      Define custom interceptors.  All custom interceptors need to extend org.jboss.cache.interceptors.base.CommandInterceptor
      --&gt;</span>
      <span class="tag">&lt;custom-interceptors&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FIRST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
               <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeOne</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value1<span class="tag">&lt;/property&gt;</span>
               <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">attributeTwo</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>value2<span class="tag">&lt;/property&gt;</span>
         <span class="tag">&lt;/interceptor&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LAST</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">index</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">before</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;interceptor</span> <span class="attribute-name">after</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.infinispanpan.interceptors.CallInterceptor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mycompany.CustomInterceptor1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/custom-interceptors&gt;</span>
<span class="tag">&lt;/local-cache&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding_custom_interceptors_programatically"><a class="anchor" href="#adding_custom_interceptors_programatically"></a>17.2. Adding custom interceptors programatically</h3>
<div class="paragraph">
<p>In order to do that one needs to obtain a reference to the <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a>. This can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CacheManager cm = getCacheManager();<span class="comment">//magic</span>
Cache aCache = cm.getCache(<span class="string"><span class="delimiter">&quot;</span><span class="content">aName</span><span class="delimiter">&quot;</span></span>);
AdvancedCache advCache = aCache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then one of the <em>addInterceptor()</em> methods should be used to add the actual interceptor. For further documentation refer to <a href="https://docs.jboss.org/infinispan/11.0/apidocs/org/infinispan/AdvancedCache.html"><code>AdvancedCache</code></a> javadoc.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom_interceptor_design"><a class="anchor" href="#custom_interceptor_design"></a>17.3. Custom interceptor design</h3>
<div class="paragraph">
<p>When writing a custom interceptor, you need to abide by the following rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Custom interceptors must declare a public, empty constructor to enable construction.</p>
</li>
<li>
<p>Custom interceptors will have setters for any property defined through property tags used in the XML configuration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extending"><a class="anchor" href="#extending"></a>18. Extending Infinispan</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan can be extended to provide the ability for an end user to add
additional configurations, operations and components outside of the scope of the ones normally provided by Infinispan.</p>
</div>
<div class="sect2">
<h3 id="custom_commands"><a class="anchor" href="#custom_commands"></a>18.1. Custom Commands</h3>
<div class="paragraph">
<p>Infinispan makes use of a <a href="http://en.wikipedia.org/wiki/Command_pattern">command/visitor pattern</a> to
implement the various top-level methods you see on the public-facing API.</p>
</div>
<div class="paragraph">
<p>While the core commands - and their corresponding visitors - are hard-coded as
a part of Infinispan&#8217;s core module, module authors can extend and enhance Infinispan
by creating new custom commands.</p>
</div>
<div class="paragraph">
<p>As a module author (such as <a href="https://github.com/infinispan/infinispan/tree/master/query">infinispan-query</a>, etc.) you can define your own commands.</p>
</div>
<div class="paragraph">
<p>You do so by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file and ensure this is packaged in your jar.</p>
</li>
<li>
<p>Implementing <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandFactory.java"><code>ModuleCommandFactory</code></a> and
<a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a></p>
</li>
<li>
<p>Specifying the fully-qualified class name of the  <a href="https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/commands/module/ModuleCommandExtensions.java"><code>ModuleCommandExtensions</code></a>
implementation in <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code>.</p>
</li>
<li>
<p>Implement your custom commands and visitors for these commands</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="an_example"><a class="anchor" href="#an_example"></a>18.1.1. An Example</h4>
<div class="paragraph">
<p>Here is an example of an <code>META-INF/services/org.infinispan.commands.module.ModuleCommandExtensions</code> file, configured accordingly:</p>
</div>
<div class="listingblock">
<div class="title">org.infinispan.commands.module.ModuleCommandExtensions</div>
<div class="content">
<pre>org.infinispan.query.QueryModuleCommandExtensions</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="preassigned_custom_command_id_ranges"><a class="anchor" href="#preassigned_custom_command_id_ranges"></a>18.1.2. Preassigned Custom Command Id Ranges</h4>
<div class="paragraph">
<p>This is the list of <code>Command</code> identifiers that are used by Infinispan based modules or frameworks.
Infinispan users should avoid using ids within these ranges. (RANGES to be finalised yet!)
Being this a single byte, ranges can&#8217;t be too large.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Query:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 - 119</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120 - 139</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod Server:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">140 - 141</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="extending_the_configuration_builders_and_parsers"><a class="anchor" href="#extending_the_configuration_builders_and_parsers"></a>18.2. Extending the configuration builders and parsers</h3>
<div class="paragraph">
<p>If your custom module requires configuration, it is possible to enhance Infinispan&#8217;s configuration builders and
parsers. Look at the <a href="https://github.com/infinispan/infinispan/blob/master/core/src/test/java/org/infinispan/configuration/module">custom module tests</a>
for a detail example on how to implement this.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-11-09 16:43:00 -0500
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-8601422-1', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>